---
phase: 01-foundation-core-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(dashboard)/brands/page.tsx
  - src/app/(dashboard)/brands/new/page.tsx
  - src/app/(dashboard)/brands/[id]/page.tsx
  - src/app/api/brands/route.ts
  - src/app/api/brands/[id]/route.ts
  - src/app/api/brands/logo-upload/route.ts
  - src/components/brand/wizard-shell.tsx
  - src/components/brand/logo-upload-step.tsx
  - src/components/brand/color-picker-step.tsx
  - src/components/brand/font-select-step.tsx
  - src/components/brand/keigo-select-step.tsx
  - src/components/brand/tone-step.tsx
  - src/components/brand/product-info-step.tsx
  - src/components/brand/positioning-step.tsx
  - src/stores/brand-wizard-store.ts
autonomous: true

must_haves:
  truths:
    - "User can create a brand profile through a guided wizard"
    - "Logo upload extracts color palette as editable suggestions"
    - "User can select keigo register from 3 visual cards with example text"
    - "User can select fonts from curated Japanese-safe list only"
    - "Brand profile saves to database with all fields"
    - "User can view and edit existing brand profiles"
  artifacts:
    - path: "src/components/brand/wizard-shell.tsx"
      provides: "Multi-step wizard container with progress indication"
      min_lines: 50
    - path: "src/components/brand/keigo-select-step.tsx"
      provides: "3 visual keigo cards with Japanese example text"
      contains: "カジュアル"
    - path: "src/app/api/brands/route.ts"
      provides: "Brand CRUD API"
      exports: ["GET", "POST"]
    - path: "src/stores/brand-wizard-store.ts"
      provides: "Wizard state management"
      contains: "zustand"
  key_links:
    - from: "src/components/brand/logo-upload-step.tsx"
      to: "src/lib/utils/color-extract.ts"
      via: "Logo color extraction on upload"
      pattern: "extractPaletteFromLogo|extract"
    - from: "src/components/brand/wizard-shell.tsx"
      to: "src/app/api/brands/route.ts"
      via: "POST to save brand profile"
      pattern: "fetch.*api/brands|/api/brands"
    - from: "src/app/api/brands/route.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle insert into brandProfiles"
      pattern: "brandProfiles|db\\.insert"
---

<objective>
Build the brand profile wizard with all 7 steps (logo upload with color extraction, brand colors, font selection, keigo register, tone, product info, positioning) plus brand list and edit pages.

Purpose: Brand profiles are required before users can submit campaign briefs. The brand wizard captures all the information needed for AI-powered copy and image generation: visual identity, tone, keigo register, and product context.
Output: Complete brand management: guided wizard for creation, list view, and edit capability. All data persists to the brandProfiles table.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-core-pipeline/01-CONTEXT.md
@.planning/phases/01-foundation-core-pipeline/01-RESEARCH.md
@.superdesign/design-system.md
@.planning/phases/01-foundation-core-pipeline/01-01-SUMMARY.md
@.planning/phases/01-foundation-core-pipeline/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build brand wizard UI with all 7 steps</name>
  <files>
    src/components/brand/wizard-shell.tsx
    src/components/brand/logo-upload-step.tsx
    src/components/brand/color-picker-step.tsx
    src/components/brand/font-select-step.tsx
    src/components/brand/keigo-select-step.tsx
    src/components/brand/tone-step.tsx
    src/components/brand/product-info-step.tsx
    src/components/brand/positioning-step.tsx
    src/stores/brand-wizard-store.ts
    src/app/(dashboard)/brands/new/page.tsx
  </files>
  <action>
    1. Install needed shadcn components: `pnpm dlx shadcn@latest add card tabs progress label textarea select badge separator`

    2. Create `src/stores/brand-wizard-store.ts` -- Zustand store for wizard state:
       - `currentStep: number` (0-6, 7 steps total)
       - All brand fields: logoFile, logoPreviewUrl, extractedColors, selectedColors, fontPreference, defaultRegister, toneTags, toneDescription, productCatalog, positioningStatement, brandName, brandStory, targetMarket, brandValues
       - Actions: setStep, nextStep, prevStep, setField, resetWizard
       - No persistence (wizard is transient)

    3. Create `src/components/brand/wizard-shell.tsx`:
       - Multi-step wizard container
       - Progress bar at top showing current step / total steps (using Progress component)
       - Step title and description in Japanese
       - Step labels (from ja.json): ロゴアップロード, ブランドカラー, フォント選択, 敬語レベル, トーン設定, 商品情報, ポジショニング
       - "次へ" (next) and "戻る" (back) navigation buttons at bottom
       - On final step: "保存" (save) button that submits to API
       - Renders the active step component
       - Smooth step transitions (200ms fade)
       - 'use client' component

    4. Create `src/components/brand/logo-upload-step.tsx`:
       - react-dropzone for drag-and-drop logo upload
       - Accept: image/png, image/jpeg, image/svg+xml. Max 5MB.
       - Upload preview (show uploaded image)
       - On upload: call `extractPaletteFromLogo` from `@/lib/utils/color-extract.ts`
       - Display extracted color swatches below preview
       - Store extracted colors in wizard store
       - Also include brand name input field (text input, required)
       - Japanese labels: "ロゴをドラッグ＆ドロップ または クリックして選択", "ブランド名"
       - Upload the logo to Supabase Storage via API route, store the URL

    5. Create `src/components/brand/color-picker-step.tsx`:
       - Show extracted colors as editable starting point (pre-filled from logo extraction)
       - 4 color slots: Primary, Secondary, Accent, Background
       - Each slot: color swatch + hex input (editable)
       - Native color picker input for visual selection
       - If no logo was uploaded, show empty slots with default dark colors
       - Japanese labels: "プライマリカラー", "セカンダリカラー", "アクセントカラー", "背景カラー"

    6. Create `src/components/brand/font-select-step.tsx`:
       - Grid of font cards from `@/lib/constants/fonts.ts` (curated list only per user decision)
       - Each card: font name in Japanese, preview text in that font ("あいうえお ABC 123"), category badge (ゴシック/明朝/丸ゴシック)
       - Radio selection (one font per brand)
       - Selected card: vermillion border
       - Japanese label: "ブランドフォントを選択してください"
       - Note: Actual font preview requires loading the font -- use Google Fonts CSS import for preview

    7. Create `src/components/brand/keigo-select-step.tsx`:
       - 3 visual cards (per user decision: makes abstract concept tangible):
         - カジュアル: 親しみやすい、タメ口スタイル / Example: "新商品出たよ！チェックしてみて！"
         - 標準: 丁寧語、です/ます形 / Example: "新商品が登場しました。ぜひご覧ください。"
         - 敬語: 尊敬語・謙譲語、格式高い表現 / Example: "新商品のご案内を申し上げます。何卒ご高覧賜りますようお願い申し上げます。"
       - Data from `@/lib/constants/keigo.ts`
       - Large cards with generous padding, clear visual distinction
       - Selected card: vermillion border + subtle vermillion background
       - Radio selection (one register per brand)

    8. Create `src/components/brand/tone-step.tsx`:
       - Predefined tone tags as clickable badges: 洗練 (refined), 親しみやすい (approachable), 大胆 (bold), 信頼感 (trustworthy), 革新的 (innovative), 伝統的 (traditional), ユーモア (humorous), 高級感 (luxurious), エネルギッシュ (energetic), ミニマル (minimal)
       - Multi-select: clicking a tag toggles it (warm-gold badges when selected)
       - Free text textarea below for tone nuance description
       - Japanese labels: "トーンタグ", "詳細な説明（任意）"

    9. Create `src/components/brand/product-info-step.tsx`:
       - Brand-level (permanent) product info:
         - Brand story textarea: "ブランドストーリー"
         - Key products/services: Dynamic list (add/remove entries)
           Each entry: product name, description, key features (comma-separated), price range, target segment
         - Target market textarea: "ターゲット市場"
         - Brand values: Tag input (add/remove): "ブランドバリュー"
       - This is the 2-layer architecture brand level (campaign level is in the brief form)
       - "商品を追加" button to add product catalog entries
       - "削除" button on each entry

    10. Create `src/components/brand/positioning-step.tsx`:
        - Free text textarea for positioning statement
        - Example templates shown as read-only reference cards below:
          - "【ターゲット】にとって、【ブランド名】は【カテゴリー】の中で最も【差別化ポイント】なブランドです。なぜなら【根拠】だからです。"
          - Another 1-2 template examples
        - Japanese labels: "ポジショニングステートメント", "テンプレート例"
        - This is the final step -- show "保存" (save) button in wizard shell

    11. Create `src/app/(dashboard)/brands/new/page.tsx`:
        - Simple page wrapper that renders the wizard-shell
        - Breadcrumb: ブランド > 新規作成
        - Uses dashboard layout

    CRITICAL: All text Japanese-only. Zero English in any user-facing element.
    CRITICAL: Use keigo example text exactly as specified (real Japanese demonstrating each register).
    CRITICAL: Font selection is curated list only -- no upload option (per user decision).
    CRITICAL: Product info follows 2-layer architecture per user decision.
  </action>
  <verify>
    Run `pnpm build` -- all wizard components compile.
    Verify keigo-select-step.tsx contains all 3 Japanese keigo examples.
    Verify font-select-step.tsx imports from constants/fonts.ts (curated list only).
    Verify wizard-shell.tsx has 7 steps with progress indication.
    Verify tone-step.tsx has at least 8 predefined Japanese tone tags.
  </verify>
  <done>
    Brand wizard renders with 7 steps, all in Japanese. Logo upload extracts colors. Keigo cards show 3 registers with real examples. Font selection uses curated list. Product info supports catalog entries. Positioning has template examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Brand CRUD API routes and list/edit pages</name>
  <files>
    src/app/api/brands/route.ts
    src/app/api/brands/[id]/route.ts
    src/app/api/brands/logo-upload/route.ts
    src/app/(dashboard)/brands/page.tsx
    src/app/(dashboard)/brands/[id]/page.tsx
  </files>
  <action>
    1. Create `src/app/api/brands/logo-upload/route.ts`:
       - POST handler: accepts FormData with logo file
       - Verify auth via Supabase getUser()
       - Upload file to Supabase Storage bucket (create 'brand-logos' bucket)
       - Return public URL of uploaded logo
       - Validate file type (image/png, image/jpeg, image/svg+xml) and size (<5MB)
       - Use the admin client for storage operations

    2. Create `src/app/api/brands/route.ts`:
       - GET: Fetch all brand profiles for the user's team. Join with team_members to verify access. Return array of brand profiles.
       - POST: Create new brand profile. Validate required fields (name, defaultRegister). Insert into brandProfiles table with teamId from user's team. Return created brand.
       - Auth check: getUser() on both endpoints, return 401 if unauthorized.
       - Find user's team by querying teamMembers where userId = user.id.

    3. Create `src/app/api/brands/[id]/route.ts`:
       - GET: Fetch single brand profile by ID. Verify team membership.
       - PUT: Update brand profile. Validate fields. Update brandProfiles record. Return updated brand.
       - DELETE: Delete brand profile. Verify ownership (admin role only).
       - CRITICAL: `const { id } = await props.params` -- Next.js 16 async params.

    4. Create `src/app/(dashboard)/brands/page.tsx`:
       - Brand list page
       - Header: "ブランド一覧" with "新しいブランドを作成" button (links to /brands/new)
       - Grid of brand cards (2-3 columns)
       - Each card: brand name, logo thumbnail, keigo register badge, tone tags as warm-gold pills, color swatches
       - Click card to navigate to /brands/[id] for editing
       - Empty state: "ブランドがありません" with CTA to create first brand
       - Server Component that fetches brands from DB

    5. Create `src/app/(dashboard)/brands/[id]/page.tsx`:
       - Brand edit page
       - Reuse wizard steps BUT pre-filled with existing brand data
       - Or: show a form layout (not wizard) with all fields visible and editable
       - Claude's discretion on edit UX: either re-use wizard or show flat form. Recommendation: flat form for editing (wizard is for creation flow, flat form is faster for edits).
       - "保存" (save) button at bottom
       - "削除" (delete) button with confirmation dialog
       - Breadcrumb: ブランド > [ブランド名]

    IMPORTANT: All API routes must verify auth via getUser() and verify team membership.
    IMPORTANT: Use Drizzle ORM for all database operations (not raw SQL).
    IMPORTANT: In Next.js 16, params are async -- always `await props.params`.
  </action>
  <verify>
    Run `pnpm build` -- all brand pages and API routes compile.
    Verify brands/route.ts exports GET and POST.
    Verify brands/[id]/route.ts uses `await props.params`.
    Verify brands/page.tsx contains "ブランド一覧" heading.
    Verify brands/[id]/page.tsx has delete with confirmation.
  </verify>
  <done>
    Brand CRUD API routes work with auth verification. Brand list page shows cards with logos and metadata. Brand edit page allows updating all fields. Logo upload saves to Supabase Storage. All text Japanese-only.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Brand wizard has 7 steps with correct Japanese labels
3. Logo upload triggers color extraction
4. Keigo cards show 3 registers with real Japanese example text
5. Font selection offers curated list only (no upload)
6. Brand API routes verify auth and team membership
7. Brand list shows cards, brand edit shows editable form
8. All text is Japanese-only
</verification>

<success_criteria>
- User can complete the 7-step brand wizard and save a brand profile
- Logo upload extracts colors as editable suggestions
- Keigo register selection shows 3 visual cards with real Japanese examples
- Font selection is limited to curated Japanese-safe fonts
- Product catalog supports multiple entries
- Brand list displays all brands, clicking opens edit view
- All brand data persists to the brandProfiles database table
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-pipeline/01-03-SUMMARY.md`
</output>
