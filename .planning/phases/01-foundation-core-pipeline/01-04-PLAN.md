---
phase: 01-foundation-core-pipeline
plan: 04
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(dashboard)/campaigns/new/page.tsx
  - src/app/api/campaigns/route.ts
  - src/components/brief/brief-form.tsx
  - src/components/brief/platform-grid.tsx
  - src/components/brief/keigo-override.tsx
  - src/components/brief/creative-direction.tsx
  - src/lib/ai/claude.ts
  - src/lib/ai/flux.ts
  - src/lib/ai/prompts/copy-generation.ts
  - src/lib/ai/prompts/image-generation.ts
  - src/app/api/webhooks/n8n/route.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude API for copy generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"
  - service: bfl
    why: "Flux 1.1 Pro Ultra for image generation"
    env_vars:
      - name: BFL_API_KEY
        source: "BFL API Dashboard -> API Keys"
  - service: n8n
    why: "AI pipeline orchestration"
    env_vars:
      - name: N8N_WEBHOOK_URL
        source: "n8n workflow webhook URL (created when building n8n workflow)"
      - name: N8N_WEBHOOK_SECRET
        source: "Self-generated HMAC secret (create with: openssl rand -hex 32)"

must_haves:
  truths:
    - "User can fill out a structured campaign brief form with all required fields"
    - "User can select target platforms from a visual icon grid of 11 platforms"
    - "User can override keigo register per campaign"
    - "Brief submission triggers AI generation pipeline"
    - "Claude generates structured Japanese copy with 4 A/B variants"
    - "Flux generates base images matching creative direction"
  artifacts:
    - path: "src/components/brief/brief-form.tsx"
      provides: "Structured campaign brief form"
      min_lines: 80
    - path: "src/components/brief/platform-grid.tsx"
      provides: "Visual icon grid for 11 platform selection"
      contains: "instagram"
    - path: "src/lib/ai/claude.ts"
      provides: "Claude API client for structured copy generation"
      contains: "anthropic"
    - path: "src/lib/ai/flux.ts"
      provides: "Flux 1.1 Pro Ultra API client"
      contains: "bfl"
    - path: "src/app/api/campaigns/route.ts"
      provides: "Campaign creation + n8n trigger"
      exports: ["POST"]
    - path: "src/app/api/webhooks/n8n/route.ts"
      provides: "n8n callback handler for generation results"
      exports: ["POST"]
  key_links:
    - from: "src/components/brief/brief-form.tsx"
      to: "src/app/api/campaigns/route.ts"
      via: "POST request on form submit"
      pattern: "fetch.*api/campaigns|/api/campaigns"
    - from: "src/app/api/campaigns/route.ts"
      to: "N8N_WEBHOOK_URL"
      via: "Webhook trigger with HMAC signature"
      pattern: "N8N_WEBHOOK|webhook|hmac"
    - from: "src/app/api/webhooks/n8n/route.ts"
      to: "src/lib/db/schema.ts"
      via: "Updates campaigns + inserts copyVariants + assets"
      pattern: "copyVariants|assets|db\\."
    - from: "src/lib/ai/claude.ts"
      to: "src/lib/ai/prompts/copy-generation.ts"
      via: "Prompt assembly for copy generation"
      pattern: "buildSystemPrompt|buildCopyPrompt|import.*prompts"
---

<objective>
Build the campaign brief submission form and the AI generation pipeline (Claude copy generation + Flux image generation), including the n8n webhook integration for triggering and receiving generation results.

Purpose: This is the core product loop -- brief in, campaign kit out. The brief form captures everything needed for generation, and the AI pipeline produces the copy variants and base images that make the product valuable.
Output: Working brief form that creates campaigns and triggers AI generation. Claude API client for structured Japanese copy. Flux API client for image generation. n8n webhook handler for receiving results.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-core-pipeline/01-CONTEXT.md
@.planning/phases/01-foundation-core-pipeline/01-RESEARCH.md
@.planning/phases/01-foundation-core-pipeline/01-01-SUMMARY.md
@.planning/phases/01-foundation-core-pipeline/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build campaign brief submission form</name>
  <files>
    src/app/(dashboard)/campaigns/new/page.tsx
    src/components/brief/brief-form.tsx
    src/components/brief/platform-grid.tsx
    src/components/brief/keigo-override.tsx
    src/components/brief/creative-direction.tsx
    src/app/api/campaigns/route.ts
  </files>
  <action>
    1. Install needed shadcn components: `pnpm dlx shadcn@latest add checkbox dialog radio-group tooltip`

    2. Create `src/components/brief/platform-grid.tsx`:
       - Visual icon grid showing all 11 supported platforms from `@/lib/constants/platforms.ts`
       - Each platform as a selectable card: platform icon (Lucide icon or custom SVG for LINE/Rakuten/Yahoo), Japanese name, checkbox state
       - 4-column grid (lg), 3-col (md), 2-col (sm)
       - Selected state: vermillion border + subtle vermillion bg
       - Unselected: bg-card with border-subtle
       - Multi-select: user toggles platforms on/off
       - Pass selected platforms array up via onChange callback
       - Icons: Instagram, Twitter(X), MessageCircle(LINE), Globe(Yahoo), ShoppingBag(Rakuten), Music(TikTok), Youtube, MonitorPlay(GDN), Tv(DOOH), Mail(Email), Store(POP)

    3. Create `src/components/brief/keigo-override.tsx`:
       - Pre-filled with brand's default register (passed via props)
       - 3 radio options styled as compact cards (same data as brand wizard keigo cards, but more compact)
       - Shows current default with "ブランドデフォルト" label
       - User can override for this specific campaign
       - Japanese labels only

    4. Create `src/components/brief/creative-direction.tsx`:
       - Mood tags section: predefined visual/tonal keywords as toggleable badges
         Tags: 明るい (bright), ダーク (dark), ミニマル (minimal), カラフル (colorful), レトロ (retro), モダン (modern), ナチュラル (natural), ラグジュアリー (luxury), ポップ (pop), クール (cool), 和風 (Japanese-style), 都会的 (urban)
       - Free text textarea: "クリエイティブディレクション（自由記述）"
       - Optional reference image upload: react-dropzone, single image, max 10MB
         Upload to Supabase Storage, store URL
       - All three inputs update the parent form state

    5. Create `src/components/brief/brief-form.tsx`:
       - Structured form with all fields from CONTEXT.md:
         1. **Brand selection**: Dropdown/select of user's brands (fetched from API). If only 1 brand, auto-select. Required.
         2. **Campaign name**: Text input. Optional (auto-generate from objective if empty).
         3. **Campaign objective**: Select from predefined options: 認知拡大 (awareness), コンバージョン (conversion), エンゲージメント (engagement), ブランディング (branding), プロモーション (promotion), 新商品発売 (new product launch)
         4. **Target audience**: Textarea for demographics, interests, context
         5. **Platform selection**: PlatformGrid component (from above)
         6. **Keigo register override**: KeigoOverride component
         7. **Creative direction**: CreativeDirection component
         8. **Campaign product info**: Textarea for campaign-specific product/service details, seasonal context, special offers (supplements brand-level catalog)
       - Form validation: Brand required, at least 1 platform required, objective required
       - Submit button: "キャンペーンを生成" (vermillion primary, large)
       - On submit: POST to /api/campaigns with all form data
       - After submit: redirect to /campaigns/[id] (campaign results page)
       - Loading state on submit button: "生成中..." with spinner
       - 'use client' component

    6. Create `src/app/(dashboard)/campaigns/new/page.tsx`:
       - Page wrapper for the brief form
       - Breadcrumb: キャンペーン > 新規作成
       - Title: "キャンペーンブリーフ"
       - Renders BriefForm component

    7. Create `src/app/api/campaigns/route.ts`:
       - GET: List campaigns for user's team, ordered by createdAt desc. Include brand profile name for display.
       - POST: Create campaign from brief submission:
         a. Verify auth (getUser)
         b. Find user's team
         c. Validate brief data (brand exists, platforms not empty, objective present)
         d. Insert campaign record with status='pending', brief JSONB
         e. Trigger n8n webhook with HMAC-SHA256 signed payload:
            - Payload: { campaignId, brief, brandProfile (fetched from DB) }
            - Header: X-Signature with HMAC hex digest
            - URL: N8N_WEBHOOK_URL env var
         f. Update campaign status to 'generating'
         g. Return { id: campaign.id } with 201 status

    CRITICAL: Platform grid must show all 11 platforms per CONTEXT.md.
    CRITICAL: Brief form is structured form per user decision (not conversational AI).
    CRITICAL: n8n webhook must be HMAC-signed per RESEARCH.md pitfall 6.
    CRITICAL: Cost estimate field is SKIPPED (deferred to Phase 6 per user decision).
  </action>
  <verify>
    Run `pnpm build` -- brief form and API compile.
    Verify platform-grid.tsx imports from constants/platforms.ts and renders all 11 platforms.
    Verify brief-form.tsx has all 8 form fields listed in CONTEXT.md (minus cost estimate).
    Verify campaigns/route.ts POST includes HMAC signature on n8n webhook call.
    Verify no English text in any brief component.
  </verify>
  <done>
    Brief form renders all fields in Japanese. Platform grid shows 11 platforms with visual selection. Keigo override pre-fills from brand default. Creative direction supports tags + text + reference image. Form submission creates campaign and triggers n8n webhook with HMAC signature.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build AI generation pipeline (Claude + Flux + n8n webhook handler)</name>
  <files>
    src/lib/ai/claude.ts
    src/lib/ai/flux.ts
    src/lib/ai/prompts/copy-generation.ts
    src/lib/ai/prompts/image-generation.ts
    src/app/api/webhooks/n8n/route.ts
  </files>
  <action>
    1. Create `src/lib/ai/prompts/copy-generation.ts`:
       - `buildSystemPrompt(brand: BrandProfile)`: System prompt establishing Claude as a Japanese advertising copywriter. Include:
         - Brand context: name, story, values, target market, product catalog
         - Keigo register instructions with specific verb-ending rules
         - Tri-script mixing guidelines: use kanji for nouns/verbs, hiragana for particles/inflections, katakana for foreign words/emphasis
         - Output format expectations
       - `buildCopyPrompt(brief: CampaignBrief, brand: BrandProfile)`: User prompt with:
         - Campaign objective and target audience
         - Platform-specific constraints (character limits noted)
         - Creative direction and mood
         - Request for exactly 4 A/B variants (A案〜D案)
         - Each variant: headline (見出し), body copy (本文), CTA (アクションボタン), hashtags
       - Include few-shot examples per register level:
         - Casual example: "新商品出たよ！チェックしてみて！"
         - Standard example: "新商品が登場しました。ぜひご覧ください。"
         - Formal example: "新商品のご案内を申し上げます。何卒ご高覧賜りますようお願い申し上げます。"

    2. Create `src/lib/ai/claude.ts`:
       - Install Anthropic SDK if not already: `pnpm add @anthropic-ai/sdk`
       - `generateCopy(brief, brand)` function following RESEARCH.md Pattern 6:
         - Use Anthropic SDK client
         - Model: 'claude-sonnet-4-5-20250514' (pin version, start with Sonnet per research recommendation)
         - Temperature: 0.2 (low for register consistency per pitfall 5)
         - Use tool-based structured output (not raw text):
           Tool 'deliver_copy_variants' with strict schema:
           variants array (minItems: 4, maxItems: 4), each with headline, body, cta, hashtags
         - tool_choice: { type: 'tool', name: 'deliver_copy_variants' }
         - Extract result from tool_use content block
         - Return typed CopyVariant array
       - Export types: CopyVariant, CopyGenerationResult

    3. Create `src/lib/ai/prompts/image-generation.ts`:
       - `buildImagePrompt(brief: CampaignBrief, brand: BrandProfile)`: Construct Flux prompt:
         - Include creative direction mood tags
         - Include brand color palette as color guidance
         - Include campaign objective context
         - Target audience visual cues
         - Style guidance: professional advertising photography/illustration
         - IMPORTANT: Do NOT include Japanese text in the image prompt (text rendering is Phase 2)
         - Return prompt string

    4. Create `src/lib/ai/flux.ts`:
       - Follow RESEARCH.md Flux pattern exactly
       - `generateImage(prompt, options)` function:
         - POST to `https://api.bfl.ml/v1/flux-pro-1.1-ultra`
         - Headers: X-Key with BFL_API_KEY
         - Body: prompt, width (default 1024), height (default 1024), prompt_upsampling=true
         - Poll GET `https://api.bfl.ml/v1/get_result?id={id}` every 2 seconds
         - Max 30 attempts (60s timeout)
         - Return image URL on 'Ready' status
         - Throw on 'Error' or timeout
       - `generateCampaignImages(brief, brand, count = 4)`:
         - Build image prompt
         - Generate `count` images with slight prompt variations (append variation seed instructions)
         - Return array of image URLs
         - Each image at 1024x1024 (base images; platform resizing is Phase 3)

    5. Create `src/app/api/webhooks/n8n/route.ts`:
       - POST handler for n8n callback with generation results
       - HMAC signature verification:
         - Read X-Signature header
         - Compute HMAC-SHA256 of request body with N8N_WEBHOOK_SECRET
         - Compare signatures (timing-safe comparison)
         - Return 401 if mismatch
       - Use admin Supabase client (bypasses RLS since this is a server-to-server callback)
       - Parse payload: { campaignId, copyVariants, imageUrls, status }
       - On success:
         a. Insert copyVariants into copy_variants table (one row per variant per platform)
         b. For each image URL: download image, upload to Supabase Storage ('campaign-assets' bucket), insert into assets table
         c. Update campaign status to 'complete', set completedAt
         d. Update campaign progress JSONB
       - On failure:
         a. Update campaign status to 'failed'
         b. Store error in errorLog JSONB
       - Return 200 acknowledgment

       ALTERNATIVE PATH (for Phase 1 without n8n initially):
       Also create a direct generation path in the campaigns POST route as a fallback:
       If N8N_WEBHOOK_URL is not set, call Claude and Flux directly from the API route
       (sequential: copy first, then images). This allows testing without n8n.
       Store results directly via the same DB insertion logic.

    CRITICAL: Claude model version must be pinned (not 'latest').
    CRITICAL: Temperature 0.2 for keigo consistency.
    CRITICAL: Flux image prompts must NOT include Japanese text (compositing is Phase 2).
    CRITICAL: n8n webhook MUST verify HMAC signature before processing.
    CRITICAL: Include direct generation fallback for development without n8n.
  </action>
  <verify>
    Run `pnpm build` -- all AI modules and webhook handler compile.
    Verify claude.ts uses temperature 0.2 and tool-based structured output.
    Verify flux.ts implements async submit + poll pattern.
    Verify n8n webhook route verifies HMAC signature.
    Verify copy-generation.ts includes keigo register examples in Japanese.
    Verify image-generation.ts does NOT include Japanese text instructions.
  </verify>
  <done>
    Claude API client generates structured copy with 4 variants per call. Flux API client generates images via async submit+poll. Prompt templates include keigo examples and tri-script guidelines. n8n webhook handler receives results and persists to database. Direct generation fallback exists for dev testing.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Brief form has all required fields with Japanese labels
3. Platform grid renders 11 platform cards
4. Campaign POST creates record and triggers webhook
5. Claude client uses structured output with pinned model
6. Flux client implements submit+poll async pattern
7. n8n webhook verifies HMAC before processing
8. Direct generation fallback works without n8n
</verification>

<success_criteria>
- User can fill out the complete brief form and submit
- Brief submission creates a campaign record and triggers generation
- Claude generates 4 copy variants with consistent keigo register
- Flux generates base images matching creative direction
- Generation results are persisted to database (copy_variants + assets tables)
- n8n webhook integration is secure with HMAC verification
- System works with or without n8n (direct fallback for dev)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-pipeline/01-04-SUMMARY.md`
</output>
