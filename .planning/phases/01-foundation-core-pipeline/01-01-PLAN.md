---
phase: 01-foundation-core-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - src/app/globals.css
  - src/app/layout.tsx
  - src/lib/utils/cn.ts
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/lib/db/schema.ts
  - src/lib/db/index.ts
  - src/i18n/request.ts
  - src/messages/ja.json
  - src/lib/constants/platforms.ts
  - src/lib/constants/keigo.ts
  - src/lib/constants/fonts.ts
  - src/types/database.ts
  - src/types/campaign.ts
  - src/types/brand.ts
  - .env.local.example
autonomous: true
user_setup:
  - service: supabase
    why: "Database + Auth + Storage + Realtime"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role secret key"
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Settings -> Database -> Connection string (URI)"
    dashboard_config:
      - task: "Create new Supabase project in Tokyo region (ap-northeast-1)"
        location: "Supabase Dashboard -> New Project"
      - task: "Enable Google OAuth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Google"

must_haves:
  truths:
    - "Next.js 16 project builds and runs with `pnpm dev`"
    - "Tailwind v4 design tokens render correct dark theme colors"
    - "Drizzle schema defines all Phase 1 tables (profiles, teams, team_members, brand_profiles, campaigns, copy_variants, assets)"
    - "Supabase client utilities exist for browser, server, and admin contexts"
    - "Japanese i18n messages load correctly via next-intl"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "next"
    - path: "src/app/globals.css"
      provides: "Tailwind v4 design tokens"
      contains: "@theme"
    - path: "src/app/layout.tsx"
      provides: "Root layout with fonts and dark mode"
      contains: "Noto_Sans_JP"
    - path: "src/lib/db/schema.ts"
      provides: "Drizzle ORM schema for all tables"
      contains: "pgTable"
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client"
      contains: "createServerClient"
    - path: "src/messages/ja.json"
      provides: "Japanese UI translations"
      contains: "ダッシュボード"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/app/globals.css"
      via: "CSS import and font CSS variables"
      pattern: "globals\\.css|--font-noto-sans-jp"
    - from: "src/lib/db/index.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle client imports schema"
      pattern: "import.*schema"
    - from: "src/types/database.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle-inferred types"
      pattern: "InferSelectModel|InferInsertModel|typeof"
---

<objective>
Initialize the complete Next.js 16 project with Tailwind v4 design system, Supabase integration, Drizzle ORM schema, Japanese i18n, and all shared constants/types.

Purpose: This is the foundation every other plan depends on. No UI or features can be built without the project scaffold, database schema, design tokens, and utility functions.
Output: A buildable Next.js 16 project with design system, database schema, Supabase clients, i18n, and shared constants ready for feature development.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-core-pipeline/01-RESEARCH.md
@.planning/phases/01-foundation-core-pipeline/01-CONTEXT.md
@.superdesign/design-system.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js 16 project with Tailwind v4 design system</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    src/app/globals.css
    src/app/layout.tsx
    src/lib/utils/cn.ts
    .env.local.example
  </files>
  <action>
    1. Initialize Next.js 16 project:
       ```
       pnpm create next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
       ```
       If the directory is not empty, initialize in a temp dir and move files, or use `--yes` flag.

    2. Install all Phase 1 dependencies in a single command:
       ```
       pnpm add @supabase/supabase-js @supabase/ssr drizzle-orm postgres zustand @tanstack/react-query next-intl lucide-react react-dropzone next-themes class-variance-authority clsx tailwind-merge extract-colors sharp
       pnpm add -D drizzle-kit @types/node vitest
       ```

    3. Initialize shadcn/ui:
       ```
       pnpm dlx shadcn@latest init
       ```
       When prompted: style=new-york, base-color=neutral, css-variables=yes. This sets up the shadcn component system.

    4. Configure `src/app/globals.css` with Tailwind v4 CSS-first design tokens from the design system. Use `@theme` directive (NOT tailwind.config.js). Include ALL tokens from `.superdesign/design-system.md`:
       - Background colors: bg-page (#0A0A0A), bg-card (#141414), bg-surface (#1A1A1A), bg-hover (#1F1F1F)
       - Border colors: border (#2A2A2A), border-subtle (#1E1E1E)
       - Text colors: text-primary (#FFFFFF), text-secondary (#A0A0A0), text-muted (#666666), text-inverse (#0A0A0A)
       - Accent colors: vermillion (#D73C3C), vermillion-hover (#C13232), warm-gold (#C9956B), steel-blue (#6B8FA3)
       - Semantic colors: success (#4ADE80), warning (#FBBF24), error (#EF4444)
       - Spacing: xs(4px) through 4xl(64px)
       - Border radius: sm(6px), md(12px), lg(16px), xl(24px), pill(999px)
       - Font variables: --font-sans referencing --font-noto-sans-jp, --font-mono referencing --font-jetbrains-mono
       - Dark mode custom variant: `@custom-variant dark (&:where(.dark, .dark *));`

    5. Configure `src/app/layout.tsx`:
       - Load Noto Sans JP (weights 400, 500, 700, 900) via next/font with `preload: false` and `display: 'swap'`
       - Load JetBrains Mono (weights 400, 500) via next/font
       - Set `lang="ja"` and `className="dark"` on html element
       - Apply font CSS variables via className
       - Apply `bg-bg-page text-text-primary font-sans` to body
       - Wrap children with NextIntlClientProvider (from next-intl) and ThemeProvider (from next-themes, forced dark)
       - Include TanStack QueryClientProvider (create query client)

    6. Create `src/lib/utils/cn.ts` with clsx + tailwind-merge utility:
       ```typescript
       import { clsx, type ClassValue } from 'clsx'
       import { twMerge } from 'tailwind-merge'
       export function cn(...inputs: ClassValue[]) {
         return twMerge(clsx(inputs))
       }
       ```

    7. Create `.env.local.example` with all required env vars (with placeholder values):
       - NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
       - DATABASE_URL
       - N8N_WEBHOOK_URL, N8N_WEBHOOK_SECRET
       - BFL_API_KEY (Flux)
       - ANTHROPIC_API_KEY

    8. Delete any `tailwind.config.js` or `tailwind.config.ts` file that the scaffolding creates. Tailwind v4 uses CSS-first config only.

    9. Update `next.config.ts` to include next-intl plugin:
       ```typescript
       import createNextIntlPlugin from 'next-intl/plugin'
       const withNextIntl = createNextIntlPlugin()
       const nextConfig = {}
       export default withNextIntl(nextConfig)
       ```

    IMPORTANT: Do NOT use middleware.ts. Next.js 16 uses proxy.ts (set up in Plan 02).
    IMPORTANT: All design tokens must match `.superdesign/design-system.md` exactly.
    IMPORTANT: Verify that shadcn/ui initialization does NOT create a tailwind.config.js. If it does, delete it and ensure globals.css has the @theme tokens.
  </action>
  <verify>
    Run `pnpm build` -- should compile without errors.
    Run `pnpm dev` -- should start dev server on localhost:3000.
    Verify no tailwind.config.js/ts exists.
    Verify globals.css contains @theme directive with design tokens.
  </verify>
  <done>
    Next.js 16 project builds and serves. Tailwind v4 design tokens are configured CSS-first. Fonts load. Dark mode is forced. All dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Set up Supabase clients and Drizzle ORM schema</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/lib/db/schema.ts
    src/lib/db/index.ts
    drizzle.config.ts
    src/types/database.ts
    src/types/campaign.ts
    src/types/brand.ts
  </files>
  <action>
    1. Create `src/lib/supabase/client.ts` -- Browser Supabase client:
       ```typescript
       import { createBrowserClient } from '@supabase/ssr'
       export function createClient() {
         return createBrowserClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
         )
       }
       ```

    2. Create `src/lib/supabase/server.ts` -- Server-side Supabase client for Server Components and Route Handlers. Use `cookies()` from `next/headers` (MUST await in Next.js 16). Follow @supabase/ssr pattern with getAll/setAll cookie handlers.

    3. Create `src/lib/supabase/admin.ts` -- Service role client for webhook handlers (bypasses RLS):
       ```typescript
       import { createClient } from '@supabase/supabase-js'
       export const adminClient = createClient(
         process.env.NEXT_PUBLIC_SUPABASE_URL!,
         process.env.SUPABASE_SERVICE_ROLE_KEY!
       )
       ```

    4. Create `src/lib/db/schema.ts` with the FULL Drizzle schema from RESEARCH.md:
       - `profiles` table (id UUID PK matching auth.users.id, email, displayName, avatarUrl, timestamps)
       - `teams` table (id UUID PK, name, ownerId FK to profiles, timestamps)
       - `teamMembers` table (id UUID PK, teamId FK, userId FK, role text default 'editor', timestamps)
       - `brandProfiles` table (id UUID PK, teamId FK, name, logoUrl, colors JSONB, fontPreference, defaultRegister, toneTags JSONB, toneDescription, productCatalog JSONB, positioningStatement, brandStory, targetMarket, brandValues JSONB, timestamps)
       - `campaigns` table (id UUID PK, teamId FK, brandProfileId FK, createdBy FK, name, brief JSONB, status text, n8nExecutionId, progress JSONB, errorLog JSONB, thumbnailUrl text, timestamps including completedAt)
       - `copyVariants` table (id UUID PK, campaignId FK, platform, variantLabel, register, headline, bodyText, ctaText, hashtags JSONB, isFavorite boolean, timestamps)
       - `assets` table (id UUID PK, campaignId FK, type, storageKey, fileName, width, height, mimeType, modelUsed, prompt, metadata JSONB, timestamps)

       Define proper TypeScript interfaces for JSONB columns:
       - `ProductCatalogEntry`: { name, description, keyFeatures, priceRange, targetSegment }
       - `CampaignBrief`: { brandProfileId, objective, targetAudience, platforms, registerOverride, creativeMoodTags, creativeDirection, referenceImageUrl, campaignProductInfo }
       - `CampaignProgress`: { stage, copyStatus, imageStatus, percentComplete, currentStep }
       - `BrandColors`: { primary, secondary, accent, background }

    5. Create `src/lib/db/index.ts` -- Drizzle client instance using postgres driver:
       ```typescript
       import { drizzle } from 'drizzle-orm/postgres-js'
       import postgres from 'postgres'
       import * as schema from './schema'
       const client = postgres(process.env.DATABASE_URL!)
       export const db = drizzle(client, { schema })
       ```

    6. Create `drizzle.config.ts` at project root:
       ```typescript
       import { defineConfig } from 'drizzle-kit'
       export default defineConfig({
         schema: './src/lib/db/schema.ts',
         out: './src/lib/db/migrations',
         dialect: 'postgresql',
         dbCredentials: { url: process.env.DATABASE_URL! },
       })
       ```

    7. Create type files:
       - `src/types/database.ts`: Export inferred types from Drizzle schema using `InferSelectModel` and `InferInsertModel` for all tables
       - `src/types/campaign.ts`: Export CampaignBrief, CampaignProgress, CopyVariant interfaces
       - `src/types/brand.ts`: Export BrandProfile, BrandColors, ProductCatalogEntry interfaces

    CRITICAL: Use `getUser()` not `getSession()` in the server client for auth verification.
    CRITICAL: In server.ts, cookies() is async in Next.js 16 -- must await it.
  </action>
  <verify>
    Run `pnpm build` -- TypeScript compilation passes with no type errors.
    Verify schema.ts exports all 7 tables.
    Verify types/database.ts exports Select and Insert types for all tables.
    Run `npx drizzle-kit generate` -- generates migration SQL (requires DATABASE_URL but can verify schema syntax without it).
  </verify>
  <done>
    Drizzle schema defines all 7 Phase 1 tables with proper JSONB types. Supabase clients exist for browser, server, and admin contexts. Type files export all needed interfaces. Migration can be generated.
  </done>
</task>

<task type="auto">
  <name>Task 3: Set up i18n, constants, and shared utilities</name>
  <files>
    src/i18n/request.ts
    src/messages/ja.json
    src/lib/constants/platforms.ts
    src/lib/constants/keigo.ts
    src/lib/constants/fonts.ts
    src/lib/utils/color-extract.ts
  </files>
  <action>
    1. Create `src/i18n/request.ts` -- next-intl config for Japanese-only:
       ```typescript
       import { getRequestConfig } from 'next-intl/server'
       export default getRequestConfig(async () => ({
         locale: 'ja',
         messages: (await import('@/messages/ja.json')).default,
       }))
       ```

    2. Create `src/messages/ja.json` with comprehensive Japanese translations for ALL Phase 1 UI. This is a LARGE file. Include sections:
       - `nav`: ダッシュボード, ブランド, キャンペーン, 設定
       - `dashboard`: 新しいキャンペーンを作成, 最近のキャンペーン, まだキャンペーンがありません, 総キャンペーン数, アクティブブランド, 今月の生成数
       - `brand.wizard`: ブランドプロフィール設定, ロゴアップロード, ブランドカラー, フォント選択, 敬語レベル, トーン設定, 商品情報, ポジショニング, 次へ, 戻る, 保存
       - `brand.list`: ブランド一覧, 新しいブランドを作成, ブランドがありません
       - `keigo`: カジュアル (親しみやすい、タメ口スタイル), 標準 (丁寧語、です/ます形), 敬語 (尊敬語・謙譲語、格式高い表現)
       - `brief`: キャンペーンブリーフ, ブランド選択, キャンペーン目的, ターゲットオーディエンス, プラットフォーム選択, 敬語レベル, クリエイティブディレクション, 商品情報, 送信
       - `campaign`: キャンペーン一覧, コピー, 画像, プレビュー表示, テキスト表示, ダウンロード, 再生成, 生成完了, 生成中, 下書き, エラー
       - `campaign.result`: A案, B案, C案, D案, 見出し, 本文, アクションボタン, ブランド名, ターゲット, プラットフォーム, トーン, 敬語レベル, 生成時間, 使用モデル, バリエーション数, ブリーフを編集して再生成
       - `auth`: ログイン, 新規登録, メールアドレス, パスワード, Googleでログイン, アカウントをお持ちですか？, アカウントを作成
       - `common`: 保存, キャンセル, 削除, 編集, 読み込み中, エラーが発生しました
       - `onboarding`: ようこそ, まずブランドを設定しましょう, 最初のキャンペーンを作成

       CRITICAL: Zero English text in any user-facing value. This is Japanese-only UI.

    3. Create `src/lib/constants/platforms.ts` -- All 11 platform definitions:
       Each platform has: id, nameJa (Japanese name), icon (Lucide icon name), dimensions (array of { label, width, height }), category ('social' | 'ad' | 'other').
       Platforms: instagram, x, line, yahoo_japan, rakuten, tiktok, youtube, gdn, dooh, email, instore_pop.
       Include preview format descriptions matching CONTEXT.md table.

    4. Create `src/lib/constants/keigo.ts` -- Keigo register definitions:
       Three registers: casual, standard, formal. Each has: id, nameJa, descriptionJa, exampleText (real Japanese example showing the register style), verbEndings (regex patterns for validation).

    5. Create `src/lib/constants/fonts.ts` -- Curated Japanese-safe font list:
       Pre-approved fonts: Noto Sans JP, Noto Serif JP, M PLUS Rounded 1c, M PLUS 1p, Sawarabi Gothic, Sawarabi Mincho, Kosugi Maru. Each has: id, nameJa, nameEn, category ('gothic' | 'mincho' | 'rounded'), googleFontsId.
       Per user decision: curated list only, no custom upload.

    6. Create `src/lib/utils/color-extract.ts` -- Logo color palette extraction using extract-colors library:
       Export `extractPaletteFromLogo(imageBuffer: ArrayBuffer)` that returns top 5 colors sorted by area with hex values. Use settings: pixels=10000, distance=0.2, saturationImportance=0.5.
  </action>
  <verify>
    Run `pnpm build` -- no TypeScript errors.
    Verify ja.json is valid JSON (no trailing commas, proper encoding).
    Verify platforms.ts exports all 11 platforms.
    Verify keigo.ts exports 3 registers with Japanese text.
    Verify fonts.ts exports the curated font list.
  </verify>
  <done>
    Japanese i18n configured with comprehensive translations. All 11 platforms defined with dimensions. 3 keigo registers defined with examples. Curated font list ready. Color extraction utility ready.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. `pnpm dev` starts and serves on localhost:3000
3. No tailwind.config.js/ts exists (Tailwind v4 CSS-first only)
4. globals.css contains @theme with all design tokens matching design-system.md
5. schema.ts defines 7 tables with proper types
6. ja.json contains zero English user-facing strings
7. All 3 Supabase client variants exist (browser, server, admin)
</verification>

<success_criteria>
- Project builds and runs on Next.js 16 with React 19
- Dark theme renders with correct colors (#0A0A0A background, #D73C3C vermillion)
- Drizzle schema is complete for all Phase 1 data models
- i18n loads Japanese messages
- All constants (platforms, keigo, fonts) are typed and exported
- Foundation is ready for auth, UI, and feature development in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-pipeline/01-01-SUMMARY.md`
</output>
