---
phase: 06-billing-compliance
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/app/(dashboard)/billing/page.tsx
  - src/app/(dashboard)/billing/billing-content.tsx
  - src/components/dashboard/sidebar.tsx
  - src/components/campaign/compliance-panel.tsx
  - src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
  - src/app/api/campaigns/route.ts
  - src/components/campaign/cost-estimate-dialog.tsx
  - src/messages/ja.json
autonomous: false

must_haves:
  truths:
    - "User can view billing page with current subscription tier, credit balance, and usage history"
    - "User can subscribe to a tier by clicking a plan card and being redirected to Stripe Checkout"
    - "User can manage subscription via Stripe Customer Portal link"
    - "Sidebar navigation includes billing link"
    - "Campaign detail page shows compliance check results with risk level and issue breakdown"
    - "Campaign creation checks credit balance and shows cost estimation before generation"
  artifacts:
    - path: "src/app/(dashboard)/billing/page.tsx"
      provides: "Billing page server component"
      min_lines: 10
    - path: "src/app/(dashboard)/billing/billing-content.tsx"
      provides: "Billing page client component with tier cards and credit display"
      min_lines: 100
    - path: "src/components/campaign/compliance-panel.tsx"
      provides: "Compliance results display for campaign sidebar"
      min_lines: 60
    - path: "src/components/campaign/cost-estimate-dialog.tsx"
      provides: "Cost estimation dialog before campaign generation"
      min_lines: 40
  key_links:
    - from: "src/app/(dashboard)/billing/billing-content.tsx"
      to: "/api/billing/checkout"
      via: "fetch POST to create checkout session"
      pattern: "api/billing/checkout"
    - from: "src/app/(dashboard)/billing/billing-content.tsx"
      to: "/api/billing/credits"
      via: "fetch GET for credit balance and history"
      pattern: "api/billing/credits"
    - from: "src/components/campaign/compliance-panel.tsx"
      to: "/api/campaigns/[id]/compliance"
      via: "fetch POST to trigger and GET to retrieve compliance check"
      pattern: "api/campaigns.*compliance"
    - from: "src/app/api/campaigns/route.ts"
      to: "src/lib/billing/credits.ts"
      via: "deductCredits on campaign creation"
      pattern: "deductCredits"
---

<objective>
Create the billing page UI, compliance results panel, cost estimation dialog, credit gate on campaign creation, and sidebar navigation link. This is the user-facing layer that ties all billing and compliance functionality together.

Purpose: Users can see their subscription, manage credits, check compliance, and understand generation costs before committing.
Output: Billing page, compliance panel, cost estimate dialog, updated campaign creation with credit check, sidebar nav update.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-billing-compliance/06-RESEARCH.md
@.planning/phases/06-billing-compliance/06-01-SUMMARY.md
@.planning/phases/06-billing-compliance/06-02-SUMMARY.md
@.planning/phases/06-billing-compliance/06-03-SUMMARY.md
@src/components/dashboard/sidebar.tsx
@src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
@src/app/api/campaigns/route.ts
@src/messages/ja.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing page with tier cards, credit balance, and usage history</name>
  <files>
    src/app/(dashboard)/billing/page.tsx
    src/app/(dashboard)/billing/billing-content.tsx
    src/components/dashboard/sidebar.tsx
    src/messages/ja.json
  </files>
  <action>
**src/app/(dashboard)/billing/page.tsx** -- Server component (follow existing page.tsx pattern like settings/page.tsx):
- Fetch user via createClient + getUser
- Redirect to /login if no user
- Render BillingContent component

**src/app/(dashboard)/billing/billing-content.tsx** -- "use client" component:
- Fetch subscription data on mount: GET /api/billing/credits for balance and history
- Also need subscription info: Add a GET handler to /api/billing/checkout/route.ts OR fetch subscription from the credits endpoint (extend credits endpoint to also return subscription tier and status -- add these to the GET response in credits/route.ts by querying the subscriptions table)

Layout (Japanese labels, Tailwind styling consistent with existing pages):

1. **Header section:** "課金管理" (Billing Management) with subtitle
2. **Current plan card:** Shows current tier name (Japanese), monthly price with formatJPY, status badge (active/canceled/past_due). If no subscription, show "フリープラン" (Free Plan). Include "プランを管理" button that POST to /api/billing/portal and redirects to the returned URL.
3. **Tier comparison cards (3 cards in a grid):**
   - Import TIERS from @/lib/billing/tiers
   - Each card: tier nameJa, formatJPY(monthlyPriceJpy) + "/月", monthlyCredits + " クレジット/月", feature list, maxBrands, maxTeamMembers
   - "Subscribe" / "Upgrade" / "Downgrade" button on each card depending on current tier
   - Button handler: POST /api/billing/checkout with { priceId } from STRIPE_PRICE_IDS, then window.location.href = response.url (redirect to Stripe Checkout)
   - Current plan card highlighted with border accent
   - Free tier card shows "現在のプラン" badge if no subscription
4. **Credit balance section:** Large number display of current balance, progress bar showing usage relative to tier allocation
5. **Usage history table:** Recent credit transactions from history array. Columns: date (formatted in Japanese locale), description, amount (green for grants, red for deductions), balance after. Show last 20 entries. Empty state if no history.
6. **Success/cancel handling:** Check URL params for `success=true` (show success toast via sonner) or `canceled=true` (show info toast)

**src/components/dashboard/sidebar.tsx** -- Add billing nav item:
- Add `{ key: "billing" as const, href: "/billing", icon: CreditCard }` to navItems array (after campaigns, before settings)
- Import CreditCard from lucide-react

**src/messages/ja.json** -- Add billing translations:
- Add "billing" key under "nav" section: "課金管理"
- Add billing-specific strings as needed
  </action>
  <verify>Run `npx tsc --noEmit` to confirm all files compile. Run `npm run build` to verify the billing page builds correctly. Check sidebar renders billing link.</verify>
  <done>Billing page shows current tier, credit balance, tier comparison cards with subscribe buttons, and usage history table. Sidebar includes billing navigation link with CreditCard icon.</done>
</task>

<task type="auto">
  <name>Task 2: Create compliance panel, cost estimation dialog, and credit gate on campaign creation</name>
  <files>
    src/components/campaign/compliance-panel.tsx
    src/components/campaign/cost-estimate-dialog.tsx
    src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
    src/app/api/campaigns/route.ts
  </files>
  <action>
**src/components/campaign/compliance-panel.tsx** -- "use client" component for campaign sidebar:
- Similar pattern to QAReportPanel component (displayed in campaign detail sidebar)
- Props: `campaignId: string`
- State: complianceReport (null or ComplianceReport), loading, error
- On mount: GET /api/campaigns/{id}/compliance to fetch existing report
- "コンプライアンスチェック" button triggers POST /api/campaigns/{id}/compliance
- Display section:
  - Overall risk badge: "低リスク" (green), "中リスク" (yellow), "高リスク" (red)
  - Keihyouhou issues section (景品表示法): collapsible list of issues with category label, problematic text, issue description, severity badge, suggestion, legal basis
  - Yakki Ho issues section (薬機法): same layout
  - Platform rule issues section: same layout
  - If no issues in a category, show "問題なし" (checkmark)
  - Issue count badge on section headers
- Category labels (Japanese): yuryou_gonin -> "優良誤認", yuuri_gonin -> "有利誤認", stealth_marketing -> "ステマ", medical_claim -> "医薬品的効能", prohibited_expression -> "禁止表現", safety_claim -> "安全性断定", testimonial_efficacy -> "体験談効能"
- Severity badges: "error" -> red "違反の可能性", "warning" -> yellow "要確認"

**src/components/campaign/cost-estimate-dialog.tsx** -- "use client" dialog component:
- Props: `brief: { platforms: string[], includeVideo?: boolean, includeVoiceover?: boolean, includeAvatar?: boolean }, onConfirm: () => void, onCancel: () => void`
- On mount: POST /api/billing/estimate with brief data
- Display:
  - Title: "クレジット消費の見積もり" (Credit Cost Estimation)
  - Breakdown table: copy credits, image credits, video credits (if applicable), voiceover credits, avatar credits -- each with label and amount
  - Total line: bold, "合計: {totalCredits} クレジット"
  - Current balance display with canAfford indicator
  - If !canAfford: red warning "クレジットが不足しています。プランのアップグレードをご検討ください。" with link to /billing
  - Confirm button: "生成を開始" (disabled if !canAfford)
  - Cancel button: "キャンセル"

**src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx** -- Add CompliancePanel to sidebar:
- Import CompliancePanel from @/components/campaign/compliance-panel
- Add CompliancePanel below QAReportPanel in the sidebar section (only show for campaigns with status "complete" or "partial", same condition as QAReportPanel and ApprovalPanel)

**src/app/api/campaigns/route.ts** -- Add credit deduction to POST handler:
- Import { deductCredits } from @/lib/billing/credits
- Import { estimateCampaignCost } from @/lib/billing/estimate
- After validating the brief but BEFORE creating the campaign:
  1. Calculate estimated cost: `const estimate = estimateCampaignCost({ platforms, includeVideo: false, includeVoiceover: false, includeAvatar: false })`
  2. Attempt credit deduction: `const result = await deductCredits(teamId, estimate.totalCredits, null, "Campaign generation")`
  3. If !result.success: return 402 with `{ error: "クレジットが不足しています", required: estimate.totalCredits }`
  4. After campaign is created, update the creditLedger entry with the campaignId (or pass a placeholder and update later)
- Note: For MVP, the credit gate is a check-and-deduct before creation. The deduction happens before the campaign row is inserted. If campaign creation fails after deduction, the credits are lost -- this is acceptable for MVP (can add rollback later).
- Note: Video/voiceover/avatar flags should come from the brief if available, otherwise default to false.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm all files compile. Run `npm run build` to verify no build errors.</verify>
  <done>Compliance panel displays in campaign sidebar with risk levels and issue breakdown. Cost estimation dialog shows credit cost before generation. Campaign creation deducts credits with 402 on insufficient balance.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify billing and compliance UI</name>
  <files>none</files>
  <action>
Human verification of the complete billing and compliance UI. All code has been implemented in Tasks 1 and 2.
  </action>
  <verify>
    1. Navigate to the billing page via sidebar link (should see "課金管理" in navigation)
    2. Verify billing page shows: free plan status, tier comparison cards (Starter/Pro/Business with JPY pricing), credit balance section, usage history (empty initially)
    3. Click a tier subscribe button -- should redirect to Stripe Checkout (will fail without real Stripe keys, but verify the redirect attempt)
    4. On a completed campaign, check the sidebar for the compliance panel ("コンプライアンスチェック" button)
    5. Click the compliance check button -- should trigger analysis and display results with risk level and issue categories
    6. Try creating a new campaign -- should see cost estimation or credit check behavior (402 error if no credits)
  </verify>
  <done>User confirms billing page, compliance panel, and credit gate all function correctly. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no errors
- Billing page accessible at /billing with tier cards and credit display
- Sidebar shows billing link between campaigns and settings
- Compliance panel appears in campaign detail sidebar for completed campaigns
- Campaign creation POST returns 402 when credit balance is insufficient
- Japanese labels used throughout (no English UI strings)
</verification>

<success_criteria>
- User can view subscription tier, credit balance, and usage history on billing page
- User can initiate Stripe Checkout subscription flow from tier cards
- User can manage subscription via Customer Portal link
- Compliance panel shows advertising law check results with severity and legal basis
- Campaign creation checks credit balance before starting generation
- Cost estimation displayed with per-component breakdown
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-compliance/06-04-SUMMARY.md`
</output>
