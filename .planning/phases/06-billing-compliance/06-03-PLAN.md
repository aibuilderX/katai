---
phase: 06-billing-compliance
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/ai/compliance-agent.ts
  - src/lib/ai/prompts/compliance-check.ts
  - src/app/api/campaigns/[id]/compliance/route.ts
autonomous: true

must_haves:
  truths:
    - "Compliance agent checks generated copy against Keihyouhou and Yakki Ho"
    - "Compliance results are returned as structured data with risk levels and specific issues"
    - "Compliance report is persisted to complianceReports table"
    - "API endpoint triggers compliance check for a campaign and returns the report"
  artifacts:
    - path: "src/lib/ai/compliance-agent.ts"
      provides: "Compliance checking agent function"
      exports: ["runComplianceCheck"]
      min_lines: 80
    - path: "src/lib/ai/prompts/compliance-check.ts"
      provides: "System and user prompts for compliance checking"
      exports: ["COMPLIANCE_SYSTEM_PROMPT", "buildComplianceUserPrompt"]
      min_lines: 60
    - path: "src/app/api/campaigns/[id]/compliance/route.ts"
      provides: "Compliance check API endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/lib/ai/compliance-agent.ts"
      to: "src/lib/ai/prompts/compliance-check.ts"
      via: "prompt imports"
      pattern: "COMPLIANCE_SYSTEM_PROMPT|buildComplianceUserPrompt"
    - from: "src/lib/ai/compliance-agent.ts"
      to: "src/lib/db/schema.ts"
      via: "complianceReports table insert"
      pattern: "complianceReports"
    - from: "src/app/api/campaigns/[id]/compliance/route.ts"
      to: "src/lib/ai/compliance-agent.ts"
      via: "runComplianceCheck function call"
      pattern: "runComplianceCheck"
---

<objective>
Create the advertising law compliance agent that checks generated campaign copy against Japanese advertising regulations (Keihyouhou/Yakki Ho) and platform rules, following the exact same pattern as the existing QA agent.

Purpose: Flags potential legal violations before campaign delivery, protecting users from regulatory risk. This is requirement INTEL-05.
Output: Compliance agent module, prompt file, and API endpoint.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-billing-compliance/06-RESEARCH.md
@.planning/phases/06-billing-compliance/06-01-SUMMARY.md
@src/lib/ai/qa-agent.ts
@src/lib/ai/prompts/qa-validation.ts
@src/app/api/campaigns/[id]/qa/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compliance check prompt and agent</name>
  <files>
    src/lib/ai/prompts/compliance-check.ts
    src/lib/ai/compliance-agent.ts
  </files>
  <action>
Mirror the exact architecture of qa-agent.ts and prompts/qa-validation.ts but for advertising law compliance.

**src/lib/ai/prompts/compliance-check.ts:**

Export `COMPLIANCE_SYSTEM_PROMPT` string containing:
- Role: Japanese advertising law compliance verification agent
- Two law categories to check:

1. Keihyouhou (景品表示法) -- Act against Unjustifiable Premiums and Misleading Representations:
   a) Yuryou gonin (優良誤認 -- quality misrepresentation, Article 5 Paragraph 1):
      - Superlative claims without evidence ("No.1", "最高", "最大", "唯一")
      - Performance claims without objective basis
      - Unsubstantiated comparative advertising
   b) Yuuri gonin (有利誤認 -- transaction misrepresentation, Article 5 Paragraph 2):
      - Dual pricing without factual basis ("通常価格○○円→今だけ△△円")
      - Urgency expressions without factual basis ("限定", "今だけ")
      - Unsubstantiated quantity/time limits
   c) Stealth marketing (ステルスマーケティング規制):
      - Advertising not clearly identified as such

2. Yakki Ho (薬機法 -- Pharmaceutical and Medical Device Act):
   - Cosmetics/health food making medical claims
   - Prohibited expressions: "治る", "改善する", "痩せる", "若返る"
   - Definitive safety claims ("安心・安全")
   - Testimonials used as efficacy guarantees

3. Platform-specific rules (already partially handled by QA agent, but checked here for ad content policy violations)

Include instructions (in Japanese):
- AI-generated copy tends toward hyperbolic claims -- check carefully
- Use "error" severity for likely law violations, "warning" for gray areas
- Always include legalBasis for each issue
- Do not flag brand names or product names as superlative claims

Export `buildComplianceUserPrompt(brand, variants, platforms)` function:
- Takes brand profile data (name, product catalog, positioning), copy variants array, and platforms array
- Formats all copy variants as a readable list with variant labels
- Includes brand context so the agent understands what the product actually is
- Includes which platforms are targeted for platform rule checking
- Returns the formatted user prompt string

**src/lib/ai/compliance-agent.ts:**

Follow the exact pattern of qa-agent.ts:

1. Import Anthropic SDK, db, schema tables (campaigns, brandProfiles, copyVariants, complianceReports, ComplianceIssue), drizzle operators
2. Import COMPLIANCE_SYSTEM_PROMPT and buildComplianceUserPrompt from prompts

3. Define `ComplianceReport` interface:
   ```typescript
   export interface ComplianceReport {
     overallRisk: "low" | "medium" | "high"
     keihyouhouIssues: ComplianceIssue[]
     yakkihoIssues: ComplianceIssue[]
     platformRuleIssues: ComplianceIssue[]
   }
   ```

4. Define `COMPLIANCE_TOOL: Anthropic.Tool` with name "deliver_compliance_report":
   - overallRisk: string enum ["low", "medium", "high"]
   - keihyouhouIssues: array of objects with category (enum: "yuryou_gonin", "yuuri_gonin", "stealth_marketing"), field, problematicText, issue, severity (enum: "error", "warning"), suggestion, legalBasis -- all required
   - yakkihoIssues: same object structure (category field uses "medical_claim", "prohibited_expression", "safety_claim", "testimonial_efficacy")
   - platformRuleIssues: objects with platform, field, problematicText, issue, severity, suggestion, legalBasis -- all required

5. Export `runComplianceCheck(campaignId: string): Promise<ComplianceReport>`:
   - Fetch campaign, brand profile, copy variants from DB (same pattern as qa-agent.ts)
   - Build user prompt with buildComplianceUserPrompt
   - Call anthropic.messages.create with:
     - model: "claude-sonnet-4-5-20250514" (same as QA agent)
     - max_tokens: 4096
     - temperature: 0 (deterministic compliance checking)
     - system: COMPLIANCE_SYSTEM_PROMPT
     - tools: [COMPLIANCE_TOOL]
     - tool_choice: { type: "tool", name: "deliver_compliance_report" }
   - Extract tool_use block, cast input as ComplianceReport
   - Insert into complianceReports table: { campaignId, overallRisk, keihyouhouResult: keihyouhouIssues, yakkihoResult: yakkihoIssues, platformRuleResult: platformRuleIssues }
   - Return the ComplianceReport
  </action>
  <verify>Run `npx tsc --noEmit` to confirm both files compile. Verify the tool schema matches the ComplianceIssue interface from schema.ts.</verify>
  <done>Compliance agent mirrors QA agent pattern. System prompt covers Keihyouhou and Yakki Ho. Structured tool output returns typed compliance report. Report persisted to DB.</done>
</task>

<task type="auto">
  <name>Task 2: Create compliance check API endpoint</name>
  <files>src/app/api/campaigns/[id]/compliance/route.ts</files>
  <action>
Create POST endpoint following the exact pattern of src/app/api/campaigns/[id]/qa/route.ts:

1. Import createClient from @/lib/supabase/server, db, schema tables, runComplianceCheck
2. POST handler:
   - Auth check via createClient + getUser
   - Extract campaignId from params (use `await params` pattern for Next.js 16 dynamic route params)
   - Verify campaign exists and belongs to user's team (same team membership check as other campaign API routes)
   - Call `runComplianceCheck(campaignId)`
   - Return the compliance report as JSON with 200
   - Wrap in try/catch: on error, return 500 with `{ error: "コンプライアンスチェックに失敗しました" }`

3. Also add GET handler to retrieve the most recent compliance report for a campaign:
   - Auth check
   - Query complianceReports WHERE campaignId = id, ORDER BY createdAt DESC, LIMIT 1
   - If no report found, return `{ report: null }`
   - Return `{ report: { overallRisk, keihyouhouResult, yakkihoResult, platformRuleResult, acknowledgedAt, createdAt } }`

Mirror the error handling and response format of the QA endpoint.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm the route compiles. Verify both POST (trigger check) and GET (retrieve report) handlers exist.</verify>
  <done>Compliance API endpoint at /api/campaigns/[id]/compliance supports POST (trigger check) and GET (retrieve latest report). Auth and team ownership verified.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Compliance agent follows same Claude tool_use pattern as QA agent
- System prompt contains both Keihyouhou and Yakki Ho sections in Japanese
- Compliance report stored in complianceReports table
- API endpoint requires authentication and team ownership verification
</verification>

<success_criteria>
- Compliance agent can analyze campaign copy for advertising law violations
- Structured output separates Keihyouhou, Yakki Ho, and platform rule issues
- Each issue includes severity, suggestion, and legal basis
- Report persisted to database for later retrieval
- API matches existing QA endpoint pattern for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-compliance/06-03-SUMMARY.md`
</output>
