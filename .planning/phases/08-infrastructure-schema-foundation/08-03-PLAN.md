---
phase: 08-infrastructure-schema-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "08-01"
  - "08-02"
files_modified:
  - src/app/api/campaigns/route.ts
autonomous: false
requirements:
  - FIXV-01
  - FIXV-02
  - FIXV-03
  - FIXV-04

must_haves:
  truths:
    - "Vercel production deployment serves dashboard, auth, and billing pages without errors"
    - "Campaign ZIP download completes successfully on production"
    - "All existing AI provider integrations respond to live API test calls"
    - "runDirectGeneration logs a deprecation warning when it activates"
  artifacts:
    - path: "src/app/api/campaigns/route.ts"
      provides: "Deprecation warning on runDirectGeneration entry"
      contains: "[DEPRECATED] runDirectGeneration"
  key_links:
    - from: "src/app/api/campaigns/route.ts"
      to: "console.warn"
      via: "Deprecation log at function entry"
      pattern: "\\[DEPRECATED\\] runDirectGeneration"
---

<objective>
Verify the v1.0 production deployment on Vercel (dashboard, auth, billing, ZIP download), test all existing AI provider integrations with live API calls, and mark runDirectGeneration as deprecated with a log warning.

Purpose: Before building the 7-agent pipeline on top of v1.0, we must confirm the existing deployment actually works end-to-end. Broken fundamentals would compound through Phases 9-12.

Output: Verified production deployment, tested AI providers, deprecated direct generation fallback.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-infrastructure-schema-foundation/08-RESEARCH.md
@.planning/phases/08-infrastructure-schema-foundation/08-CONTEXT.md
@src/app/api/campaigns/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mark runDirectGeneration as deprecated and verify AI provider modules</name>
  <files>src/app/api/campaigns/route.ts</files>
  <action>
**1. Add deprecation warning to runDirectGeneration.**

At the very start of the `runDirectGeneration` function body (line ~323 in src/app/api/campaigns/route.ts), before the try block, add:

```typescript
async function runDirectGeneration(
  campaignId: string,
  brief: { /* existing params */ },
  brandProfile: typeof brandProfiles.$inferSelect
) {
  console.warn(
    "[DEPRECATED] runDirectGeneration activated. " +
    "This fallback is deprecated in v1.1 and will be removed in v1.2. " +
    "Configure N8N_WEBHOOK_URL to use the n8n pipeline instead. " +
    `Campaign: ${campaignId}`
  )

  try {
    // ... existing logic unchanged
```

Do NOT remove any existing logic from runDirectGeneration. It remains functional as a safety net. Only add the warning.

Per user decision: mark deprecated, do not remove. The function still works when N8N_WEBHOOK_URL is not set.

**2. Verify AI provider modules can be imported and have valid configuration.**

Run TypeScript compilation to verify all AI provider modules compile:
```bash
npx tsc --noEmit
```

Check that each provider module exists and exports its primary function:
- `src/lib/ai/flux.ts` -- exports `generateCampaignImages`
- `src/lib/ai/kling.ts` -- exports generation function
- `src/lib/ai/runway.ts` -- exports generation function
- `src/lib/ai/elevenlabs.ts` -- exports TTS function
- `src/lib/ai/heygen.ts` -- exports avatar generation function
- `src/lib/ai/claude.ts` -- exports `generatePlatformCopy`

Verify each module compiles and its exports are reachable. Do NOT make live API calls from this task -- that requires the user's production environment.

**3. Verify build succeeds:**
```bash
npm run build
```

The build must succeed with the deprecation warning added and all prior schema/type changes from 08-02.
  </action>
  <verify>
- `grep -n "DEPRECATED.*runDirectGeneration" src/app/api/campaigns/route.ts` finds the deprecation warning
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- All AI provider modules exist: flux.ts, kling.ts, runway.ts, elevenlabs.ts, heygen.ts, claude.ts
  </verify>
  <done>runDirectGeneration logs "[DEPRECATED]" warning when activated, all provider modules compile, build succeeds</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify production deployment and AI provider live calls</name>
  <files>src/app/api/campaigns/route.ts</files>
  <action>
Human verification of the v1.0 production deployment on Vercel and AI provider configuration. Claude completed code changes (deprecation warning, schema additions, webhook expansion). The user must now verify the live deployment.
  </action>
  <verify>
**A. Vercel Production Verification (FIXV-01):**
1. Visit https://katai-w65t.vercel.app (or your production URL)
2. Verify the dashboard loads without errors
3. Navigate to the auth pages -- verify login/signup work
4. Navigate to the billing page -- verify subscription tiers display
5. Check browser console for any JavaScript errors

**B. Campaign ZIP Download (FIXV-02):**
1. Open an existing completed campaign in the dashboard
2. Click the download/ZIP button
3. Verify the ZIP downloads and contains organized assets by platform

**C. AI Provider Live Calls (FIXV-03):**
Verify each provider has valid API keys configured on Vercel:
1. Anthropic (Claude): Check ANTHROPIC_API_KEY is set in Vercel env vars
2. Flux (fal.ai): Check BFL_API_KEY and FAL_KEY are set
3. Kling: Check relevant API key is set
4. Runway: Check RUNWAYML_API_SECRET is set
5. ElevenLabs: Check ELEVENLABS_API_KEY is set
6. HeyGen: Check HEYGEN_API_KEY is set

If keys are missing, note which ones need to be added. The pending TODO "configure Runway, ElevenLabs, fal.ai, HeyGen API keys" from STATE.md may apply.

Optionally, trigger a test campaign generation to verify the full pipeline works end-to-end.

**D. Deprecation Warning (FIXV-04):**
If N8N_WEBHOOK_URL is NOT set on Vercel, triggering a campaign should use the direct generation fallback. Check Vercel function logs for the "[DEPRECATED] runDirectGeneration" warning message.

**E. Database Schema (from 08-02):**
1. Open Supabase dashboard
2. Verify brand_memory table exists with correct columns
3. Verify campaign_costs table exists with correct columns
4. Both tables should be empty (populated in later phases)
  </verify>
  <done>User confirms: dashboard/auth/billing load on Vercel, ZIP download works, AI provider keys configured (or missing ones documented), deprecation warning fires, brand_memory and campaign_costs tables exist in Supabase</done>
</task>

</tasks>

<verification>
- Dashboard loads on production Vercel URL without errors (FIXV-01)
- Auth flow (login/signup) works on production (FIXV-01)
- Billing page displays subscription tiers (FIXV-01)
- Campaign ZIP download completes and contains organized assets (FIXV-02)
- All 6 AI provider API keys are configured (or documented as missing) (FIXV-03)
- runDirectGeneration logs deprecation warning in Vercel function logs (FIXV-04)
- brand_memory and campaign_costs tables exist in Supabase (from 08-02)
</verification>

<success_criteria>
The v1.0 production deployment is verified working (dashboard, auth, billing, ZIP download), AI provider integrations are confirmed configured, and runDirectGeneration is marked deprecated with a log warning. Any missing API keys are documented as pending TODOs.
</success_criteria>

<output>
After completion, create `.planning/phases/08-infrastructure-schema-foundation/08-03-SUMMARY.md`
</output>
