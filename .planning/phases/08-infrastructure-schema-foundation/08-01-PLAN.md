---
phase: 08-infrastructure-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .env.local.example
autonomous: false
requirements:
  - ORCH-01
  - ORCH-14

must_haves:
  truths:
    - "n8n instance is running version 2.9.0 with AI Agent nodes available"
    - "Existing n8n workflows are published and responding to webhook calls"
    - "Per-agent model assignment environment variables are documented and configurable"
    - "n8n execution timeout is set to 15 minutes for long-running agent pipelines"
  artifacts:
    - path: ".env.local.example"
      provides: "Agent model env vars and cost alert threshold documented"
      contains: "AGENT_STRATEGIC_INSIGHT_MODEL"
  key_links:
    - from: ".env.local.example"
      to: "src/app/api/campaigns/route.ts"
      via: "process.env.AGENT_*_MODEL reads"
      pattern: "AGENT_.*_MODEL"
---

<objective>
Upgrade the self-hosted n8n instance from 1.x to 2.9.0, validate AI Agent node availability, publish existing workflows under the new Draft/Publish model, and document all new environment variables for the v1.1 agent pipeline.

Purpose: n8n 2.x is the runtime for the 7-agent pipeline built in Phase 9. Without this upgrade, AI Agent nodes are not available and the pipeline cannot be constructed.

Output: Running n8n 2.9.0 instance with published workflows, documented env vars for agent model assignment.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-infrastructure-schema-foundation/08-RESEARCH.md
@.planning/phases/08-infrastructure-schema-foundation/08-CONTEXT.md
@.env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade n8n to 2.9.0 and publish existing workflows</name>
  <files>.env.local.example</files>
  <action>
This task involves SSH access to the n8n VPS. Claude will guide the upgrade process and execute commands remotely.

**Step 1: Pre-upgrade backup**
- SSH into the n8n VPS
- Run `docker exec n8n n8n export:workflow --all --output=/tmp/n8n-backup/` to export all workflow JSONs
- Record current n8n version: `docker exec n8n n8n --version`
- Copy backup to local machine or safe location

**Step 2: Upgrade n8n Docker image**
- Find and update the docker-compose.yml (or docker run command) on the VPS
- Change image tag to `n8nio/n8n:2.9.0`
- Add/update these environment variables in the n8n Docker configuration:
  ```
  EXECUTIONS_TIMEOUT=900
  N8N_CONCURRENCY_PRODUCTION_LIMIT=3
  ```
- Pull new image and restart: `docker compose pull && docker compose down && docker compose up -d`
- Wait for startup, verify with: `docker exec n8n n8n --version` (should show 2.9.0)
- Check logs for errors: `docker logs n8n --tail 100`

**Step 3: Post-upgrade validation**
- Access n8n UI and verify all existing workflows loaded correctly
- Check for "Start node not found" warnings -- if any, replace Start nodes with appropriate trigger nodes
- Check if any Code nodes access `process.env` -- n8n 2.x blocks this by default. If found, migrate to n8n credentials or use the `$env` variable
- Publish all existing workflows (they will be in draft state after upgrade): use n8n UI or API `PATCH /api/v1/workflows/{id}` with `{ "active": true }`

**Step 4: Validate AI Agent node availability**
- In n8n UI, create a test workflow with an AI Agent node
- Verify the Anthropic Chat Model sub-node is available in the node palette
- Configure a test AI Agent node with Claude (no need to run it yet -- just confirm the node type exists and is configurable)
- Delete the test workflow after confirming

**Step 5: Test webhook endpoint**
- Send a test curl to the existing n8n webhook URL to verify it responds after upgrade
- `curl -X POST https://your-n8n.example.com/webhook-test/campaign -H "Content-Type: application/json" -d '{"test": true}'`
- Confirm 200 response (or appropriate webhook test response)

**Step 6: Update .env.local.example**
Add the following new environment variables to the `.env.local.example` file, in a new "v1.1 Agent Pipeline" section after the existing n8n section:

```
# --- v1.1 Agent Pipeline ---
# Per-agent model assignment (all default to claude-opus-4-6 if not set)
AGENT_STRATEGIC_INSIGHT_MODEL=claude-opus-4-6
AGENT_CREATIVE_DIRECTOR_MODEL=claude-opus-4-6
AGENT_COPYWRITER_MODEL=claude-opus-4-6
AGENT_ART_DIRECTOR_MODEL=claude-opus-4-6
AGENT_JP_LOCALIZATION_MODEL=claude-opus-4-6

# Cost alert threshold (yen) -- logs warning when campaign exceeds this
CAMPAIGN_COST_ALERT_THRESHOLD_YEN=5000
```

Per user decision: all agents default to Opus initially. Optimization to Sonnet is deferred to after testing with real cost data.

NOTE: If SSH access to the VPS is not available from this environment, create a checkpoint for the user to execute the Docker commands manually. The .env.local.example update can still be done directly.
  </action>
  <verify>
- `docker exec n8n n8n --version` returns 2.9.0
- n8n UI loads without errors
- Existing workflows are published and active
- AI Agent node appears in node palette
- Webhook test endpoint responds to curl
- `.env.local.example` contains AGENT_*_MODEL variables and CAMPAIGN_COST_ALERT_THRESHOLD_YEN
  </verify>
  <done>n8n 2.9.0 is running with AI Agent nodes available, all existing workflows are published, webhook endpoint responds, and new env vars are documented in .env.local.example</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify n8n upgrade and AI Agent node availability</name>
  <files>.env.local.example</files>
  <action>
Human verification of the n8n upgrade. Claude automated the Docker upgrade, workflow publishing, and .env.local.example update. The user must now confirm the n8n instance is running correctly in their browser.
  </action>
  <verify>
1. Open the n8n UI in your browser
2. Verify the version shows 2.9.0 (check Settings or footer)
3. Confirm existing workflows are active (not in draft state)
4. Create a new workflow, search for "AI Agent" in the node palette -- confirm it appears
5. In the AI Agent node, verify "Anthropic Chat Model" is available as a sub-node option
6. Test the webhook: run `curl -X POST [your-webhook-url] -H "Content-Type: application/json" -d '{"test": true}'`
7. Review `.env.local.example` for the new v1.1 Agent Pipeline section
  </verify>
  <done>User confirms n8n 2.9.0 is running, AI Agent nodes are available, workflows are published, webhook responds</done>
</task>

</tasks>

<verification>
- n8n version is 2.9.0
- AI Agent node type exists in node palette
- Anthropic Chat Model sub-node is configurable
- All pre-existing workflows are published (not draft)
- Webhook endpoint responds to test calls
- .env.local.example has AGENT_*_MODEL and CAMPAIGN_COST_ALERT_THRESHOLD_YEN entries
</verification>

<success_criteria>
n8n 2.9.0 is running on the VPS with AI Agent nodes available, existing workflows are migrated and published, and the v1.1 environment variable documentation is updated.
</success_criteria>

<output>
After completion, create `.planning/phases/08-infrastructure-schema-foundation/08-01-SUMMARY.md`
</output>
