---
phase: 04-video-audio-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/campaign/generation-progress.tsx
  - src/components/campaign/video-tab.tsx
  - src/components/campaign/video-player.tsx
  - src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows progressive generation status with voiceover, video, and avatar stages"
    - "Video assets are viewable in a dedicated video tab with inline playback"
    - "Audio voiceover is playable in the video tab with a built-in audio player"
    - "Campaign detail page includes a Video tab alongside existing Copy, Image, and Platform tabs"
    - "Progress UI shows 'skipped' state for video stages when campaign has no video platforms"
  artifacts:
    - path: "src/components/campaign/generation-progress.tsx"
      provides: "Extended progress UI with voiceover, video, and avatar step indicators"
      contains: "voiceoverStatus"
    - path: "src/components/campaign/video-tab.tsx"
      provides: "Video gallery tab with video cards and audio player"
      exports: ["VideoTab"]
    - path: "src/components/campaign/video-player.tsx"
      provides: "Inline video player component with aspect ratio preservation"
      exports: ["VideoPlayer"]
    - path: "src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx"
      provides: "Campaign detail with Video tab added"
      contains: "VideoTab"
  key_links:
    - from: "src/components/campaign/generation-progress.tsx"
      to: "src/hooks/use-campaign-progress.ts"
      via: "useCampaignProgress hook"
      pattern: "useCampaignProgress"
    - from: "src/components/campaign/video-tab.tsx"
      to: "src/lib/db/schema.ts"
      via: "assets query for video/audio type"
      pattern: "type.*video.*audio"
    - from: "src/components/campaign/video-player.tsx"
      to: "Supabase Storage"
      via: "video URL from storageKey"
      pattern: "storageKey"
---

<objective>
Build the progressive generation UI for video/audio stages and the video gallery tab for viewing generated videos and voiceover.

Purpose: Users need to see real-time progress as video/audio assets generate (which takes 1-5+ minutes), and then view/play the resulting videos and voiceover in the campaign detail page. This completes the WORK-03 requirement (progressive generation status) and provides the viewing experience for VID-01 through VID-04 outputs.

Output: Extended generation progress component, video player component, video gallery tab, updated campaign detail page
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-video-audio-pipeline/04-RESEARCH.md
@.planning/phases/04-video-audio-pipeline/04-01-SUMMARY.md
@.planning/phases/04-video-audio-pipeline/04-02-SUMMARY.md
@src/components/campaign/generation-progress.tsx
@src/components/campaign/image-tab.tsx
@src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
@src/hooks/use-campaign-progress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend generation progress UI for video/audio stages</name>
  <files>
    src/components/campaign/generation-progress.tsx
  </files>
  <action>
    Extend the existing `GenerationProgress` component to display voiceover, video, and avatar generation stages alongside the existing copy and image stages.

    **1. Add step indicators for new stages:**

    After the existing copy and image step indicators in the "Step indicators" section, add three more:

    - Voiceover step: icon + label derived from `progress?.voiceoverStatus`
      - pending: "ナレーション生成待ち"
      - generating: "ナレーション生成中..."
      - complete: "ナレーション生成完了"
      - failed: "ナレーション生成失敗"
      - skipped: "ナレーション（スキップ）"
    - Video step: icon + label derived from `progress?.videoStatus`
      - pending: "動画生成待ち"
      - generating: "動画生成中..."
      - complete: "動画生成完了"
      - failed: "動画生成失敗"
      - skipped: "動画（スキップ）"
    - Avatar step: icon + label derived from `progress?.avatarStatus`
      - pending: "アバター動画待ち"
      - generating: "アバター動画生成中..."
      - complete: "アバター動画完了"
      - failed: "アバター動画失敗"
      - skipped: "アバター（スキップ）"

    **2. Handle "skipped" status in the icon helper:**

    Update `getStepIcon` to handle "skipped" status:
    ```typescript
    case "skipped":
      return <MinusCircle className="size-5 text-text-muted" />
    ```
    Import `MinusCircle` from lucide-react.

    **3. Update `getStepLabel` function:**

    Refactor `getStepLabel` to handle all step types (not just "copy" and "image"):
    ```typescript
    type StepType = "copy" | "image" | "voiceover" | "video" | "avatar"
    ```
    Add labels for each new type as specified above. Handle "skipped" status with muted styling (text-text-muted).

    **4. Conditional rendering:**

    Only show the voiceover/video/avatar steps if they exist in the progress object (not undefined). This handles backward compatibility with campaigns generated before Phase 4 that don't have these fields.

    ```typescript
    const voiceoverStatus = progress?.voiceoverStatus
    const videoStatus = progress?.videoStatus
    const avatarStatus = progress?.avatarStatus

    // In the step indicators section:
    {voiceoverStatus && (
      <div className="flex items-center gap-3">
        {getStepIcon(voiceoverStatus)}
        <span className={...}>{getStepLabel("voiceover", voiceoverStatus)}</span>
      </div>
    )}
    // Similarly for videoStatus and avatarStatus
    ```

    **5. Add a separator between image and video stages:**

    Between the image step and the voiceover step, add a subtle visual separator:
    ```tsx
    {(voiceoverStatus || videoStatus || avatarStatus) && (
      <div className="my-2 border-t border-border-subtle" />
    )}
    ```
    This visually groups "static assets" (copy, images) and "video/audio assets" (voiceover, video, avatar).
  </action>
  <verify>
    `pnpm build` passes. The generation-progress.tsx file contains step indicators for voiceoverStatus, videoStatus, and avatarStatus. MinusCircle is imported from lucide-react.
  </verify>
  <done>
    Generation progress UI shows 5 pipeline stages: copy, image, voiceover, video, avatar. Stages conditionally shown only when present. "Skipped" state displays with muted styling. Visual separator between static and video stages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create video player, video gallery tab, and integrate into campaign detail</name>
  <files>
    src/components/campaign/video-player.tsx
    src/components/campaign/video-tab.tsx
    src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
  </files>
  <action>
    **1. Create `src/components/campaign/video-player.tsx`:**

    A reusable inline video player component:
    ```typescript
    "use client"

    interface VideoPlayerProps {
      src: string
      aspectRatio?: string  // e.g., "16:9", "9:16", "1:1"
      poster?: string       // thumbnail image URL
      className?: string
    }
    ```

    - Render a `<video>` element with `controls`, `playsInline`, `preload="metadata"`
    - Apply aspect ratio via CSS: map "16:9" to `aspect-video`, "9:16" to `aspect-[9/16]`, "1:1" to `aspect-square`
    - Set `max-h-[400px]` to prevent oversized vertical videos from dominating the page
    - Use `rounded-lg overflow-hidden` for styling consistency with image cards
    - Show poster image as the video thumbnail when not playing
    - Handle loading state with a skeleton placeholder

    **2. Create `src/components/campaign/video-tab.tsx`:**

    A gallery tab similar to `image-tab.tsx` that displays video and audio assets:

    ```typescript
    "use client"

    interface VideoTabProps {
      videos: Array<{
        id: string
        storageKey: string
        fileName: string | null
        mimeType: string | null
        modelUsed: string | null
        metadata: Record<string, unknown> | null
      }>
      audioAssets: Array<{
        id: string
        storageKey: string
        fileName: string | null
        mimeType: string | null
        modelUsed: string | null
        metadata: Record<string, unknown> | null
      }>
    }
    ```

    Layout:
    - **Audio section** (if audioAssets.length > 0):
      - Heading: "ナレーション" (Narration)
      - For each audio asset: render an `<audio>` element with `controls` and the storage URL
      - Show metadata: provider, estimated duration, voice ID
      - Download button (anchor with `download` attribute)

    - **Video section** (if videos.length > 0):
      - Heading: "動画" (Videos)
      - Grid of video cards (responsive: 1 col mobile, 2 cols tablet, 3 cols desktop)
      - Each card contains:
        - `<VideoPlayer>` component with the video URL and aspect ratio from metadata
        - Badge showing provider name (Kling / Runway / HeyGen) using `<Badge>` from shadcn
        - Badge showing video type (広告 for ad, シネマ for cinematic, アバター for avatar)
        - Badge showing aspect ratio
        - Duration label (e.g., "10秒")
        - Download button (anchor with `download` attribute pointing to the storage URL)

    - **Empty state** (if no videos and no audio):
      - Show centered message: "動画・音声アセットはありません" with Film icon from lucide-react
      - Subtext: "動画対応のプラットフォームを選択すると、動画アセットが生成されます"

    Styling: Follow the existing `image-tab.tsx` patterns for consistency (same card styling, badge colors, grid layout).

    **3. Update `src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx`:**

    Add a new "動画" (Video) tab to the existing tabs component:

    a. Import `VideoTab` from `@/components/campaign/video-tab`
    b. Filter assets by type to create `videoAssets` and `audioAssets` arrays:
       ```typescript
       const videoAssets = assets.filter(a => a.type === "video")
       const audioAssets = assets.filter(a => a.type === "audio")
       ```
    c. Add a new tab trigger after the existing tabs:
       ```tsx
       <TabsTrigger value="videos" className="...">
         <Film className="size-4" />
         動画
         {videoAssets.length > 0 && (
           <span className="ml-1 text-xs text-text-muted">({videoAssets.length})</span>
         )}
       </TabsTrigger>
       ```
    d. Add the tab content:
       ```tsx
       <TabsContent value="videos">
         <VideoTab videos={videoAssets} audioAssets={audioAssets} />
       </TabsContent>
       ```
    e. Import `Film` from lucide-react
    f. Only show the video tab if the campaign status is "complete" or "partial" (same logic as platform tab)
  </action>
  <verify>
    `pnpm build` passes. `VideoPlayer` and `VideoTab` components exist and are imported in `campaign-detail-content.tsx`. The tabs section includes a "動画" trigger. Grep for "VideoTab" in campaign-detail-content.tsx confirms integration.
  </verify>
  <done>
    Video player component renders inline video with aspect ratio preservation. Video gallery tab displays video cards with provider/type/ratio badges and download buttons. Audio section includes playable voiceover with HTML5 audio element. Campaign detail page has a "動画" tab showing all video and audio assets with proper empty state.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with no type errors
2. Generation progress shows 5 stages: copy, image, voiceover, video, avatar
3. "Skipped" state renders correctly with MinusCircle icon and muted text
4. Backward compatibility: campaigns without video fields still render correctly
5. Video tab appears in campaign detail page
6. Video player renders with correct aspect ratio constraints
7. Audio player renders with controls for voiceover playback
8. Empty state shows when no video/audio assets exist
</verification>

<success_criteria>
- Progressive generation UI shows all pipeline stages in real-time (WORK-03 complete)
- Videos are viewable inline with provider/type metadata badges
- Voiceover is playable with HTML5 audio controls
- Video tab integrates seamlessly with existing campaign detail page tabs
- Backward compatible with pre-Phase 4 campaigns
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-audio-pipeline/04-03-SUMMARY.md`
</output>
