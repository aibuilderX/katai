---
phase: 02-japanese-text-compositing
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/compositing/contrast-analyzer.ts
  - src/lib/compositing/text-renderer.ts
  - src/lib/compositing/vertical-text.ts
  - src/lib/compositing/logo-placer.ts
autonomous: true

must_haves:
  truths:
    - "System analyzes image regions and selects appropriate contrast treatment (backdrop/stroke/shadow)"
    - "SVG text overlays render with correct font family, size, color, and alignment"
    - "Vertical (tategaki) text renders character-by-character with correct rotation for half-width characters"
    - "Brand logo composites at fixed corner position with consistent padding"
  artifacts:
    - path: "src/lib/compositing/contrast-analyzer.ts"
      provides: "Region luminance analysis and contrast treatment selection"
      exports: ["analyzeRegionContrast", "selectContrastTreatment"]
    - path: "src/lib/compositing/text-renderer.ts"
      provides: "Horizontal SVG text overlay generation"
      exports: ["buildTextSvg", "buildCtaSvg"]
    - path: "src/lib/compositing/vertical-text.ts"
      provides: "Vertical (tategaki) SVG text rendering"
      exports: ["buildVerticalTextSvg"]
    - path: "src/lib/compositing/logo-placer.ts"
      provides: "Logo overlay compositing"
      exports: ["prepareLogoOverlay"]
  key_links:
    - from: "src/lib/compositing/contrast-analyzer.ts"
      to: "sharp"
      via: "sharp.extract().stats() for region analysis"
      pattern: "sharp.*extract.*stats"
    - from: "src/lib/compositing/text-renderer.ts"
      to: "src/lib/compositing/types.ts"
      via: "TextElement and ContrastTreatment imports"
      pattern: "import.*types"
    - from: "src/lib/compositing/logo-placer.ts"
      to: "sharp"
      via: "sharp.resize() for logo scaling"
      pattern: "sharp.*resize"
---

<objective>
Build the text rendering modules (horizontal SVG, vertical SVG), contrast analyzer, and logo placer.

Purpose: These are the core rendering components that transform text content + layout coordinates into SVG overlays ready for Sharp compositing. The contrast analyzer ensures text is readable on any background. The logo placer handles brand identity overlay. Together with kinsoku (02-01) and layout engine (02-03), these form the complete compositing toolkit.

Output: Four compositing modules: contrast analysis, horizontal text SVG, vertical text SVG, logo placement.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-japanese-text-compositing/02-RESEARCH.md
@.planning/phases/02-japanese-text-compositing/02-01-SUMMARY.md
@src/lib/compositing/types.ts
@src/lib/constants/kinsoku-chars.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build contrast analyzer and horizontal text renderer</name>
  <files>
    src/lib/compositing/contrast-analyzer.ts
    src/lib/compositing/text-renderer.ts
  </files>
  <action>
    **contrast-analyzer.ts:**

    1. `analyzeRegionContrast(imageBuffer: Buffer, region: {x, y, width, height}): Promise<RegionStats>`
       - Use `sharp(imageBuffer).extract({left, top, width, height}).toBuffer()` to extract the region
       - Use `sharp(regionBuffer).stats()` to get per-channel statistics
       - Calculate relative luminance: `0.2126 * (R.mean/255) + 0.7152 * (G.mean/255) + 0.0722 * (B.mean/255)` (WCAG formula)
       - Calculate variance as average of RGB channel stdev values
       - Clamp region coordinates to be within image bounds (Math.max(0, ...), Math.min(imageWidth, ...))
       - Return `{ luminance, variance }`

    2. `selectContrastTreatment(luminance: number, variance: number, textColor: string): ContrastTreatment`
       - Three-tier system per research recommendations:
         - High variance (stdev > 50): Semi-transparent backdrop, black 60% opacity, 8px border-radius
         - Low variance (<25) + extreme luminance (<0.3 or >0.7): Text stroke, contrasting color, 2px width
         - Medium variance (25-50): Drop shadow, 2px offset, 4px blur
       - For stroke: use white stroke on dark backgrounds (luminance < 0.5), black stroke on light backgrounds
       - Import ContrastTreatment and RegionStats from './types'

    **text-renderer.ts:**

    1. `buildTextSvg(element: TextElement, treatment: ContrastTreatment, lines: string[]): Buffer`
       - Build SVG buffer with text overlay and readability treatment
       - Calculate SVG dimensions: width = element.maxWidth + 40 (padding), height = (lines.length * fontSize * 1.4) + 40 (line height + padding)
       - Apply treatment:
         - 'backdrop': Render `<rect>` behind text with fill="rgba(0,0,0,{opacity})", rx/ry="8"
         - 'stroke': Add stroke and stroke-width attributes with paint-order="stroke" to text elements
         - 'shadow': Render a second darker text element offset by shadowOffset pixels (rendered first, behind main text). Use fill with reduced opacity for shadow color
       - Render each line as a separate `<text>` element with proper y-offset (line index * fontSize * 1.4)
       - Use text-anchor based on align: 'left'->'start', 'center'->'middle', 'right'->'end'
       - Escape XML characters in text content (& -> &amp;, < -> &lt;, > -> &gt;, " -> &quot;)
       - Return `Buffer.from(svg)`

    2. `buildCtaSvg(text: string, fontSize: number, fontFamily: string, brandColor: string, textColor: string): Buffer`
       - CTA elements get their own backdrop using exact brand colors (per locked decision)
       - Render pill-shaped background: `<rect>` with brand accent color, rx/ry = fontSize * 0.4
       - Text centered on the pill
       - Width = text length * fontSize + padding (40px)
       - Height = fontSize * 2
       - Return `Buffer.from(svg)`

    3. Helper: `escapeXml(text: string): string` -- escape &, <, >, " for SVG safety

    Import TextElement, ContrastTreatment from './types'.
  </action>
  <verify>
    - `pnpm build` passes
    - contrast-analyzer.ts exports both functions
    - text-renderer.ts exports buildTextSvg, buildCtaSvg, escapeXml
    - No TypeScript errors in imports
  </verify>
  <done>
    Contrast analyzer selects appropriate readability treatment based on image region statistics. Text renderer generates SVG buffers with correct font, color, alignment, and contrast treatment for horizontal text. CTA renderer uses exact brand colors with pill-shaped backdrop.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build vertical text renderer and logo placer</name>
  <files>
    src/lib/compositing/vertical-text.ts
    src/lib/compositing/logo-placer.ts
  </files>
  <action>
    **vertical-text.ts:**

    1. `buildVerticalTextSvg(text: string, fontSize: number, fontFamily: string, color: string, treatment: ContrastTreatment): Buffer`
       - Render Japanese text vertically (tategaki) using character-by-character SVG placement
       - SVG approach because Sharp/librsvg does NOT support CSS `writing-mode: vertical-rl` (per research anti-pattern)
       - Character height spacing: `fontSize * 1.2`
       - Total SVG height: `text.length * charHeight + 40` (padding)
       - SVG width: `fontSize + 40` (single column + padding)
       - For each character:
         - If half-width Latin/number (`/[A-Za-z0-9]/`): rotate 90 degrees clockwise using transform="rotate(90, centerX, centerY)"
         - If CJK/full-width: render upright, no rotation
         - Position: x = 20 (fixed column), y = 20 + (i * charHeight) + fontSize
       - Apply contrast treatment to the whole text block:
         - 'backdrop': Full-height rect behind the text column
         - 'stroke': Add stroke attributes to each character text element
         - 'shadow': Render shadow character elements offset and behind main elements
       - Escape XML in each character
       - Return `Buffer.from(svg)`

    2. `shouldUseVerticalText(headlineLength: number, headlineText: string, imageAspectRatio: number): boolean`
       - Criteria per research recommendations:
         - headline is 12 characters or fewer
         - headline is primarily CJK characters (>70% CJK via regex `/[\u3000-\u9fff\uf900-\ufaff]/`)
         - image aspect ratio is not a wide banner (aspectRatio <= 1.5 for landscape)
       - Returns true if all conditions met (Claude Vision should offer tategaki as one alternative)

    **logo-placer.ts:**

    1. `prepareLogoOverlay(logoBuffer: Buffer, imageWidth: number, imageHeight: number, position?: {x: number, y: number}): Promise<{input: Buffer, top: number, left: number}>`
       - Scale logo to ~12% of image width: `Math.round(imageWidth * 0.12)`
       - Use `sharp(logoBuffer).resize(targetWidth).png().toBuffer()` -- always chain .png().toBuffer() per research anti-pattern note
       - Default position: bottom-right with 40px padding from edges
         - left = imageWidth - targetWidth - 40
         - top = imageHeight - (proportional height) - 40
       - If position override provided, use that instead (for future Phase 5 flexibility)
       - Return Sharp composite-compatible overlay object: `{ input: resizedBuffer, top, left }`

    2. Get proportional height by reading metadata: `const meta = await sharp(logoBuffer).resize(targetWidth).metadata()` then use `meta.height`

    Import ContrastTreatment from './types'. Import sharp from 'sharp'.
  </action>
  <verify>
    - `pnpm build` passes
    - vertical-text.ts exports buildVerticalTextSvg and shouldUseVerticalText
    - logo-placer.ts exports prepareLogoOverlay
    - No TypeScript errors
  </verify>
  <done>
    Vertical text renderer produces character-by-character SVG for tategaki layout with correct rotation for half-width characters. Logo placer scales and positions brand logo at fixed bottom-right corner with consistent padding. Both modules ready for pipeline integration.
  </done>
</task>

</tasks>

<verification>
- All 4 compositing modules compile without errors: `pnpm build`
- contrast-analyzer correctly imports and uses Sharp's extract() and stats() API
- text-renderer generates valid SVG with escaped XML content
- vertical-text handles CJK characters upright and half-width characters rotated
- logo-placer scales to 12% of image width and positions at bottom-right with 40px padding
</verification>

<success_criteria>
- analyzeRegionContrast() uses Sharp stats API to calculate luminance and variance
- selectContrastTreatment() implements three-tier system (backdrop/stroke/shadow) based on thresholds
- buildTextSvg() produces valid SVG buffer with correct font, color, alignment, and treatment
- buildCtaSvg() uses exact brand colors for CTA pill background
- buildVerticalTextSvg() renders tategaki text character-by-character with correct rotation
- shouldUseVerticalText() evaluates headline length, CJK ratio, and aspect ratio
- prepareLogoOverlay() scales logo to 12% width and positions at bottom-right with 40px padding
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-japanese-text-compositing/02-02-SUMMARY.md`
</output>
