---
phase: 02-japanese-text-compositing
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/compositing/layout-engine.ts
  - src/lib/ai/prompts/layout-analysis.ts
autonomous: true

must_haves:
  truths:
    - "System sends base image to Claude Vision and receives 3 structured layout alternatives with text placement coordinates"
    - "Layout coordinates are validated within image bounds and snapped to a 20px grid"
    - "At least one layout alternative offers vertical (tategaki) orientation when conditions are met"
    - "Each layout alternative includes contrast zone assessments for text regions"
  artifacts:
    - path: "src/lib/compositing/layout-engine.ts"
      provides: "Claude Vision layout analysis and coordinate generation"
      exports: ["analyzeImageLayout", "validateLayoutCoordinates"]
    - path: "src/lib/ai/prompts/layout-analysis.ts"
      provides: "Claude Vision prompt and tool definition for layout analysis"
      exports: ["LAYOUT_ANALYSIS_TOOL", "buildLayoutAnalysisPrompt"]
  key_links:
    - from: "src/lib/compositing/layout-engine.ts"
      to: "@anthropic-ai/sdk"
      via: "Claude Vision API call with image input"
      pattern: "messages\\.create"
    - from: "src/lib/compositing/layout-engine.ts"
      to: "src/lib/compositing/types.ts"
      via: "LayoutAlternative type import"
      pattern: "import.*LayoutAlternative.*types"
    - from: "src/lib/compositing/layout-engine.ts"
      to: "src/lib/ai/prompts/layout-analysis.ts"
      via: "Tool definition and prompt builder import"
      pattern: "import.*layout-analysis"
---

<objective>
Build the Claude Vision layout analysis engine that auto-detects safe areas on base images and generates 3 structured layout alternatives with text placement coordinates.

Purpose: This is the intelligence layer of compositing. Every composited image needs layout coordinates before text can be placed. Claude Vision analyzes the image content (faces, products, negative space) and proposes 3 distinct placements for headline, tagline, CTA, and logo. This replaces manual layout design with AI-driven auto-placement -- a key user-facing feature ("AI auto-detects safe areas").

Output: Layout engine module and Claude Vision prompt/tool definition. Can run in parallel with 02-02 since both depend only on 02-01 types.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-japanese-text-compositing/02-RESEARCH.md
@.planning/phases/02-japanese-text-compositing/02-01-SUMMARY.md
@src/lib/compositing/types.ts
@src/lib/ai/claude.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create layout analysis prompt and Claude Vision tool definition</name>
  <files>
    src/lib/ai/prompts/layout-analysis.ts
  </files>
  <action>
    Create `src/lib/ai/prompts/layout-analysis.ts` with:

    1. `LAYOUT_ANALYSIS_TOOL` -- Anthropic tool definition for structured layout output:
       - Tool name: `deliver_layout_alternatives`
       - Input schema defines an object with:
         - `alternatives`: array of 3 items, each containing:
           - `id`: string ('A', 'B', 'C')
           - `headline`: object with x, y, maxWidth, align (enum: left/center/right) -- all required
           - `tagline`: same structure as headline, OR null
           - `cta`: same structure as headline -- required
           - `orientation`: enum 'horizontal' | 'vertical'
           - `contrastZones`: array of objects with region {x, y, width, height} and brightness ('light'|'dark'|'mixed')
         - `imageDescription`: string (brief description of image content)
         - `safeAreas`: array of {x, y, width, height} regions
       - All of alternatives, imageDescription, safeAreas are required

    2. `buildLayoutAnalysisPrompt(params)` -- function that builds the user prompt text:
       - Parameters: `{ imageWidth: number, imageHeight: number, hasTagline: boolean, hasLogo: boolean, headlineText: string, headlineLength: number }`
       - The prompt instructs Claude to:
         - Analyze the image for text placement on a {imageWidth}x{imageHeight}px advertising image
         - Return 3 layout alternatives with coordinates in pixels
         - Place text in areas with low visual complexity (sky, gradients, solid areas)
         - Avoid covering the main subject of the image
         - Each alternative should use a DIFFERENT region of the image
         - When conditions are met (vertical safe area exists, headline <= 12 chars, primarily CJK, non-wide format), include tategaki as one alternative
         - All coordinates must be within image bounds with 40px edge padding
         - Indicate brightness assessment for each text region
         - If hasTagline is false, instruct that tagline should be null
         - If hasLogo is false, instruct that no logo position is needed
         - Logo position: bottom-right corner with 40px padding (per locked decision)
       - Use the `deliver_layout_alternatives` tool
       - Return the prompt string

    Import `Anthropic` type from `@anthropic-ai/sdk` for the Tool type. Use `Anthropic.Tool` as the type for `LAYOUT_ANALYSIS_TOOL`.
  </action>
  <verify>
    - `pnpm build` passes
    - layout-analysis.ts exports LAYOUT_ANALYSIS_TOOL and buildLayoutAnalysisPrompt
    - Tool schema has 3-item array constraint for alternatives
  </verify>
  <done>
    Claude Vision tool definition and prompt builder ready for use by layout-engine.ts. Prompt instructs Claude to analyze image content and return 3 structured layout alternatives with pixel-accurate coordinates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build layout engine with Claude Vision integration and coordinate validation</name>
  <files>
    src/lib/compositing/layout-engine.ts
  </files>
  <action>
    Create `src/lib/compositing/layout-engine.ts` with:

    1. `analyzeImageLayout(params): Promise<LayoutAlternative[]>` -- main function:
       - Parameters: `{ imageBuffer: Buffer, imageWidth: number, imageHeight: number, hasTagline: boolean, hasLogo: boolean, headlineText: string }`
       - Convert imageBuffer to base64
       - Create Anthropic client: `new Anthropic()` (uses ANTHROPIC_API_KEY env var, same pattern as src/lib/ai/claude.ts)
       - Call `anthropic.messages.create()` with:
         - model: `'claude-sonnet-4-5-20250514'` (same model used in copy generation)
         - max_tokens: 2048
         - messages: single user message with image (base64, media_type 'image/png') + text (from buildLayoutAnalysisPrompt)
         - tools: [LAYOUT_ANALYSIS_TOOL]
         - tool_choice: { type: 'tool', name: 'deliver_layout_alternatives' } -- force tool use
       - Extract tool_use result from response.content
       - Parse the alternatives from tool result input
       - Run `validateLayoutCoordinates()` on each alternative
       - Return validated LayoutAlternative[]

    2. `validateLayoutCoordinates(layout: LayoutAlternative, imageWidth: number, imageHeight: number): LayoutAlternative` -- post-processing:
       - Snap all coordinates to 20px grid: `Math.round(coord / 20) * 20`
       - Clamp all coordinates within image bounds with 40px padding:
         - x: min 40, max imageWidth - 40
         - y: min 40, max imageHeight - 40
         - maxWidth: min 100, max imageWidth - x - 40
       - Ensure no text element overlaps with another (basic check: if two elements have overlapping y ranges, adjust the lower one down)
       - Ensure headline maxWidth is at least 200px (readable text needs minimum width)
       - Return the corrected layout

    3. Handle errors gracefully:
       - If Claude API call fails, return a fallback set of 3 safe default layouts:
         - Layout A: Headline top-center, tagline below headline, CTA bottom-center, horizontal
         - Layout B: Headline top-left, tagline below, CTA bottom-right, horizontal
         - Layout C: Headline right-center vertical (if conditions met), else top-right horizontal, CTA bottom-center
       - Fallback layouts calculate positions from imageWidth/imageHeight with percentage-based placement
       - Log warning but don't throw

    Import: LayoutAlternative from './types', LAYOUT_ANALYSIS_TOOL + buildLayoutAnalysisPrompt from '@/lib/ai/prompts/layout-analysis', Anthropic from '@anthropic-ai/sdk'.
  </action>
  <verify>
    - `pnpm build` passes
    - layout-engine.ts exports analyzeImageLayout and validateLayoutCoordinates
    - Fallback layouts are valid (within image bounds)
    - No TypeScript errors in Claude API usage
  </verify>
  <done>
    Layout engine analyzes base images via Claude Vision, returns 3 validated layout alternatives with text placement coordinates snapped to 20px grid and clamped within image bounds. Fallback safe layouts available if Claude API fails.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes without errors
- layout-engine.ts correctly imports and uses Claude Vision API with tool_use pattern
- Coordinate validation clamps all positions within image bounds with 40px edge padding
- Fallback layouts produce valid coordinates for any image dimension
- Tool definition schema enforces exactly 3 alternatives
</verification>

<success_criteria>
- analyzeImageLayout() sends base image to Claude Vision and receives 3 structured layout alternatives
- LAYOUT_ANALYSIS_TOOL defines correct input schema with required fields
- buildLayoutAnalysisPrompt() generates context-aware prompt with image dimensions and element flags
- validateLayoutCoordinates() snaps to 20px grid, clamps to bounds, checks overlap
- Fallback layouts work when Claude API is unavailable
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-japanese-text-compositing/02-03-SUMMARY.md`
</output>
