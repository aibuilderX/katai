---
phase: 07-infrastructure-deployment-production-setup
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - scripts/verify-env.sh
autonomous: false

user_setup:
  - service: vercel
    why: "Production hosting"
    env_vars:
      - name: "All NEXT_PUBLIC_* and server-only vars"
        source: "See .env.local.example for complete list"
    dashboard_config:
      - task: "Link GitHub repository to Vercel project"
        location: "Vercel Dashboard -> New Project -> Import Git Repository"
  - service: supabase
    why: "Auth, database, storage, realtime"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role key"
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Settings -> Database -> Connection string (use Transaction pooler, port 6543)"
    dashboard_config:
      - task: "Run supabase/infrastructure.sql in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"
      - task: "Update Site URL to production domain"
        location: "Supabase Dashboard -> Authentication -> URL Configuration"
      - task: "Add production URL to Redirect URLs"
        location: "Supabase Dashboard -> Authentication -> URL Configuration"
  - service: stripe
    why: "Subscription billing"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret (create endpoint first)"
      - name: STRIPE_STARTER_PRICE_ID
        source: "Stripe Dashboard -> Products -> Starter -> Price ID"
      - name: STRIPE_PRO_PRICE_ID
        source: "Stripe Dashboard -> Products -> Pro -> Price ID"
      - name: STRIPE_BUSINESS_PRICE_ID
        source: "Stripe Dashboard -> Products -> Business -> Price ID"
    dashboard_config:
      - task: "Create 3 products (Starter 5000 JPY/mo, Pro 15000 JPY/mo, Business 50000 JPY/mo)"
        location: "Stripe Dashboard -> Products"
      - task: "Create webhook endpoint pointing to https://your-domain/api/webhooks/stripe"
        location: "Stripe Dashboard -> Developers -> Webhooks"
      - task: "Subscribe webhook to: checkout.session.completed, customer.subscription.updated, customer.subscription.deleted, invoice.payment_succeeded"
        location: "Stripe Dashboard -> Developers -> Webhooks -> endpoint -> Events"

must_haves:
  truths:
    - "Environment verification script checks all required variables"
    - "User has a clear checklist for all external service configuration"
    - "Application builds successfully with production configuration"
  artifacts:
    - path: "scripts/verify-env.sh"
      provides: "Environment variable verification"
      contains: "REQUIRED_VARS"
  key_links:
    - from: "scripts/verify-env.sh"
      to: ".env.local.example"
      via: "same variable names"
      pattern: "NEXT_PUBLIC_SUPABASE_URL.*STRIPE_SECRET_KEY"
---

<objective>
Create an environment verification script and provide a production deployment checklist covering Vercel, Supabase, and Stripe configuration.

Purpose: Phase 7 involves significant human-action configuration (Vercel env vars, Supabase SQL execution, Stripe product creation) that Claude cannot automate. This plan creates the automation that IS possible (env verification script) and structures the human steps clearly via a checkpoint.
Output: Verification script, confirmed production readiness
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-infrastructure-deployment-production-setup/07-RESEARCH.md
@.env.local.example
@vercel.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment verification script</name>
  <files>scripts/verify-env.sh</files>
  <action>
Create scripts/verify-env.sh -- a bash script that verifies all required environment variables are set. This script can be run locally before deployment or in CI.

Required variables (deployment will fail without these):
- NEXT_PUBLIC_SUPABASE_URL
- NEXT_PUBLIC_SUPABASE_ANON_KEY
- NEXT_PUBLIC_APP_URL
- SUPABASE_SERVICE_ROLE_KEY
- DATABASE_URL
- ANTHROPIC_API_KEY
- BFL_API_KEY
- STRIPE_SECRET_KEY
- STRIPE_WEBHOOK_SECRET
- STRIPE_STARTER_PRICE_ID
- STRIPE_PRO_PRICE_ID
- STRIPE_BUSINESS_PRICE_ID

Optional variables (features degrade gracefully without these):
- N8N_WEBHOOK_URL (falls back to direct generation)
- N8N_WEBHOOK_SECRET
- FAL_KEY (video generation unavailable)
- RUNWAYML_API_SECRET (cinematic video unavailable)
- ELEVENLABS_API_KEY (voiceover unavailable)
- ELEVENLABS_VOICE_ID_JP_FEMALE
- HEYGEN_API_KEY (avatar generation unavailable)
- HEYGEN_DEFAULT_AVATAR_ID
- HEYGEN_JP_VOICE_ID

The script should:
1. Check each required var, print "MISSING (required): VAR_NAME" if absent
2. Check each optional var, print "MISSING (optional): VAR_NAME" if absent
3. Exit with code 1 if any required vars are missing, code 0 if all present
4. Print summary at end: "X/Y required set, Z optional set"
5. Make executable with chmod +x

Add a shebang line `#!/usr/bin/env bash` and set -euo pipefail for safety.
  </action>
  <verify>
1. File exists: scripts/verify-env.sh
2. File is executable: `test -x scripts/verify-env.sh`
3. Running without any env vars set shows all as MISSING and exits with code 1
4. Script lists all 12 required and 9 optional variables
  </verify>
  <done>Environment verification script exists, is executable, checks all 21 environment variables with clear required/optional distinction.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Production deployment readiness verification</name>
  <files>none (human verification checkpoint)</files>
  <action>
Present the production deployment checklist to the user. Plans 07-01 and 07-02 created all the code artifacts. This checkpoint verifies the user has completed the external service configuration and deployment steps that Claude cannot automate.

Checklist to present:

1. Supabase: Run infrastructure.sql, update auth redirect URLs
2. Stripe: Create 3 products with JPY prices, create webhook endpoint, note signing secret
3. Vercel: Set all env vars, deploy with `vercel --prod`
4. Post-deploy: Verify login page, OAuth redirect, billing page
  </action>
  <verify>
User confirms the production URL is accessible and core functionality works:
- Login page loads with Japanese UI
- Google OAuth redirects correctly (not to localhost)
- Stripe billing page loads without errors
  </verify>
  <done>User has typed "deployed" with the production URL, confirming the application is live and accessible.</done>
</task>

</tasks>

<verification>
1. scripts/verify-env.sh exists and is executable
2. All files from Plans 01 and 02 are present
3. User has confirmed production deployment
</verification>

<success_criteria>
- Environment verification script works correctly
- User has completed the production deployment checklist
- Application is accessible at production URL
</success_criteria>

<output>
After completion, create `.planning/phases/07-infrastructure-deployment-production-setup/07-03-SUMMARY.md`
</output>
