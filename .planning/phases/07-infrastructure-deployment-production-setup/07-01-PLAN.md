---
phase: 07-infrastructure-deployment-production-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/0000_initial-schema.sql
  - src/lib/db/migrations/meta/_journal.json
  - supabase/infrastructure.sql
autonomous: true

must_haves:
  truths:
    - "Drizzle migration SQL exists covering all 14 tables in schema.ts"
    - "Supabase infrastructure SQL script creates all 4 storage buckets"
    - "Supabase infrastructure SQL enables REPLICA IDENTITY FULL on campaigns table"
    - "Storage RLS policies allow public read and service-role write"
  artifacts:
    - path: "src/lib/db/migrations/0000_initial-schema.sql"
      provides: "SQL migration for all tables"
      contains: "CREATE TABLE"
    - path: "supabase/infrastructure.sql"
      provides: "Storage buckets, realtime, RLS policies"
      contains: "storage.buckets"
  key_links:
    - from: "drizzle.config.ts"
      to: "src/lib/db/migrations/"
      via: "out directory config"
      pattern: "out.*migrations"
    - from: "supabase/infrastructure.sql"
      to: "storage.buckets"
      via: "SQL INSERT"
      pattern: "composited-images.*platform-images.*campaign-videos.*campaign-audio"
---

<objective>
Generate Drizzle migration files from the existing TypeScript schema and create a Supabase infrastructure SQL script for storage buckets, realtime configuration, and RLS policies.

Purpose: The project has been using `drizzle-kit push` during development. For production, proper migration files provide an audit trail, reproducibility, and safe schema application. The Supabase infrastructure script consolidates all pending storage bucket creation, realtime setup, and RLS policies into a single reviewable SQL file.
Output: Migration SQL in src/lib/db/migrations/, infrastructure SQL in supabase/infrastructure.sql
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-infrastructure-deployment-production-setup/07-RESEARCH.md
@drizzle.config.ts
@src/lib/db/schema.ts
@src/lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Drizzle migration files from existing schema</name>
  <files>src/lib/db/migrations/0000_initial-schema.sql, src/lib/db/migrations/meta/_journal.json</files>
  <action>
Run `npx drizzle-kit generate --name initial-schema` to produce the initial migration SQL from src/lib/db/schema.ts. The drizzle.config.ts already points to the correct schema and output directory (./src/lib/db/migrations).

After generation, read and review the produced SQL file. Verify it contains CREATE TABLE statements for all 14 tables defined in schema.ts: profiles, teams, team_members, brand_profiles, campaigns, copy_variants, assets, approval_workflows, approval_history, qa_reports, stripe_customers, subscriptions, credit_ledger, compliance_reports.

Also verify the meta/_journal.json was created (Drizzle's migration tracking file).

Do NOT run `drizzle-kit migrate` -- that applies the migration to the database. Migration application will happen during production deployment (Plan 03).
  </action>
  <verify>
1. File exists: src/lib/db/migrations/0000_initial-schema.sql
2. File exists: src/lib/db/migrations/meta/_journal.json
3. SQL file contains CREATE TABLE for all 14 tables
4. `npx drizzle-kit check` passes with no conflicts
  </verify>
  <done>Migration SQL file exists with CREATE TABLE for all 14 schema tables. Meta journal tracks the migration. No manual SQL edits needed.</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase infrastructure SQL script</name>
  <files>supabase/infrastructure.sql</files>
  <action>
Create supabase/infrastructure.sql with all one-time Supabase infrastructure setup consolidated into a single reviewable SQL file. This addresses the pending todos from STATE.md.

The script must include (in order):

1. **REPLICA IDENTITY FULL on campaigns table** -- enables Supabase Realtime to include full row data in UPDATE events:
```sql
ALTER TABLE campaigns REPLICA IDENTITY FULL;
```

2. **Realtime publication** -- add campaigns table to Supabase realtime:
```sql
ALTER PUBLICATION supabase_realtime ADD TABLE campaigns;
```

3. **Storage bucket creation** -- all 4 buckets with appropriate size limits:
```sql
INSERT INTO storage.buckets (id, name, public, file_size_limit)
VALUES
  ('composited-images', 'composited-images', true, 10485760),
  ('platform-images', 'platform-images', true, 10485760),
  ('campaign-videos', 'campaign-videos', true, 104857600),
  ('campaign-audio', 'campaign-audio', true, 20971520)
ON CONFLICT (id) DO NOTHING;
```

4. **Storage RLS policies** -- public read access for all 4 buckets. Note: service_role bypasses RLS by default, so no explicit write policy needed for the adminClient:
```sql
CREATE POLICY "Allow public read on campaign buckets" ON storage.objects
  FOR SELECT
  TO public
  USING (bucket_id IN ('composited-images', 'platform-images', 'campaign-videos', 'campaign-audio'));
```

Add clear section comments explaining each block. Add a header comment noting this script should be run once in the Supabase SQL Editor before first production deployment.

Important: Use ON CONFLICT for idempotency where possible. Use IF NOT EXISTS for policies if Supabase supports it, otherwise add a comment noting re-running may error on existing policies.
  </action>
  <verify>
1. File exists: supabase/infrastructure.sql
2. Contains ALTER TABLE campaigns REPLICA IDENTITY FULL
3. Contains ALTER PUBLICATION supabase_realtime ADD TABLE campaigns
4. Contains INSERT INTO storage.buckets for all 4 buckets
5. Contains CREATE POLICY for public read access
  </verify>
  <done>Infrastructure SQL script is complete, idempotent where possible, well-commented, and ready for one-time execution in Supabase SQL Editor.</done>
</task>

</tasks>

<verification>
1. `ls src/lib/db/migrations/` shows migration SQL and meta directory
2. `grep -c "CREATE TABLE" src/lib/db/migrations/0000_initial-schema.sql` returns 14
3. `cat supabase/infrastructure.sql` shows all 4 sections (replica identity, realtime, buckets, policies)
</verification>

<success_criteria>
- Drizzle migration file covers all 14 tables from schema.ts
- Drizzle meta journal exists for migration tracking
- Supabase infrastructure SQL is a single, reviewable file covering all pending infrastructure todos
- No database was modified (migration generation only, not application)
</success_criteria>

<output>
After completion, create `.planning/phases/07-infrastructure-deployment-production-setup/07-01-SUMMARY.md`
</output>
