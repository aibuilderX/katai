---
phase: 07-infrastructure-deployment-production-setup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - vercel.json
  - src/app/api/campaigns/route.ts
  - src/app/api/webhooks/n8n/route.ts
  - src/app/api/webhooks/stripe/route.ts
  - src/app/api/campaigns/[id]/download/route.ts
  - .env.local.example
autonomous: true

must_haves:
  truths:
    - "vercel.json configures Tokyo region and function timeouts"
    - "Campaign creation route has maxDuration export for extended execution"
    - "Webhook routes have appropriate maxDuration exports"
    - ".env.local.example documents all environment variables needed for production"
  artifacts:
    - path: "vercel.json"
      provides: "Vercel deployment configuration"
      contains: "hnd1"
    - path: "src/app/api/campaigns/route.ts"
      provides: "maxDuration export for campaign generation"
      contains: "maxDuration"
    - path: ".env.local.example"
      provides: "Complete environment variable reference"
      contains: "STRIPE_SECRET_KEY"
  key_links:
    - from: "vercel.json"
      to: "src/app/api/campaigns/route.ts"
      via: "function configuration"
      pattern: "campaigns/route"
    - from: "vercel.json"
      to: "regions"
      via: "deployment region"
      pattern: "hnd1"
---

<objective>
Configure the Vercel deployment settings, add function timeout exports to long-running API routes, and update the environment variable example file to document all production variables.

Purpose: The application needs Vercel-specific configuration for production: Tokyo region for Japanese market latency, function timeout overrides for the campaign generation pipeline and webhook handlers, and a complete environment variable reference so the deployment checklist is clear.
Output: vercel.json, maxDuration exports on 4 API routes, updated .env.local.example
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-infrastructure-deployment-production-setup/07-RESEARCH.md
@src/app/api/campaigns/route.ts
@src/app/api/webhooks/n8n/route.ts
@src/app/api/webhooks/stripe/route.ts
@src/app/api/campaigns/[id]/download/route.ts
@.env.local.example
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vercel.json and add maxDuration exports to API routes</name>
  <files>vercel.json, src/app/api/campaigns/route.ts, src/app/api/webhooks/n8n/route.ts, src/app/api/webhooks/stripe/route.ts, src/app/api/campaigns/[id]/download/route.ts</files>
  <action>
**Create vercel.json** at project root with:
```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "framework": "nextjs",
  "regions": ["hnd1"]
}
```

Use ONLY the `regions` field in vercel.json. Do NOT use the `functions` block for maxDuration -- instead, use Next.js route segment config exports directly in the route files (this is the Next.js-native approach and avoids potential conflicts with the App Router).

**Add maxDuration exports** to the top of each route file (after imports, before the handler functions). These are Next.js route segment config exports:

1. `src/app/api/campaigns/route.ts` -- Add `export const maxDuration = 300;` (5 minutes). This is the safety net for direct generation fallback mode. When n8n is configured, the route returns quickly after webhook trigger, but without n8n the full AI pipeline runs in-process.

2. `src/app/api/webhooks/n8n/route.ts` -- Add `export const maxDuration = 60;` (1 minute). The n8n callback handler downloads media from provider URLs and stores to Supabase Storage. Downloads of video files can take time.

3. `src/app/api/webhooks/stripe/route.ts` -- Add `export const maxDuration = 30;` (30 seconds). Stripe webhook handler does DB operations and credit syncing. Should be fast but needs headroom.

4. `src/app/api/campaigns/[id]/download/route.ts` -- Add `export const maxDuration = 120;` (2 minutes). ZIP generation fetches multiple assets from Supabase Storage and compresses them.

For each route file: read the existing file, add the maxDuration export line after the last import statement (before any other exports or function declarations), and write back. Do NOT modify any existing code -- only add the single export line.
  </action>
  <verify>
1. `cat vercel.json` shows valid JSON with regions: ["hnd1"]
2. `grep "maxDuration" src/app/api/campaigns/route.ts` shows 300
3. `grep "maxDuration" src/app/api/webhooks/n8n/route.ts` shows 60
4. `grep "maxDuration" src/app/api/webhooks/stripe/route.ts` shows 30
5. `grep "maxDuration" src/app/api/campaigns/\\[id\\]/download/route.ts` shows 120
6. `npm run build` passes (type check + build succeeds)
  </verify>
  <done>vercel.json exists with Tokyo region. All 4 API routes have maxDuration exports. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Update .env.local.example with complete production variable inventory</name>
  <files>.env.local.example</files>
  <action>
Replace the current .env.local.example (which only has 6 variables) with a complete inventory of ALL environment variables the application uses. Group by category with clear comments:

```bash
# ============================================
# AI Content Studio - Environment Variables
# ============================================
# Copy this file to .env.local and fill in values.
# Variables prefixed with NEXT_PUBLIC_ are inlined at build time.

# --- Supabase ---
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# --- Database ---
# Use connection pooler URL (port 6543) for production/Vercel
# Use direct URL (port 5432) for local development
DATABASE_URL=postgresql://postgres:password@db.your-project.supabase.co:6543/postgres

# --- App ---
NEXT_PUBLIC_APP_URL=http://localhost:3000

# --- n8n Webhook (optional -- direct generation fallback works without) ---
N8N_WEBHOOK_URL=https://your-n8n.example.com/webhook/campaign
N8N_WEBHOOK_SECRET=your-webhook-secret

# --- AI Services ---
ANTHROPIC_API_KEY=your-anthropic-api-key
BFL_API_KEY=your-bfl-api-key

# --- AI Services (Video/Audio -- optional for image-only campaigns) ---
FAL_KEY=your-fal-key
RUNWAYML_API_SECRET=your-runwayml-secret
ELEVENLABS_API_KEY=your-elevenlabs-key
ELEVENLABS_VOICE_ID_JP_FEMALE=your-voice-id
HEYGEN_API_KEY=your-heygen-key
HEYGEN_DEFAULT_AVATAR_ID=your-avatar-id
HEYGEN_JP_VOICE_ID=your-heygen-voice-id

# --- Stripe ---
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_STARTER_PRICE_ID=price_...
STRIPE_PRO_PRICE_ID=price_...
STRIPE_BUSINESS_PRICE_ID=price_...
```

Note the DATABASE_URL uses port 6543 (pooler) as the default, with a comment explaining port 5432 for local dev. This addresses the connection pooling pitfall from research.
  </action>
  <verify>
1. `wc -l .env.local.example` shows substantially more lines than the previous 15
2. File contains all 22 environment variables referenced by the codebase
3. Contains grouping comments for Supabase, Database, App, n8n, AI Services, Stripe sections
4. DATABASE_URL default uses port 6543
  </verify>
  <done>.env.local.example is a complete reference of all environment variables with clear grouping, comments distinguishing required vs optional, and production-appropriate defaults.</done>
</task>

</tasks>

<verification>
1. `cat vercel.json | python3 -m json.tool` parses valid JSON
2. Build succeeds: `npm run build` (verifies maxDuration exports are valid route segment config)
3. `.env.local.example` lists all env vars from research inventory
</verification>

<success_criteria>
- vercel.json configures Tokyo region (hnd1)
- 4 API routes have appropriate maxDuration exports
- Build passes with all changes
- .env.local.example is a complete production deployment reference
</success_criteria>

<output>
After completion, create `.planning/phases/07-infrastructure-deployment-production-setup/07-02-SUMMARY.md`
</output>
