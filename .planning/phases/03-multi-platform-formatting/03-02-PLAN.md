---
phase: 03-multi-platform-formatting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/platforms/image-resizer.ts
  - src/lib/platforms/email-template.ts
autonomous: true

must_haves:
  truths:
    - "System resizes composited images to all 7 platform dimension sets using sharp"
    - "Extreme aspect ratios (728x90, 160x600, 320x50) use fit:contain with brand background instead of crop"
    - "HTML email template generates table-based layout with inline CSS under 102KB"
  artifacts:
    - path: "src/lib/platforms/image-resizer.ts"
      provides: "Multi-platform image resize pipeline using sharp"
      exports: ["resizeForPlatforms", "ResizeTarget", "ResizedAsset", "getResizeTargetsForPlatforms"]
    - path: "src/lib/platforms/email-template.ts"
      provides: "HTML email template generator with table-based layout"
      exports: ["buildEmailHtml", "EmailTemplateParams"]
  key_links:
    - from: "src/lib/platforms/image-resizer.ts"
      to: "src/lib/constants/platforms.ts"
      via: "import PLATFORMS for dimension lookup"
      pattern: "PLATFORMS|getPlatformById"
    - from: "src/lib/platforms/image-resizer.ts"
      to: "sharp"
      via: "sharp.resize() for image processing"
      pattern: "sharp.*resize"
---

<objective>
Build the multi-platform image resize pipeline and HTML email template generator.

Purpose: Requirements IMG-04 (auto-resize to platform dimensions) and PLAT-01 through PLAT-07 (image side). Also PLAT-07 email HTML generation. These are standalone utilities with no dependency on Plan 01.
Output: Image resizer that takes a composited image and produces all platform variants, plus email HTML template builder.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-platform-formatting/03-RESEARCH.md

@src/lib/constants/platforms.ts
@src/lib/compositing/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build multi-platform image resize pipeline</name>
  <files>src/lib/platforms/image-resizer.ts</files>
  <action>
Create `src/lib/platforms/image-resizer.ts` with:

1. **Types:**
   ```typescript
   export interface ResizeTarget {
     platformId: string
     label: string
     width: number
     height: number
   }

   export interface ResizedAsset {
     platformId: string
     dimensionLabel: string
     width: number
     height: number
     buffer: Buffer
     fileName: string
   }
   ```

2. **`getResizeTargetsForPlatforms(platformIds: string[]): ResizeTarget[]`**
   - Import `PLATFORMS` from `@/lib/constants/platforms`
   - For each platformId, look up the platform definition and extract all its dimensions
   - Return flat array of ResizeTarget objects (one per dimension per platform)
   - Skip unknown platform IDs silently

3. **Aspect ratio strategy helper (internal):**
   ```typescript
   function getResizeStrategy(
     sourceWidth: number, sourceHeight: number,
     targetWidth: number, targetHeight: number
   ): { fit: "cover" | "contain"; useBackground: boolean }
   ```
   - Calculate source and target aspect ratios
   - If ratio difference > 3x: use `contain` with background (extreme ratios like 728x90)
   - Otherwise: use `cover` with `position: "attention"` (smart crop)
   - This follows the research recommendation

4. **`resizeForPlatforms(sourceBuffer: Buffer, sourceWidth: number, sourceHeight: number, targets: ResizeTarget[], brandBackgroundColor?: string): Promise<ResizedAsset[]>`**
   - For each target, determine resize strategy
   - For `cover` strategy: `sharp(sourceBuffer).resize(w, h, { fit: "cover", position: "attention", kernel: sharp.kernel.lanczos3 }).png().toBuffer()`
   - For `contain` strategy: `sharp(sourceBuffer).resize(w, h, { fit: "contain", background: parseColor(brandBackgroundColor || "#FFFFFF") }).png().toBuffer()`
   - Return array of ResizedAsset with fileName format: `{platformId}-{label}-{width}x{height}.png`
   - Process targets sequentially (not parallel) to avoid memory spikes from sharp -- each resize is fast individually

5. **Color parsing helper (internal):**
   - Parse hex color string to `{ r, g, b, alpha }` for sharp's background option
   - Default to white `{ r: 255, g: 255, b: 255, alpha: 1 }` on parse failure
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify sharp import resolves (already in package.json).
  </verify>
  <done>
Image resizer pipeline processes composited images into all platform dimensions. Smart crop for similar ratios, contain with brand background for extreme ratios. Sequential processing to manage memory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build HTML email template generator</name>
  <files>src/lib/platforms/email-template.ts</files>
  <action>
Create `src/lib/platforms/email-template.ts` with:

1. **Types:**
   ```typescript
   export interface EmailTemplateParams {
     headline: string
     bodyText: string
     ctaText: string
     ctaUrl: string
     headerImageUrl: string
     brandName: string
     brandColors: { primary: string; accent: string; background: string }
   }
   ```

2. **`buildEmailHtml(params: EmailTemplateParams): string`**
   - Generate complete HTML document with `lang="ja"` and `charset="utf-8"`
   - Use table-based layout ONLY (no flexbox, no grid -- Outlook compatibility per research)
   - All CSS must be inline (no `<style>` blocks -- Outlook strips them)
   - Max width 600px (standard email width)
   - Structure:
     - Header image (full width, `display:block`)
     - Headline in `<h1>` with inline styles (22px, line-height 1.4, color #1a1a1a)
     - Body text in `<p>` with inline styles (16px, line-height 1.8, color #333333)
     - CTA button using table-based technique (background-color from brand accent, white text, border-radius 4px, padding 12px 32px)
     - Footer with brand name in small text
   - Font stack: `'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif` (safe for email clients)
   - Background: #f5f5f5 outer, #ffffff inner
   - Use brand's background color for outer background if provided
   - Ensure total HTML is well under 102KB (Gmail clipping threshold per research)

3. **HTML entity escaping helper (internal):**
   - Escape `<`, `>`, `&`, `"` in user-provided text fields to prevent XSS/injection in the email HTML
   - Apply to headline, bodyText, ctaText, brandName before embedding

The email template is intentionally simple -- a single promotional email layout. Complex email builders are deferred (research recommended hand-rolling for Phase 3, not react-email dependency).
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. The generated HTML should be valid and well-formed.
  </verify>
  <done>
Email template generator produces table-based HTML with inline CSS, 600px width, Outlook-compatible layout, under 102KB. Brand colors applied to CTA button and header.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `resizeForPlatforms` handles both cover (similar ratio) and contain (extreme ratio) strategies
3. `getResizeTargetsForPlatforms` extracts dimensions from PLATFORMS constant
4. `buildEmailHtml` returns valid HTML with table-based layout and inline CSS
5. No new npm dependencies needed (sharp already installed)
</verification>

<success_criteria>
- Image resize pipeline takes a composited image buffer and produces all platform dimension variants
- Extreme aspect ratios use contain+background instead of destructive cropping
- HTML email template generates Outlook-compatible table layout with brand styling
- Both utilities are standalone and ready for pipeline integration in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-platform-formatting/03-02-SUMMARY.md`
</output>
