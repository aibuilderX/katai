---
phase: 03-multi-platform-formatting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/platforms/copy-constraints.ts
  - src/lib/ai/prompts/copy-generation.ts
  - src/lib/ai/claude.ts
autonomous: true

must_haves:
  truths:
    - "Claude generates platform-specific copy with enforced character limits per platform"
    - "Each platform gets 4 variants with headline, body, CTA, and hashtags respecting its character limits"
    - "Japanese character counting uses codepoint-accurate [...str].length, not .length"
  artifacts:
    - path: "src/lib/platforms/copy-constraints.ts"
      provides: "Platform copy constraint registry with character limits for all 7 Phase 3 platforms"
      exports: ["PLATFORM_COPY_CONSTRAINTS", "PlatformCopyConstraints", "validateCopyLength", "countJapaneseChars"]
    - path: "src/lib/ai/prompts/copy-generation.ts"
      provides: "Platform-aware copy prompt builder"
      contains: "buildPlatformCopyPrompt"
    - path: "src/lib/ai/claude.ts"
      provides: "Platform-aware copy generation with per-platform tool schema"
      contains: "generatePlatformCopy"
  key_links:
    - from: "src/lib/ai/claude.ts"
      to: "src/lib/platforms/copy-constraints.ts"
      via: "import PLATFORM_COPY_CONSTRAINTS for prompt building"
      pattern: "PLATFORM_COPY_CONSTRAINTS"
    - from: "src/lib/ai/claude.ts"
      to: "src/lib/ai/prompts/copy-generation.ts"
      via: "import buildPlatformCopyPrompt"
      pattern: "buildPlatformCopyPrompt"
---

<objective>
Create the platform copy constraints registry and upgrade Claude copy generation from generic 4-variant output to platform-specific variants with enforced character limits.

Purpose: Requirements COPY-03 and COPY-05 -- system must generate copy length variants per platform and enforce platform-specific copy rules (character limits, format constraints). Currently Claude generates identical copy for all platforms.
Output: Platform constraint registry, platform-aware prompt builder, new `generatePlatformCopy()` function.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-platform-formatting/03-RESEARCH.md

@src/lib/constants/platforms.ts
@src/lib/ai/prompts/copy-generation.ts
@src/lib/ai/claude.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform copy constraints registry with validation utilities</name>
  <files>src/lib/platforms/copy-constraints.ts</files>
  <action>
Create `src/lib/platforms/copy-constraints.ts` with:

1. **`PlatformCopyConstraints` interface:**
   ```typescript
   export interface PlatformCopyConstraints {
     platformId: string
     headline: { maxChars: number; label: string }
     body: { maxChars: number; label: string }
     cta: { maxChars: number; label: string }
     hashtags: { max: number; required: boolean }
     formatNotes: string[] // Platform-specific formatting rules in Japanese
   }
   ```

2. **`PLATFORM_COPY_CONSTRAINTS` registry** -- a `Record<string, PlatformCopyConstraints>` covering the 7 Phase 3 platforms. Use exact limits from research:
   - `line`: headline 20, body 60, cta 15, hashtags 0
   - `yahoo_japan`: headline 15, body 39, cta 15, hashtags 0
   - `rakuten`: headline 30, body 87, cta 15, hashtags 0
   - `instagram`: headline 30, body 125, cta 20, hashtags 3-5 required
   - `tiktok`: headline 25, body 100, cta 15, hashtags 1-3 required
   - `x`: headline 25, body 280, cta 15, hashtags 1-3 required
   - `email`: headline 50, body 500, cta 20, hashtags 0
   - Use Japanese labels (e.g., "タイトル", "テキスト", "件名") matching research

3. **`countJapaneseChars(str: string): number`** -- use `[...str].length` for accurate codepoint counting (NOT `.length` which double-counts surrogates)

4. **`validateCopyLength(text: string, maxChars: number): { valid: boolean; actual: number; truncated?: string }`** -- validates character count, returns truncated string with "..." suffix if over limit (truncate to maxChars - 1 then append "...")

5. **`getConstraintsForPlatforms(platformIds: string[]): PlatformCopyConstraints[]`** -- filter registry by platform IDs, return array. Skip unknown platform IDs silently.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors in the new file. Verify the module exports by checking imports resolve.
  </verify>
  <done>
copy-constraints.ts exports PLATFORM_COPY_CONSTRAINTS with 7 platform entries, countJapaneseChars, validateCopyLength, and getConstraintsForPlatforms. Character counting uses [...str].length.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade Claude copy generation to platform-aware output</name>
  <files>src/lib/ai/prompts/copy-generation.ts, src/lib/ai/claude.ts</files>
  <action>
**In `src/lib/ai/prompts/copy-generation.ts`**, add a new function `buildPlatformCopyPrompt()`:

1. Accept `brief: CampaignBrief`, `brand: BrandProfileForPrompt`, `constraints: PlatformCopyConstraints[]`
2. Build a prompt that instructs Claude to generate 4 variants PER PLATFORM
3. Include explicit character limits from constraints in the prompt text -- e.g., "LINEタイトル: 最大20文字, テキスト: 最大60文字"
4. Reuse the existing `REGISTER_INSTRUCTIONS` and `OBJECTIVE_LABELS`
5. Instruct Claude to use `deliver_platform_copy` tool (new name) to return results
6. Keep the existing `buildCopyPrompt` and `buildSystemPrompt` functions intact (backward compatible)

**In `src/lib/ai/claude.ts`**, add:

1. **New types:**
   ```typescript
   export interface PlatformCopyVariant {
     headline: string
     body: string
     cta: string
     hashtags: string[]
   }
   export interface PlatformCopyResult {
     platforms: Array<{
       platformId: string
       variants: PlatformCopyVariant[]
     }>
   }
   ```

2. **New tool schema `DELIVER_PLATFORM_COPY_TOOL`:**
   - `name: "deliver_platform_copy"`
   - Input schema: `{ platforms: [{ platformId: string, variants: [{ headline, body, cta, hashtags }] }] }`
   - Each platform's variants array: minItems 4, maxItems 4

3. **New function `generatePlatformCopy(brief, brandProfile, platformIds)`:**
   - Import `PLATFORM_COPY_CONSTRAINTS` and `getConstraintsForPlatforms` from copy-constraints.ts
   - Build system prompt using existing `buildSystemPrompt`
   - Build user prompt using new `buildPlatformCopyPrompt` with constraints for the selected platforms
   - Use `max_tokens: 8192` (more tokens needed for multi-platform output)
   - Use the new `DELIVER_PLATFORM_COPY_TOOL` with tool_choice forced
   - Parse response, validate each platform has exactly 4 variants
   - Apply `validateCopyLength` from copy-constraints.ts to each field as a server-side safety net -- log warnings for over-limit fields but don't reject (truncate with "..." as fallback)
   - Return `PlatformCopyResult`

4. Keep the existing `generateCopy()` function intact (backward compatible)

**Important:** The single Claude API call generates variants for ALL selected platforms at once. This is the research recommendation for cost efficiency. If the brief has 7 platforms, that's 28 variants in one call.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Both the old `generateCopy` and new `generatePlatformCopy` functions exist.
  </verify>
  <done>
generatePlatformCopy() generates platform-specific copy via a single Claude API call with per-platform character limits. Server-side validation truncates over-limit fields as safety net. Old generateCopy() remains for backward compatibility.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `PLATFORM_COPY_CONSTRAINTS` has entries for all 7 Phase 3 platforms: line, yahoo_japan, rakuten, instagram, tiktok, x, email
3. `countJapaneseChars` uses `[...str].length` (grep for the pattern)
4. `generatePlatformCopy` function exists and imports from copy-constraints.ts
5. Old `generateCopy` function still exists (backward compat)
</verification>

<success_criteria>
- Platform copy constraints registry created with character limits for 7 platforms
- Claude copy generation upgraded to produce per-platform variants in a single API call
- Server-side character limit validation with truncation fallback
- Backward compatible -- existing generateCopy still works
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-platform-formatting/03-01-SUMMARY.md`
</output>
