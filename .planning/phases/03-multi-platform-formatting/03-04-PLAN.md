---
phase: 03-multi-platform-formatting
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - src/components/campaign/platform-grid-view.tsx
  - src/components/campaign/platform-asset-card.tsx
  - src/components/campaign/download-button.tsx
  - src/components/campaign/campaign-detail-client.tsx
autonomous: true

must_haves:
  truths:
    - "User can see all generated assets organized by platform in a grid view"
    - "Each platform section shows dimension badges and image previews at correct aspect ratios"
    - "User can download the complete campaign kit as a ZIP with one click"
    - "Download button shows progress state and handles errors gracefully"
  artifacts:
    - path: "src/components/campaign/platform-grid-view.tsx"
      provides: "Grid view component showing assets grouped by platform with dimension badges"
      exports: ["PlatformGridView"]
    - path: "src/components/campaign/platform-asset-card.tsx"
      provides: "Individual platform asset card with dimension badge and preview"
      exports: ["PlatformAssetCard"]
    - path: "src/components/campaign/download-button.tsx"
      provides: "Download button component that triggers ZIP download"
      exports: ["DownloadButton"]
  key_links:
    - from: "src/components/campaign/platform-grid-view.tsx"
      to: "src/lib/constants/platforms.ts"
      via: "import getPlatformById for platform names and icons"
      pattern: "getPlatformById|PLATFORMS"
    - from: "src/components/campaign/download-button.tsx"
      to: "/api/campaigns/[id]/download"
      via: "fetch to download endpoint"
      pattern: "api/campaigns.*download"
    - from: "src/components/campaign/campaign-detail-client.tsx"
      to: "src/components/campaign/platform-grid-view.tsx"
      via: "import PlatformGridView as new tab"
      pattern: "PlatformGridView"
---

<objective>
Build the platform grid view UI for reviewing generated assets by platform and the download button for campaign kit delivery.

Purpose: Requirements WORK-04 (grid view with platform-dimension preview) and WORK-08 (download campaign kit as ZIP). The user needs to see all platform variants organized visually and download them with one click.
Output: Platform grid view component, asset cards with dimension badges, functional download button.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-platform-formatting/03-RESEARCH.md

@src/components/campaign/image-tab.tsx
@src/components/campaign/copy-tab.tsx
@src/lib/constants/platforms.ts
@src/lib/db/schema.ts

# Prior plan outputs needed
@.planning/phases/03-multi-platform-formatting/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build platform grid view and asset card components</name>
  <files>src/components/campaign/platform-grid-view.tsx, src/components/campaign/platform-asset-card.tsx</files>
  <action>
**Create `src/components/campaign/platform-asset-card.tsx`:**

1. "use client" component
2. Props: `{ asset: Asset, platformName: string, dimensionLabel: string }` where Asset matches the existing interface from image-tab.tsx
3. Display:
   - Image preview with `object-cover` in a container that matches the asset's aspect ratio (use CSS aspect-ratio property based on width/height)
   - Dimension badge overlay: top-left corner, show "{width}x{height}" in a small pill badge
   - Platform dimension label below image (e.g., "フィード", "リッチメッセージ")
   - Hover overlay with download button (same pattern as image-tab.tsx hover)
   - For extreme aspect ratios (e.g., 728x90), constrain the card height to prevent absurdly tall/short cards -- use `max-h-[200px]` and center the image within
4. Use Tailwind classes consistent with existing design system (bg-bg-card, border-border-subtle, text-text-primary etc.)
5. Individual asset download: anchor tag with `download` attribute pointing to asset.storageKey

**Create `src/components/campaign/platform-grid-view.tsx`:**

1. "use client" component
2. Props: `{ assets: Asset[], copyVariants: CopyVariant[] }` -- receives all campaign assets and copy
3. Group assets by platform:
   - Filter for `type === "platform_image"` assets
   - Read `metadata.platform` to determine platform grouping
   - Also include `type === "email_html"` assets in the email section
4. For each platform that has assets:
   - Section header: platform icon (from Lucide, using getPlatformById) + Japanese platform name + asset count badge
   - Grid of PlatformAssetCard components (responsive: 2 cols on mobile, 3-4 cols on desktop)
   - Below the image grid, show copy for that platform -- collapsed by default, expandable
     - Show all 4 variants (A案-D案) with headline, body, CTA, hashtags
     - Use a disclosure/accordion pattern (simple useState toggle)
5. If no platform_image assets exist, show an empty state message: "プラットフォーム別のアセットはまだ生成されていません"
6. Add a "要調整" (needs adjustment) warning badge on assets where the source-to-target aspect ratio difference is > 3x (extreme ratios). Calculate from metadata or from width/height compared to source composited image. This alerts users that 728x90 or 160x600 variants may need manual adjustment.
7. Use Lucide icons imported via the existing icon mapping pattern (getPlatformById returns icon name string, map to Lucide component)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Both components export their named exports.
  </verify>
  <done>
Platform grid view groups assets by platform with icons, dimension badges, copy sections, and extreme-ratio warning badges. Asset cards show dimension-accurate previews with download capability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build download button and integrate grid view into campaign detail page</name>
  <files>src/components/campaign/download-button.tsx, src/components/campaign/campaign-detail-client.tsx</files>
  <action>
**Create `src/components/campaign/download-button.tsx`:**

1. "use client" component
2. Props: `{ campaignId: string, disabled?: boolean }`
3. States: idle | downloading | success | error
4. On click:
   - Set state to "downloading"
   - Fetch `/api/campaigns/${campaignId}/download` with `credentials: "include"`
   - On success: create a Blob from response, create object URL, trigger download via hidden anchor
   - On success: set state to "success", revert to "idle" after 3 seconds
   - On error: set state to "error", show toast via sonner (`toast.error("ダウンロードに失敗しました")`)
   - Revert to "idle" after 3 seconds on error
5. Button states visual:
   - idle: "キャンペーンキットをダウンロード" with Download icon
   - downloading: spinner icon + "ダウンロード中..." (disabled)
   - success: CheckCircle icon + "完了" (green tint)
   - error: "再試行" with AlertCircle icon
6. Use the existing Button component from `@/components/ui/button` with appropriate variant
7. Full-width styling to match campaign sidebar layout

**Integrate into campaign detail page:**

Find the campaign detail client component (check the actual file path -- it may be at `src/app/(dashboard)/campaigns/[id]/page.tsx` or similar). The file that renders the Tabs with "コピー" and "画像" tabs.

1. Import `PlatformGridView` and `DownloadButton`
2. Add a third tab to the existing Tabs component: "プラットフォーム" (value: "platforms")
   - Render `<PlatformGridView assets={assets} copyVariants={copyVariants} />`
3. Add the `DownloadButton` component in the campaign sidebar area (the sidebar component or the detail page layout)
   - Only show when campaign status is "complete"
   - Pass `campaignId` prop
4. If the campaign detail page uses a Server Component -> Client Component pattern (it does per 01-05 decision), add `PlatformGridView` to the Client Component that receives the data

**Important:** Check the actual file name of the campaign detail client component by looking at the project structure. The planning context mentions "Server-then-Client pattern" from 01-05. Find and modify the correct file.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify the "プラットフォーム" tab exists in the campaign detail page. Verify DownloadButton is rendered in the sidebar area.
  </verify>
  <done>
Download button triggers ZIP download with progress states and error handling via sonner toast. Platform grid view tab added to campaign detail page alongside copy and image tabs. Download button visible in sidebar when campaign is complete.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Campaign detail page has 3 tabs: コピー, 画像, プラットフォーム
3. Platform grid view groups assets by platform with icons and dimension badges
4. Download button triggers ZIP download from `/api/campaigns/[id]/download`
5. Extreme-ratio assets show "要調整" warning badge
6. Download button only appears when campaign status is "complete"
</verification>

<success_criteria>
- User can see all platform assets grouped by platform in a dedicated tab
- Each asset shows its dimensions and platform label
- Extreme aspect ratio assets are flagged with a warning
- User can download the complete campaign kit as a ZIP with one click
- Download shows progress and handles errors gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-platform-formatting/03-04-SUMMARY.md`
</output>
