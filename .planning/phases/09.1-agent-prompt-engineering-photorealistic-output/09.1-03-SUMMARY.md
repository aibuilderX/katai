---
phase: 09.1-agent-prompt-engineering-photorealistic-output
plan: 03
subsystem: ai, prompts
tags: [copywriter, jp-localization, japanese-copy, keigo, register-map, platform-norms, critique-loop, tool-use]

# Dependency graph
requires:
  - phase: 09.1-agent-prompt-engineering-photorealistic-output
    plan: 01
    provides: "Shared data modules (frameworks, register-map, platform-norms), AgentPromptBuilder types, expanded pipeline types"
provides:
  - "Copywriter agent prompt builder: system prompt, user message builder, tool schema with rationaleNotes"
  - "JP Localization agent prompt builder: system prompt, initial review message, revision message with critique history, tool schema with structured issues"
  - "Register-by-category integration (8 categories) into Copywriter system prompt"
  - "Platform norms integration (LINE/Instagram/X) into Copywriter system prompt"
  - "5-criteria weighted evaluation rubric for JP Localization (naturalness 30%, register 25%, persuasiveness 20%, cultural 15%, platform 10%)"
  - "Critique loop support via revision message builder with full critique history"
affects: [09.1-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "XML-tagged prompt sections via buildPromptFromSections for Copywriter and JP Localization"
    - "Few-shot examples in tool-use output format (2 per agent, diverse registers and outcomes)"
    - "Revision message builder pattern for critique loop with full history and attempt tracking"
    - "Weighted evaluation rubric baked into system prompt with scoring guidance"

key-files:
  created:
    - "src/lib/ai/prompts/agents/copywriter.ts"
    - "src/lib/ai/prompts/agents/jp-localization.ts"
  modified: []

key-decisions:
  - "System prompts in English, output in Japanese per research recommendation (Claude's strongest reasoning in English, 96.9% relative performance in Japanese)"
  - "Register instructions preserved from existing copy-generation.ts with all three register levels (casual/standard/formal) including Japanese examples"
  - "Max 5 issues per JP Localization review to avoid overwhelming the Copywriter revision pass"
  - "Final revision attempt (attempt 2) auto-approves with best available version to prevent pipeline stall"
  - "Compliance flagging is lightweight (string flags only, no rewrites) per Phase 12 boundary"

patterns-established:
  - "Agent prompt builder pattern: buildSystemPrompt + buildUserMessage + TOOL_SCHEMA constant"
  - "Critique loop message pattern: initial review message + revision message with history"
  - "CritiqueHistoryEntry type for tracking multi-attempt critique loop state"

requirements-completed: [ORCH-06, ORCH-08]

# Metrics
duration: 5min
completed: 2026-02-19
---

# Phase 9.1 Plan 03: Copywriter and JP Localization Agent Prompt Builders Summary

**Japanese-native Copywriter prompt with 8-category register map and platform norms, plus JP Localization quality gate with 5-criteria weighted evaluation rubric, structured critique loop, and compliance flagging**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-19T08:01:37Z
- **Completed:** 2026-02-19T08:07:30Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Created Copywriter agent prompt builder with Japanese-native copy generation (not translated from English), 8-category register-by-category mapping, LINE/Instagram/X platform norms, all 5 copywriting frameworks (PAS/AIDA/BAB/AIDMA/AISAS), and 2 few-shot examples demonstrating different registers
- Created JP Localization agent prompt builder with 5 weighted evaluation criteria (naturalness 30%, register 25%, persuasiveness 20%, cultural 15%, platform 10%), structured field-level critique format, common LLM Japanese copy error detection guide, compliance flagging, and critique loop revision message builder
- Both agents use tool-use for guaranteed structured output with detailed schemas matching CopywriterOutput and JpLocalizationOutput pipeline types

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Copywriter agent prompt builder with register-by-category and platform norms** - `1e043fe` (feat)
2. **Task 2: Create JP Localization agent prompt builder with structured critique and revision message** - `22f6f49` (feat)

## Files Created/Modified
- `src/lib/ai/prompts/agents/copywriter.ts` - Copywriter system prompt builder (register map, platform norms, 5 frameworks, few-shot examples), user message builder, deliver_platform_copy tool schema with rationaleNotes
- `src/lib/ai/prompts/agents/jp-localization.ts` - JP Localization system prompt builder (5 weighted criteria, common LLM errors guide, compliance flagging), initial review message builder, revision message builder with critique history, deliver_localization_review tool schema with structured issues

## Decisions Made
- **System prompts in English, output in Japanese:** Research confirms Claude reasons best in English (96.9% relative Japanese performance). System prompts are English; all copy output and evaluation feedback is in Japanese.
- **Register instructions preserved from v1.0:** The existing REGISTER_INSTRUCTIONS from copy-generation.ts are valuable and proven. Preserved them in the new Copywriter prompt for continuity.
- **Max 5 issues per review:** Research finding that LLMs struggle to address more than ~5 issues in a single revision pass. JP Localization prioritizes by severity.
- **Auto-approve on final attempt:** If quality is still below threshold after 2 revision attempts, JP Localization approves with best available version and notes remaining issues. Prevents pipeline stall.
- **Lightweight compliance flagging only:** JP Localization flags obvious violations (e.g., 薬機法) as string flags but does NOT rewrite. Phase 12 handles full compliance review. This reduces false positives and keeps JP Localization focused on linguistic quality.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Copywriter and JP Localization prompt builders are complete and importable — Plan 05 (evaluation) can test both agents
- The critique loop is fully supported: JP Localization initial review + revision message with history feeds back to Copywriter for targeted fixes
- Both tool schemas match the updated CopywriterOutput and JpLocalizationOutput pipeline types from Plan 01
- Plan 04 (Art Director meta-prompt) can proceed independently as it has no dependency on this plan

## Self-Check: PASSED

All 2 files verified present. Both task commits (1e043fe, 22f6f49) verified in git log.

---
*Phase: 09.1-agent-prompt-engineering-photorealistic-output*
*Completed: 2026-02-19*
