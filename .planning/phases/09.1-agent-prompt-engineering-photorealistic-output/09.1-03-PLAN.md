---
phase: 09.1-agent-prompt-engineering-photorealistic-output
plan: 03
type: execute
wave: 2
depends_on: [09.1-01]
files_modified:
  - src/lib/ai/prompts/agents/copywriter.ts
  - src/lib/ai/prompts/agents/jp-localization.ts
autonomous: true
requirements: [ORCH-06, ORCH-08]

must_haves:
  truths:
    - "Copywriter prompt generates Japanese copy directly in Japanese (not via English intermediate) with register determined by product category from the register map"
    - "Copywriter output includes rationale notes per variant explaining register choice, CTA style, and key word decisions"
    - "Copywriter prompt includes platform-specific norms for LINE (soft CTA, short messages), Instagram (longer captions, hashtag culture), and X (140 chars, trend-riding)"
    - "JP Localization prompt evaluates copy against 5 weighted criteria: naturalness 30%, register consistency 25%, persuasiveness 20%, cultural resonance 15%, platform fit 10%"
    - "JP Localization critique format includes field-level issues with specific suggestions (not vague feedback)"
    - "JP Localization includes lightweight compliance flagging for obvious violations without attempting rewrites"
    - "Both prompts use tool-use for forced structured output"
  artifacts:
    - path: "src/lib/ai/prompts/agents/copywriter.ts"
      provides: "System prompt builder, user message builder, and tool schema for Copywriter agent"
      exports: ["buildCopywriterSystemPrompt", "buildCopywriterUserMessage", "COPYWRITER_TOOL_SCHEMA"]
    - path: "src/lib/ai/prompts/agents/jp-localization.ts"
      provides: "System prompt builder, user message builder (initial + revision), and tool schema for JP Localization agent"
      exports: ["buildJpLocalizationSystemPrompt", "buildJpLocalizationUserMessage", "buildJpLocalizationRevisionMessage", "JP_LOCALIZATION_TOOL_SCHEMA"]
  key_links:
    - from: "src/lib/ai/prompts/agents/copywriter.ts"
      to: "src/lib/ai/prompts/shared/register-map.ts"
      via: "Imports REGISTER_BY_CATEGORY and getRegisterForCategory"
      pattern: "import.*from.*shared/register-map"
    - from: "src/lib/ai/prompts/agents/copywriter.ts"
      to: "src/lib/ai/prompts/shared/platform-norms.ts"
      via: "Imports PLATFORM_NORMS for platform-specific instructions"
      pattern: "import.*from.*shared/platform-norms"
    - from: "src/lib/ai/prompts/agents/jp-localization.ts"
      to: "src/types/pipeline.ts"
      via: "Tool schema matches updated JpLocalizationOutput with structured issues"
      pattern: "JpLocalizationOutput.*issues.*complianceFlags"
    - from: "JP Localization critique output"
      to: "Copywriter revision input"
      via: "buildJpLocalizationRevisionMessage passes critique history to Copywriter for targeted fixes"
      pattern: "critiqueHistory.*attemptNumber"
---

<objective>
Create the Copywriter and JP Localization agent prompt builders with Japanese-native copy generation, register-by-category mapping, platform-specific norms, and structured critique loop feedback.

Purpose: The Copywriter produces Japanese advertising copy directly in Japanese (not translated) using the upstream strategic framework and platform norms. JP Localization acts as the quality gate with structured, field-level critique that the Copywriter can act on precisely. Together they form the critique loop that ensures copy quality.

Output: 2 prompt builder modules with system prompts, user message builders, tool schemas, and revision message builder for the critique loop.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-CONTEXT.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-RESEARCH.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-01-SUMMARY.md
@src/types/pipeline.ts
@src/lib/ai/prompts/shared/register-map.ts
@src/lib/ai/prompts/shared/platform-norms.ts
@src/lib/ai/prompts/shared/frameworks.ts
@src/lib/ai/prompts/copy-generation.ts
@src/lib/platforms/copy-constraints.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Copywriter agent prompt builder with register-by-category and platform norms</name>
  <files>
    src/lib/ai/prompts/agents/copywriter.ts
  </files>
  <action>
Create `src/lib/ai/prompts/agents/copywriter.ts` with three exports. This REPLACES the naive prompts in `src/lib/ai/prompts/copy-generation.ts` for the v1.1 pipeline (the existing file is preserved for v1.0 backward compatibility).

**1. `buildCopywriterSystemPrompt(productCategory: string)` — Returns the system prompt string.**

XML-tagged structure with these sections:

SECTION [role]: "You are a professional Japanese advertising copywriter (日本の広告コピーライター). You write copy directly in Japanese — never translating from English. Your copy reads naturally to native Japanese speakers and follows Japanese advertising conventions for each platform."

SECTION [knowledge]: Embed from shared imports:
- Japanese Writing System Rules (from existing copy-generation.ts — preserve these): 漢字 for nouns/verb stems, ひらがな for particles/inflections, カタカナ for loanwords/emphasis, 5-7 mora rhythm for headlines
- Register System: Embed REGISTER_BY_CATEGORY for the specific product category — include full register instructions (casual/standard/formal) with Japanese examples from existing REGISTER_INSTRUCTIONS
- Platform Conventions: Embed PLATFORM_NORMS for LINE, Instagram, X — tone, format, CTA style, character limits, key insight
- Copywriting Framework Application: PAS (problem-agitate-solution), AIDA (attention-interest-desire-action), BAB (before-after-bridge), AIDMA (attention-interest-desire-memory-action), AISAS (attention-interest-search-action-share)

SECTION [task]: "Generate Japanese advertising copy for each target platform with headline, body, CTA, hashtags. Apply upstream framework. Each variant takes a different angle. Include rationale notes. Write ALL copy directly in Japanese."

SECTION [constraints]:
- Register consistency: ALL variants for a platform use the SAME register — no mixing
- Register selection: use category default unless brief has registerOverride
- Character limits: strictly obey platform-specific limits (LINE title ~20 chars, body ~50; X post 140 chars)
- Hashtag rules: Japanese + English mix, 3-5 per platform where appropriate, none for LINE
- CTA style: Follow platform norms (LINE: soft, X: engagement-focused, Instagram: engagement CTAs)
- Tri-script mixing: natural balance — avoid all-katakana or all-kanji
- 4 variants per platform (A through D) with diverse approaches
- Each variant includes rationaleNotes (English) explaining register choice, CTA style, key words, framework

SECTION [output_format]: "Use the deliver_platform_copy tool to return your copy. Each variant must include rationaleNotes."

Add 2 few-shot examples per research recommendation:
- Example A: Standard register for a cosmetics brand on Instagram — 1 variant showing formal-leaning standard with aspirational CTA
- Example B: Casual register for a food brand on LINE — 1 variant showing warm conversational tone with soft CTA

Each example shows the complete tool-use output format including rationaleNotes.

**2. `buildCopywriterUserMessage(creativeDirection, strategicInsight, brief, brandProfile, platformConstraints)` — Returns user message.**

Format as XML-tagged sections:
- [creative_direction] section: Concept, Copy Direction, Mood keywords, Platform Adaptations (from creativeDirection)
- [strategy] section: Framework, Framework Rationale, Awareness Level, Key Messages, Tonal Guidance, Target Insight (from strategicInsight)
- [brief] section: Brand name, Product info, Audience, Objective, Register Override
- [platform_constraints] section: For each platform, embed copy-constraints character limits
- Instruction: "Generate 4 copy variants per platform. Apply the {framework} framework. Use {register} register throughout."

**3. `COPYWRITER_TOOL_SCHEMA` — Tool schema matching updated CopywriterOutput.**

Schema for deliver_platform_copy tool:
- `variants`: array of objects with:
  - `platform`: string (required)
  - `variantLabel`: string (required, "A案" through "D案")
  - `headline`: string (required)
  - `body`: string (required)
  - `cta`: string (required)
  - `hashtags`: array of strings
  - `register`: string (required)
  - `rationaleNotes`: string (required, minLength: 20, English explanation of creative decisions)
  </action>
  <verify>
Run `npx tsc --noEmit src/lib/ai/prompts/agents/copywriter.ts` — no type errors. Verify the module imports from shared/register-map.ts and shared/platform-norms.ts. Verify the system prompt includes register instructions (casual/standard/formal with Japanese examples), platform norms for LINE/Instagram/X, and all 5 copywriting frameworks. Verify tool schema includes rationaleNotes field.
  </verify>
  <done>
Copywriter prompt builder exists with Japanese-native copy generation instructions, register-by-category mapping (8 categories), platform-specific norms (LINE/Instagram/X), 5 copywriting framework application guidance, 2 few-shot examples (different registers), and tool schema with rationaleNotes. System prompt is English; output is Japanese.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JP Localization agent prompt builder with structured critique and revision message</name>
  <files>
    src/lib/ai/prompts/agents/jp-localization.ts
  </files>
  <action>
Create `src/lib/ai/prompts/agents/jp-localization.ts` with four exports:

**1. `buildJpLocalizationSystemPrompt()` — Returns the system prompt string.**

XML-tagged structure with these sections:

SECTION [role]: "You are a Japanese advertising copy quality evaluator (日本語広告コピー品質評価者). You review Japanese advertising copy for naturalness, register consistency, persuasiveness, cultural resonance, and platform fit. You have veto power — if copy does not meet quality standards, you reject it with specific, actionable feedback."

SECTION [knowledge]: Embed evaluation criteria (weighted):
1. Naturalness (自然さ) — 30%: native Japanese reading, not translationese. Check: word order, idiom translations, particle usage
2. Register Consistency (敬語一貫性) — 25%: consistent keigo throughout. Check: mixing casual/formal, verb endings, honorific usage
3. Persuasiveness (説得力) — 20%: motivates target action. Check: CTA strength, value proposition clarity, emotional hook
4. Cultural Resonance (文化的適合性) — 15%: respects Japanese conventions. Check: indirectness, seasonal awareness, trust signals
5. Platform Fit (プラットフォーム適合性) — 10%: matches platform conventions. Check: length, hashtags, CTA style
Also embed common LLM Japanese copy errors: translationese (翻訳調), particle errors (は/が distinction), unnatural keigo mixing, Western CTA patterns, over-formal language, katakana overuse

SECTION [task]: "Review all copy variants. For each issue: 1) identify location (platform, variant, field), 2) categorize, 3) explain problem in Japanese, 4) provide specific fix in Japanese, 5) rate severity. Approve if score >= 70 and no critical issues. Reject if score < 70 or critical issues exist. Focus on 3-5 most impactful issues."

SECTION [constraints]:
- Issues must be specific with exact field-level location
- Suggestions must be concrete Japanese fixes, not descriptions
- Quality score: 0-100 weighted. 70+ acceptable, 85+ excellent
- Max 5 issues per review (prioritize by severity)
- Compliance flags: flag obvious violations (e.g., 肌荒れを治す = 薬機法) but do NOT rewrite — Phase 12 handles compliance
- overallNote: Japanese summary feedback, 1-2 sentences
- summaryJa: ~10 word Japanese summary

SECTION [output_format]: "Use the deliver_localization_review tool to return your evaluation."

Add 2 few-shot examples per research recommendation:
- Example A: Approval case — quality score 85, 2 minor issues noted, approved: true
- Example B: Rejection case — quality score 55, 2 critical issues (register mixing, translationese), approved: false, with specific fixes

**2. `buildJpLocalizationUserMessage(copywriterOutput, strategicInsight, brief)` — Returns the user message for initial review.**

Format as XML-tagged sections:
- [copy_to_review] section: For each variant in copywriterOutput.variants, include Platform, Variant label, Register, Headline, Body, CTA, Hashtags, Rationale
- [context] section: Expected Register (from tonal guidance), Framework, Target Audience, Platforms
- Instruction: "Review all copy variants and deliver your quality evaluation."

**3. `buildJpLocalizationRevisionMessage(copywriterOutput, critiqueHistory, attemptNumber)` — Returns message for re-review after Copywriter revision.**

Format as XML-tagged sections:
- [revised_copy] section: Same format as initial review, but with the revised variants
- [critique_history] section: For each previous critique in critiqueHistory, include Attempt number, Quality Score, Issues formatted, Overall Note
- [revision_context] section: "This is revision attempt {attemptNumber} of max 2. Previous issues have been addressed by the Copywriter. Review the revised copy — check that previous issues are fixed and no new issues introduced. If this is attempt 2 and quality is still below threshold, approve with the best available version and note remaining issues in overallNote."

**4. `JP_LOCALIZATION_TOOL_SCHEMA` — Tool schema matching updated JpLocalizationOutput.**

Schema for deliver_localization_review tool:
- `approved`: boolean (required)
- `qualityScore`: number (required, 0-100)
- `issues`: array of objects:
  - `platform`: string
  - `variant`: string
  - `field`: enum ["headline", "body", "cta", "hashtags"]
  - `category`: enum ["naturalness", "register", "persuasiveness", "cultural", "platform"]
  - `issue`: string (the specific problem, in Japanese)
  - `suggestion`: string (the specific fix, in Japanese)
  - `severity`: enum ["critical", "moderate", "minor"]
- `complianceFlags`: array of strings (optional)
- `overallNote`: string (required, in Japanese)
- `summaryJa`: string (required)
- `revisionsApplied`: number (required)
- `localizationNotes`: string (required)
  </action>
  <verify>
Run `npx tsc --noEmit src/lib/ai/prompts/agents/jp-localization.ts` — no type errors. Verify the module exports all 4 items. Verify the system prompt includes all 5 weighted evaluation criteria. Verify the revision message builder accepts critique history. Verify the tool schema includes the structured issues array with field-level specificity.
  </verify>
  <done>
JP Localization prompt builder exists with 5 weighted evaluation criteria (naturalness 30%, register 25%, persuasiveness 20%, cultural 15%, platform 10%), structured critique format with field-level issues and specific Japanese suggestions, compliance flagging without rewrite, 2 few-shot examples (approval + rejection), initial review message builder, revision message builder with critique history for the critique loop, and tool schema enforcing structured output.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for both files
- Copywriter imports from shared/register-map.ts and shared/platform-norms.ts
- Copywriter system prompt generates Japanese directly (not translated from English)
- Copywriter tool schema includes rationaleNotes per variant
- JP Localization includes all 5 weighted evaluation criteria
- JP Localization tool schema has structured issues array with severity levels
- JP Localization has both initial and revision message builders
- JP Localization revision message includes full critique history
- Neither prompt contains anti-laziness language
</verification>

<success_criteria>
- Copywriter produces platform-optimized Japanese copy with correct register per category
- JP Localization provides specific, actionable feedback that Copywriter can act on
- Critique loop is supported by revision message builder with history
- Both agents use tool-use for guaranteed structured output
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-03-SUMMARY.md`
</output>
