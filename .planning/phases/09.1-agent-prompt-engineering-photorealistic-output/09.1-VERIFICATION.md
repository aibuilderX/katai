---
phase: 09.1-agent-prompt-engineering-photorealistic-output
verified: 2026-02-19T10:00:00Z
status: passed
score: 25/25 must-haves verified
re_verification: false
gaps: []
human_verification:
  - test: "Run an actual campaign brief through the full 5-agent pipeline and evaluate outputs against the rubrics"
    expected: "Optimized prompts should score >= 0.5 points higher than naive prompts per dimension across STANDARD_TEST_BRIEFS"
    why_human: "Requires live Claude API calls with both optimized and naive prompt builders, and human scoring against rubrics"
  - test: "Send a brief through Art Director and inspect Flux image output for photorealistic skin quality"
    expected: "Images show visible pores, subsurface scattering, candid expressions, natural lighting — not 'AI-smooth' porcelain skin"
    why_human: "Image quality and photorealism require visual assessment; cannot grep for pixels"
  - test: "Evaluate JP Localization critique on Copywriter output for a real brief (e.g., standard-cosmetics)"
    expected: "Critique identifies field-level issues with exact Japanese suggestions — not vague feedback"
    why_human: "Requires live Japanese language quality assessment against the 5 weighted criteria"
---

# Phase 9.1: Agent Prompt Engineering / Photorealistic Output Verification Report

**Phase Goal:** Each of the 5 pipeline agents (Strategic Insight, Creative Director, Copywriter, Art Director, JP Localization) operates with research-backed, battle-tested prompts that extract maximum quality from Claude and Flux — with Art Director producing ultra-realistic photographic characters (skin imperfections, subsurface scattering, natural lighting) and all agents demonstrating measurably superior output compared to naive prompting.

**Verified:** 2026-02-19T10:00:00Z
**Status:** PASSED (with human verification recommended)
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Shared framework definitions (Schwartz 5, LF8 8, 3 Japanese nuances, 5 frameworks) are importable by all agent prompt builders | VERIFIED | `frameworks.ts` exports all 4 constants; Strategic Insight imports all 4; Copywriter imports `COPYWRITING_FRAMEWORKS`; TypeScript compiles cleanly |
| 2 | Register-by-category mapping covers 8 product categories with recommended keigo levels | VERIFIED | `register-map.ts` exports `REGISTER_BY_CATEGORY` with exactly 8 categories (cosmetics, food, fashion, personal_service, online_course, tech, luxury, kids_family) + `getRegisterForCategory` helper |
| 3 | Platform norms data covers LINE, Instagram, and X with Japanese-specific conventions | VERIFIED | `platform-norms.ts` exports `PLATFORM_NORMS` with all 3 platforms; each entry has tone, format, ctaStyle, characterLimits, hashtagStrategy, keyInsight, keyInsightJa |
| 4 | Flux technique data includes camera/lens database by category, photorealism keyword stack, and skin realism anti-pattern counters | VERIFIED | `flux-techniques.ts` exports `CAMERA_LENS_DATABASE` (5 categories), `PHOTOREALISM_KEYWORDS` (exact spec string), `SKIN_REALISM_COUNTERS` (5 anti-patterns), `FLUX_CONFIG` |
| 5 | Agent config maps each agent to temperature, effort, and model defaults per ORCH-14 tiered assignment | VERIFIED | `agent-config.ts` exports `AGENT_CONFIG` with all 5 agents; temperature gradient 0.2/0.5/0.7; modelTier: opus for strategicInsight/creativeDirector/jpLocalization, sonnet for copywriter/artDirector |
| 6 | Pipeline output types are expanded with confidence scores, rationale fields, and framework-specific labels | VERIFIED | `pipeline.ts` has `awarenessConfidence`, `frameworkRationale`, `japaneseDesireNuance`, `summaryJa`, typed `copywritingFramework` union (PAS/AIDA/BAB/AIDMA/AISAS), typed `awarenessLevel` union; `negativePrompt` removed; `cameraLens`, `lightingSetup`, `compositionGuidance` added to ArtDirectorOutput |
| 7 | Strategic Insight prompt builder produces XML-tagged system prompt with Schwartz, LF8, 5 copywriting frameworks, and confidence scores | VERIFIED | `strategic-insight.ts` `buildStrategicInsightSystemPrompt()` calls `buildKnowledgeSection()` which embeds all framework data from imports; tool schema requires all confidence enums |
| 8 | Strategic Insight always infers confidently from sparse input — pipeline never stalls | VERIFIED | Constraint section: "Classification must be decisive — never output 'unclear' or 'need more info'"; task section: "Always infer confidently. If the brief is vague, make reasonable assumptions..." |
| 9 | Strategic Insight tool schema enforces output completeness (ORCH-09 quality gate) | VERIFIED | `STRATEGIC_INSIGHT_TOOL_SCHEMA` has 12 required fields; all confidence enums; `frameworkRationale` with minLength:20; `keyMessages` with minItems:2/maxItems:4; `primaryDesires` with minItems:1/maxItems:3 |
| 10 | Creative Director generates structured creative briefs with mode-dependent behavior | VERIFIED | `creative-director.ts` exports `CREATIVE_DIRECTOR_TOOL_SCHEMA_AUTO` (single concept) and `CREATIVE_DIRECTOR_TOOL_SCHEMA_PRO` (array with minItems:2/maxItems:3) + `getCreativeDirectorToolSchema(mode)` selector |
| 11 | Copywriter generates Japanese copy directly in Japanese with register from category map | VERIFIED | `copywriter.ts` imports `REGISTER_BY_CATEGORY` and `getRegisterForCategory`; system prompt role says "write copy directly in Japanese — never translating from English"; includes `REGISTER_INSTRUCTIONS` for all 3 levels with Japanese examples |
| 12 | Copywriter output includes rationale notes per variant | VERIFIED | `COPYWRITER_TOOL_SCHEMA` requires `rationaleNotes: string` with minLength:20 for every variant |
| 13 | Copywriter prompt includes platform-specific norms for LINE, Instagram, and X | VERIFIED | `copywriter.ts` imports `PLATFORM_NORMS`; constraint section specifies per-platform character limits, CTA styles, hashtag rules |
| 14 | JP Localization evaluates copy against 5 weighted criteria (naturalness 30%, register 25%, persuasiveness 20%, cultural 15%, platform 10%) | VERIFIED | `jp-localization.ts` knowledge section has all 5 criteria with exact weights, scoring points per criterion, and check items |
| 15 | JP Localization critique includes field-level issues with specific suggestions | VERIFIED | `JP_LOCALIZATION_TOOL_SCHEMA` issues array requires: platform, variant, field (enum), category (enum), issue (Japanese), suggestion (Japanese), severity (critical/moderate/minor) |
| 16 | JP Localization includes lightweight compliance flagging | VERIFIED | `complianceFlags?: string[]` in tool schema; system prompt mentions 薬機法, 景品表示法 flagging without rewrite |
| 17 | Art Director meta-prompt teaches Claude HOW to craft Flux prompts, not WHAT to write | VERIFIED | Module header explicitly: "META-PROMPT SYSTEM: it teaches Claude HOW to craft photorealistic image prompts for any product category, not WHAT specific prompts to write"; prompt built from `buildPhotographyKnowledgeSection()`, `buildCategoryTemplatesSection()` etc. |
| 18 | Art Director has mandatory 8-item self-critique checklist | VERIFIED | `buildSelfCritiqueSection()` embeds full `ART_DIRECTOR_QUALITY_CHECKLIST` (8 items); "MANDATORY: Before delivering your final prompts, review each prompt against this quality checklist" |
| 19 | Art Director uses Flux Raw Mode and NO negative prompts | VERIFIED | `flux-techniques.ts` `FLUX_CONFIG.rawMode: true`, `noNegativePrompts: true`; `buildFluxKnowledgeSection()` embeds these; tool schema has no `negativePrompt` field |
| 20 | Camera/lens descriptors included in every people-focused prompt | VERIFIED | `CAMERA_LENS_DATABASE` embedded in system prompt; tool schema requires `cameraLens` and `lightingSetup` fields per prompt |
| 21 | Skin realism anti-patterns countered explicitly (visible pores, subsurface scattering, natural imperfections) | VERIFIED | `SKIN_REALISM_COUNTERS` (5 entries) embedded in system prompt via `buildFluxKnowledgeSection()`; `PHOTOREALISM_KEYWORDS` string includes "natural skin texture with visible pores, subsurface scattering" |
| 22 | Art Director default demographic is Japanese models for Japanese market | VERIFIED | Checklist item 5: "Does the prompt specify Japanese demographic when featuring people?"; failureAction: "Add 'Japanese' before the person description" |
| 23 | Art Director works without brand profile (GENX-09) | VERIFIED | `buildArtDirectorUserMessage()` has explicit GENX-09 branch: when `!brandProfile?.colors && !brandTone` → appends "No brand profile colors or tone available — infer an appropriate color palette and visual tone from the product type, target audience, and mood tags." |
| 24 | Evaluation infrastructure: 8 test briefs (5 standard + 3 edge), rubrics for all 5 agents, naive baselines for A/B | VERIFIED | `test-briefs.ts`: 5 standard (cosmetics, food, fashion, nail salon, online course) + 3 edge (vague, conflicting, pet memorial); `rubrics.ts`: 5 `agentId` entries (strategic_insight, creative_director, copywriter, art_director, jp_localization); `naive-prompts.ts`: all 5 naive builders |
| 25 | No anti-laziness language in any agent prompt ("think step by step", "be thorough", "carefully consider") | VERIFIED | grep across all 5 agent builders found zero matches in actual prompt strings; comments acknowledge this constraint in JSDoc |

**Score:** 25/25 truths verified

---

## Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/lib/ai/prompts/shared/frameworks.ts` | Schwartz, LF8, AIDMA, AISAS framework definitions | VERIFIED | 5 SCHWARTZ entries, 8 LF8 entries, 3 JAPANESE_DESIRE_NUANCES, 5 COPYWRITING_FRAMEWORKS (PAS/AIDA/BAB/AIDMA/AISAS); all `as const` typed |
| `src/lib/ai/prompts/shared/register-map.ts` | Product category to keigo register mapping | VERIFIED | 8 categories, `getRegisterForCategory()` helper with override support; defaults to "standard" for unknown categories |
| `src/lib/ai/prompts/shared/platform-norms.ts` | Japanese platform advertising norms for LINE, Instagram, X | VERIFIED | All 3 platforms; 140 char limit for X, 2200 for Instagram, 20/50/500 for LINE |
| `src/lib/ai/prompts/shared/flux-techniques.ts` | Camera/lens database, photorealism keywords, anti-pattern counters | VERIFIED | 5 camera specs, PHOTOREALISM_KEYWORDS string, 5 SKIN_REALISM_COUNTERS, FLUX_CONFIG with rawMode:true |
| `src/lib/ai/prompts/shared/quality-checklist.ts` | Art Director self-critique checklist items | VERIFIED | 8 `QualityCheckItem` entries, each with check + failureAction |
| `src/lib/ai/prompts/shared/agent-config.ts` | Per-agent temperature, effort, and model defaults | VERIFIED | All 5 agents; temperature gradient 0.2→0.7; toolNames match pipeline tool names |
| `src/lib/ai/prompts/agents/types.ts` | AgentPromptBuilder interface, PromptSection, FewShotExample | VERIFIED | `AgentPromptBuilder<TInput, TOutput>`, `PromptSection`, `FewShotExample<T>`, `ToolSchema<_TOutput>`, `buildPromptFromSections()` utility |
| `src/types/pipeline.ts` | Updated interfaces with confidence scores and framework-specific labels | VERIFIED | All 5 output interfaces expanded; awarenessLevel/copywritingFramework are typed literal unions; negativePrompt removed; new fields all optional for backward compat |
| `src/lib/ai/prompts/agents/strategic-insight.ts` | System prompt builder, user message builder, tool schema | VERIFIED | `buildStrategicInsightSystemPrompt()`, `buildStrategicInsightUserMessage()`, `STRATEGIC_INSIGHT_TOOL_SCHEMA` — all exported |
| `src/lib/ai/prompts/agents/creative-director.ts` | System prompt builder, user message builder, auto/pro schemas | VERIFIED | All exports present including `getCreativeDirectorToolSchema(mode)` selector |
| `src/lib/ai/prompts/agents/copywriter.ts` | System prompt builder, user message builder, tool schema | VERIFIED | `buildCopywriterSystemPrompt()`, `buildCopywriterUserMessage()`, `COPYWRITER_TOOL_SCHEMA` |
| `src/lib/ai/prompts/agents/art-director.ts` | Meta-prompt builder, user message builder, auto/pro schemas, selector | VERIFIED | All 5 exports: `buildArtDirectorSystemPrompt`, `buildArtDirectorUserMessage`, `ART_DIRECTOR_TOOL_SCHEMA_AUTO`, `ART_DIRECTOR_TOOL_SCHEMA_PRO`, `getArtDirectorToolSchema` |
| `src/lib/ai/prompts/agents/jp-localization.ts` | System prompt, initial review, revision message, tool schema | VERIFIED | All 4 exports including `buildJpLocalizationRevisionMessage(copywriterOutput, critiqueHistory, attemptNumber)` with full history tracking |
| `src/lib/ai/prompts/evaluation/test-briefs.ts` | 5 standard + 3 edge case test brief definitions | VERIFIED | `STANDARD_TEST_BRIEFS`, `EDGE_CASE_BRIEFS`, `ALL_TEST_BRIEFS` exported; 8 briefs total; all conform to `CampaignBrief` type |
| `src/lib/ai/prompts/evaluation/rubrics.ts` | Per-agent evaluation rubric definitions with 1-5 scoring | VERIFIED | `AGENT_RUBRIC_DIMENSIONS` and `EVALUATION_RUBRICS` exported; all 5 agents covered with concrete scoring anchors |
| `src/lib/ai/prompts/evaluation/naive-prompts.ts` | Baseline naive prompt builders for A/B comparison | VERIFIED | All 5 naive builder functions; Copywriter/Art Director mirror actual v1.0 code; all labeled "NAIVE BASELINE — for A/B comparison only" |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `strategic-insight.ts` | `shared/frameworks.ts` | Imports SCHWARTZ_AWARENESS_LEVELS, LF8_DESIRES, JAPANESE_DESIRE_NUANCES, COPYWRITING_FRAMEWORKS | WIRED | `import { SCHWARTZ_AWARENESS_LEVELS, LF8_DESIRES, JAPANESE_DESIRE_NUANCES, COPYWRITING_FRAMEWORKS } from "../shared/frameworks"` — all 4 used in `buildKnowledgeSection()` |
| `STRATEGIC_INSIGHT_TOOL_SCHEMA` | `StrategicInsightOutput` | Tool schema properties mirror interface fields | WIRED | Schema has awarenessLevel enum, awarenessConfidence, primaryDesires array, desireConfidence, copywritingFramework enum (PAS/AIDA/BAB/AIDMA/AISAS), frameworkRationale, all required fields match interface |
| `creative-director.ts` | `pipeline.ts` | Tool schema matches CreativeDirectorOutput | WIRED | `import type { StrategicInsightOutput, N8nWebhookPayload } from "@/types/pipeline"` — user message builder typed against StrategicInsightOutput |
| `copywriter.ts` | `shared/register-map.ts` | Imports REGISTER_BY_CATEGORY and getRegisterForCategory | WIRED | Both imported at line 21-24 and used in `buildRegisterSection()` |
| `copywriter.ts` | `shared/platform-norms.ts` | Imports PLATFORM_NORMS for platform-specific instructions | WIRED | Imported at line 26; used to embed platform norms in system prompt |
| `jp-localization.ts` | `pipeline.ts` | Tool schema matches JpLocalizationOutput with structured issues | WIRED | `JP_LOCALIZATION_TOOL_SCHEMA: ToolSchema<JpLocalizationOutput>` typed; issues array has field enum, category enum, severity enum matching interface |
| `buildJpLocalizationRevisionMessage` | Copywriter revision input | Critique history passed for targeted revision | WIRED | Function signature: `(copywriterOutput, critiqueHistory: CritiqueHistoryEntry[], attemptNumber: number)` — includes full history formatting and auto-approve on final attempt |
| `art-director.ts` | `shared/flux-techniques.ts` | Imports CAMERA_LENS_DATABASE, PHOTOREALISM_KEYWORDS, SKIN_REALISM_COUNTERS, FLUX_CONFIG | WIRED | All 4 imported at lines 23-28; used in `buildPhotographyKnowledgeSection()` and `buildFluxKnowledgeSection()` |
| `art-director.ts` | `shared/quality-checklist.ts` | Imports ART_DIRECTOR_QUALITY_CHECKLIST | WIRED | Imported at line 29; embedded in `buildSelfCritiqueSection()` |
| `ART_DIRECTOR_TOOL_SCHEMA_AUTO/PRO` | `ArtDirectorOutput` | Tool schema properties match updated pipeline type | WIRED | Schema has `productCategory`, `cameraLens`, `lightingSetup`, `compositionGuidance`, `textSafeZone` (optional); no `negativePrompt` field |
| `test-briefs.ts` | `src/types/campaign.ts` | Test briefs conform to CampaignBrief type | WIRED | `import type { CampaignBrief } from "@/types/campaign"` — each brief typed as `CampaignBrief` |
| `naive-prompts.ts` | `copy-generation.ts` | Naive Copywriter mirrors existing v1.0 prompts | WIRED | Comment at line 169: "Mirror of copy-generation.ts buildSystemPrompt" and line 229: "Mirror of copy-generation.ts buildCopyPrompt" |

---

## Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|------------|-------------|--------|----------|
| ORCH-04 | Plans 02, 05 | Strategic Insight agent classifies brief into Schwartz awareness level, LF8 desires, and copywriting framework | SATISFIED | `buildStrategicInsightSystemPrompt()` embeds all 3 classification frameworks; tool schema requires all classification fields |
| ORCH-05 | Plans 02, 05 | Creative Director agent generates creative concept, visual mood, and copy direction from strategy | SATISFIED | `creative-director.ts` produces concept, visualConcept, colorGuidance, compositionNotes, moodKeywords, copyDirection, platformAdaptations |
| ORCH-06 | Plans 03, 05 | Copywriter agent generates copy variants per platform using the selected framework and register | SATISFIED | `copywriter.ts` imports framework/register data; tool schema requires 4 variants per platform with register field |
| ORCH-07 | Plans 04, 05 | Art Director agent generates image prompts, visual direction, and composition guidance from creative concept | SATISFIED | `art-director.ts` produces imagePrompts with prompt, cameraLens, lightingSetup, compositionGuidance per platform |
| ORCH-08 | Plans 03, 05 | JP Localization agent reviews all copy/visual output with veto power and critique loop (max 2 retries) | SATISFIED | `jp-localization.ts` has `approved: boolean` in tool schema; `buildJpLocalizationRevisionMessage()` supports critique loop with auto-approve on attempt 2 |
| ORCH-09 | Plans 02, 05 | Quality gate validates Strategic Insight output completeness before passing to Creative Director | SATISFIED | `STRATEGIC_INSIGHT_TOOL_SCHEMA` enforces all required fields via tool-use; minLength constraints on rationale; minItems/maxItems on arrays |
| ORCH-13 | Plan 01 | Agent scratchpad pattern passes only structured JSON summaries between agents (not full reasoning chains) | SATISFIED | Tool-use forced output produces structured JSON only; user message builders format upstream output as tagged summaries (not raw reasoning) |
| ORCH-14 | Plan 01 | Tiered model assignment (Opus for Orchestrator/Strategic/Localization, Sonnet for Copywriter/Art Director) | SATISFIED | `agent-config.ts`: strategicInsight/creativeDirector/jpLocalization → modelTier: "opus"; copywriter/artDirector → modelTier: "sonnet" |
| GENX-09 | Plan 04 | Pipeline generates quality images without a brand profile by inferring defaults from brief content | SATISFIED | `buildArtDirectorUserMessage()` GENX-09 branch: when no brand colors or tone → explicit inference instruction injected into user message |

**All 9 requirement IDs satisfied. No orphaned requirements found.**

---

## Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| None | — | — | — | — |

Zero anti-patterns detected across all 16 created/modified files. No TODOs, FIXMEs, placeholders, empty implementations, or console.log-only stubs found.

---

## Human Verification Required

### 1. A/B Comparison: Optimized vs. Naive Prompt Quality

**Test:** Run the cosmetics (`standard-cosmetics`) and online course (`standard-online-course`) test briefs through both naive and optimized prompt builders. Score outputs using `EVALUATION_RUBRICS`.

**Expected:** Optimized prompts average >= 0.5 points higher than naive on the 5-point scale across all agent dimensions.

**Why human:** Requires live Claude API calls, Japanese language quality judgment for naturalness/register scoring, and domain knowledge to assess classification accuracy. Cannot be verified programmatically.

### 2. Art Director Photorealism Quality

**Test:** Run the cosmetics brief through the Art Director with a real Flux API call. Inspect the generated images for skin realism.

**Expected:** Images show visible pores, subsurface scattering, candid expressions, natural lighting imperfections — not the default AI-smooth "poreless skin" output.

**Why human:** Image quality (skin texture realism, natural lighting, authentic poses) requires visual assessment. Prompt correctness was verified programmatically but Flux output quality requires eyes.

### 3. JP Localization Critique Specificity

**Test:** Run a complete pipeline cycle (Strategic Insight → Creative Director → Copywriter → JP Localization) on the fashion brief. Evaluate the JP Localization critique output.

**Expected:** Critique contains field-level issues with exact platform, variant, and field identification. Suggestions are concrete Japanese text fixes, not abstract guidance.

**Why human:** Requires native or near-native Japanese reading ability to evaluate whether critique feedback is genuinely actionable and the suggestions are natural Japanese.

---

## Verification Summary

Phase 9.1 goal achievement is confirmed at the infrastructure and prompt engineering layer:

All 11 files created across Plans 01-05 are substantive and fully wired. The shared data modules provide a genuine knowledge base (not stubs) with exact research values for camera specifications, platform character limits, framework definitions, and evaluation criteria. All 5 agent prompt builders import from and use the shared modules. The pipeline types are expanded with typed literal unions, confidence scores, and framework-specific fields. The evaluation infrastructure provides a complete A/B comparison framework with 8 reproducible test briefs, concrete rubric scoring, and naive baselines that mirror actual v1.0 code.

The phase goal has three components:
1. **5 agents with research-backed prompts** — VERIFIED. Each agent's prompt is built from research section data (Schwartz from section 1.1, LF8 from 1.2, AIDMA/AISAS from 1.3, platform norms from 4.3, camera specs from 5.3, quality checklist from 5.6, evaluation criteria from 8.1).
2. **Art Director producing ultra-realistic photographic output** — VERIFIED at the prompt level. Skin realism counters, camera/lens specs, self-critique checklist, and Raw Mode instructions are all correctly embedded. Actual Flux output quality requires human verification.
3. **Measurably superior output compared to naive prompting** — VERIFIED at the evaluation infrastructure level. Rubrics, naive baselines, and test briefs exist. Actual A/B comparison scores require human evaluation runs.

All 9 requirement IDs (ORCH-04, ORCH-05, ORCH-06, ORCH-07, ORCH-08, ORCH-09, ORCH-13, ORCH-14, GENX-09) are satisfied. TypeScript compilation passes with zero errors.

---

_Verified: 2026-02-19T10:00:00Z_
_Verifier: Claude (gsd-verifier)_
