---
phase: 09-core-agent-pipeline-generation-execution
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - (n8n workflows via MCP)
autonomous: true
requirements: [ORCH-04, ORCH-05, ORCH-09]

must_haves:
  truths:
    - "Strategic Insight n8n sub-workflow calls Anthropic API with the optimized prompt builder and returns classified awareness level, LF8 desires, and copywriting framework"
    - "Quality gate Code node validates Strategic Insight output completeness before pipeline continues"
    - "Creative Director n8n sub-workflow generates visual concept, color guidance, and copy direction from strategy output"
    - "Both agent sub-workflows send progress callbacks (active/complete) and cost entries"
  artifacts:
    - path: "(n8n) Strategic Insight Agent sub-workflow"
      provides: "Schwartz/LF8/framework classification via Anthropic API"
      contains: "deliver_strategic_insight tool call"
    - path: "(n8n) Creative Director Agent sub-workflow"
      provides: "Visual concept and copy direction"
      contains: "deliver_creative_concept tool call"
    - path: "(n8n) Quality Gate code node"
      provides: "StrategicInsightOutput validation"
      contains: "awarenessLevel"
  key_links:
    - from: "Master Orchestrator"
      to: "Strategic Insight sub-workflow"
      via: "Execute Sub-workflow node"
      pattern: "pipelineState.strategicInsight"
    - from: "Strategic Insight output"
      to: "Quality Gate code node"
      via: "Output validation"
      pattern: "awarenessLevel.*lf8Desires.*copywritingFramework"
    - from: "Quality Gate output"
      to: "Creative Director sub-workflow"
      via: "Execute Sub-workflow node"
      pattern: "pipelineState.creativeDirector"
---

<objective>
Build the first two agent n8n sub-workflows (Strategic Insight and Creative Director) and the quality gate, then wire them into the Master Orchestrator.

Purpose: These are the first agents in the pipeline. Strategic Insight classifies the campaign brief into Schwartz awareness level, LF8 desires, and copywriting framework (PAS/AIDA/BAB/AIDMA/AISAS). Creative Director generates the visual and copy direction. The quality gate ensures Strategic Insight output is complete before passing to Creative Director. Both are critical-stop agents -- pipeline halts if they fail after 1 retry.

Output: 2 n8n sub-workflows (Strategic Insight, Creative Director) and a quality gate code node, all wired into the Master Orchestrator from Plan 09-01.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai/prompts/agents/strategic-insight.ts
@src/lib/ai/prompts/agents/creative-director.ts
@src/lib/ai/prompts/shared/agent-config.ts
@src/lib/ai/prompts/shared/frameworks.ts
@src/types/pipeline.ts
@.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Strategic Insight agent n8n sub-workflow with quality gate</name>
  <files>
    (n8n workflows via MCP)
  </files>
  <action>
Create a new n8n sub-workflow "Strategic Insight Agent" using `n8n_create_workflow`:

**Workflow structure:**

1. **Execute Workflow Trigger** — receives PipelineState JSON from Master Orchestrator

2. **Send Progress: Active** (HTTP Request node):
   - POST to NEXTJS_CALLBACK_URL with agentStep: { agentName: "strategic_insight", labelJa: "戦略分析中", status: "active", startedAt: ISO timestamp }
   - Include HMAC signature header

3. **Fetch Prompt from Build-Prompt Endpoint** (HTTP Request node):
   - POST to `${NEXTJS_BASE_URL}/api/internal/build-prompt`
   - Include X-Signature HMAC header (same pattern as progress callbacks)
   - Body: `{ agentName: "strategicInsight", brief, brandProfile, agentConfig, mode }` extracted from PipelineState
   - This calls the Phase 9.1 TypeScript prompt builders (single source of truth) and returns serialized { systemPrompt, userMessage, toolSchema, toolChoice, temperature, maxTokens }
   - Do NOT inline any prompt content in n8n — the endpoint handles all framework knowledge (Schwartz, LF8, copywriting frameworks)
   - Timeout: 10 seconds (prompt serialization is fast)

4. **Call Anthropic API** (HTTP Request node):
   - POST to `https://api.anthropic.com/v1/messages`
   - Headers: x-api-key (from n8n Anthropic credential), anthropic-version: 2023-06-01, content-type: application/json
   - Body: Construct from build-prompt response — { model: agentConfig.strategicInsight.model (default: claude-opus-4-6), max_tokens: response.maxTokens, temperature: response.temperature, system: response.systemPrompt, messages: [{ role: "user", content: response.userMessage }], tools: [response.toolSchema], tool_choice: response.toolChoice }
   - Timeout: 120 seconds

5. **Parse Response** (Code node):
   - Extract tool_use content block from response
   - Parse the JSON input from the deliver_strategic_insight tool call
   - Write to pipelineState.strategicInsight
   - Calculate cost entry: inputTokens, outputTokens from response usage, costYen estimated from token counts
   - Extract summaryJa for progress callback

6. **Quality Gate** (Code node — ORCH-09):
   - Validate the parsed StrategicInsightOutput:
     - awarenessLevel is one of: "unaware", "problem_aware", "solution_aware", "product_aware", "most_aware"
     - lf8Desires has at least 1 entry
     - copywritingFramework is one of: "PAS", "AIDA", "BAB", "AIDMA", "AISAS" (NOT SB7)
     - targetInsight length >= 10 chars
     - creativeDirection length >= 10 chars
   - If validation fails: set error flag, do NOT continue

7. **Error Handling — 1 Silent Retry** (using n8n's retry mechanism or an If node):
   - If the API call or quality gate fails on first attempt, retry once
   - If retry also fails: send failure callback with Japanese error message "戦略分析を完了できませんでした。お手数ですが、もう一度お試しください。" and halt (critical-stop)

8. **Send Progress: Complete** (HTTP Request node):
   - POST agentStep: { agentName: "strategic_insight", status: "complete", summaryJa: extracted summary, completedAt: ISO timestamp }
   - POST costEntries with token usage

9. **Return Updated PipelineState** — return to Master Orchestrator with strategicInsight populated

After creating the sub-workflow, update the Master Orchestrator (from Plan 09-01) to replace the Strategic Insight placeholder with an Execute Sub-workflow node referencing this workflow's ID. Use `n8n_update_partial_workflow` with an `updateNode` operation.
  </action>
  <verify>
    - Sub-workflow created via n8n MCP and has valid structure
    - Build-prompt HTTP Request node calls /api/internal/build-prompt with agentName "strategicInsight"
    - No inline prompt content in any n8n Code node (all prompts come from build-prompt endpoint)
    - Quality gate validates all required fields
    - Master Orchestrator updated to reference this sub-workflow
  </verify>
  <done>
    - Strategic Insight n8n sub-workflow calls Anthropic API with tool-use structured output
    - Quality gate (ORCH-09) validates awarenessLevel, lf8Desires, copywritingFramework, targetInsight, creativeDirection completeness
    - 1 silent retry on failure, then critical-stop with Japanese error message
    - Progress callbacks sent for active/complete states with cost entries
    - Master Orchestrator dispatches to this sub-workflow
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Creative Director agent n8n sub-workflow</name>
  <files>
    (n8n workflows via MCP)
  </files>
  <action>
Create a new n8n sub-workflow "Creative Director Agent" using `n8n_create_workflow`:

**Workflow structure:**

1. **Execute Workflow Trigger** — receives PipelineState JSON with strategicInsight populated

2. **Send Progress: Active** (HTTP Request):
   - agentStep: { agentName: "creative_director", labelJa: "クリエイティブ設計中", status: "active" }

3. **Fetch Prompt from Build-Prompt Endpoint** (HTTP Request node):
   - POST to `${NEXTJS_BASE_URL}/api/internal/build-prompt`
   - Include X-Signature HMAC header
   - Body: `{ agentName: "creativeDirector", brief, brandProfile, agentConfig, mode, upstreamOutputs: { strategicInsight: pipelineState.strategicInsight } }`
   - Returns serialized { systemPrompt, userMessage, toolSchema, toolChoice, temperature, maxTokens }
   - The endpoint handles mode-dependent tool schema selection (auto: flat, pro: 2-3 concepts array)
   - Do NOT inline any prompt content — endpoint is single source of truth
   - Timeout: 10 seconds

4. **Call Anthropic API** (HTTP Request node):
   - POST to `https://api.anthropic.com/v1/messages`
   - Headers: x-api-key (from n8n Anthropic credential), anthropic-version: 2023-06-01, content-type: application/json
   - Body: Construct from build-prompt response — { model: agentConfig.creativeDirector.model, max_tokens: response.maxTokens, temperature: response.temperature, system: response.systemPrompt, messages: [{ role: "user", content: response.userMessage }], tools: [response.toolSchema], tool_choice: response.toolChoice }
   - Timeout: 120 seconds

5. **Parse Response** (Code node):
   - Extract tool_use content block
   - For pro mode: take first concept from the array (the orchestrator only needs one concept to proceed; all concepts are stored in pipelineState for the dashboard)
   - Write to pipelineState.creativeDirector
   - Calculate cost entry

6. **Error Handling — 1 Silent Retry**:
   - If fails after retry: critical-stop with "クリエイティブの方向性を生成できませんでした。お手数ですが、もう一度お試しください。"

7. **Send Progress: Complete** (HTTP Request):
   - agentStep: { agentName: "creative_director", status: "complete", summaryJa }
   - costEntries

8. **Return Updated PipelineState** with creativeDirector populated

After creating, update Master Orchestrator to reference this sub-workflow ID in the Creative Director placeholder node.
  </action>
  <verify>
    - Sub-workflow created with correct structure
    - Build-prompt HTTP Request node calls /api/internal/build-prompt with agentName "creativeDirector"
    - No inline prompt content in any n8n Code node (all prompts come from build-prompt endpoint)
    - Critical-stop error handling with Japanese message
    - Master Orchestrator updated to dispatch to this workflow
  </verify>
  <done>
    - Creative Director n8n sub-workflow generates visual concept from Strategic Insight output
    - Mode-dependent tool schema (auto: flat, pro: 2-3 concepts array)
    - 1 silent retry, then critical-stop with Japanese error
    - Progress callbacks and cost tracking active
    - Master Orchestrator dispatches to this sub-workflow after quality gate
  </done>
</task>

</tasks>

<verification>
- Both sub-workflows exist in n8n and validate cleanly
- Strategic Insight quality gate enforces all required fields
- Both sub-workflows call /api/internal/build-prompt (NO inline prompt content in n8n Code nodes)
- No SB7 references in n8n workflow content (SB7 exclusion enforced in Phase 9.1 builders)
- Creative Director mode-dependent schemas handled by build-prompt endpoint
- Master Orchestrator connects webhook -> Strategic Insight -> Quality Gate -> Creative Director
</verification>

<success_criteria>
- Strategic Insight sub-workflow receives brief, classifies into awareness/LF8/framework, passes quality gate
- Creative Director sub-workflow receives strategy output, generates visual and copy direction
- Both are critical-stop agents with 1 retry and Japanese error messages
- Both send per-agent progress callbacks and cost entries
- Master Orchestrator dispatches to both in sequence with quality gate between them
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-02-SUMMARY.md`
</output>
