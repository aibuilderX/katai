---
phase: 09-core-agent-pipeline-generation-execution
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified: []
autonomous: true
requirements: [ORCH-04, ORCH-05, ORCH-09]

must_haves:
  truths:
    - "Strategic Insight sub-workflow receives brief+brandProfile, calls Anthropic API with tool-use structured output, and returns StrategicInsightOutput with Schwartz/LF8/framework classification"
    - "Quality gate validates Strategic Insight output completeness before pipeline continues -- empty or malformed output halts the pipeline with a Japanese error message"
    - "Creative Director sub-workflow receives strategicInsight and generates visual concept, color guidance, composition notes, mood keywords, and per-platform visual adaptations"
    - "Both agents produce a ~10 word Japanese summary line included in their output"
    - "1 silent auto-retry on failure for both agents (critical-stop agents)"
  artifacts:
    - path: "n8n sub-workflow: Strategic Insight Agent"
      provides: "Schwartz/LF8/SB7 classification via Claude tool-use"
      contains: "deliver_strategic_insight tool"
    - path: "n8n sub-workflow: Creative Director Agent"
      provides: "Visual concept and creative direction"
      contains: "deliver_creative_direction tool"
  key_links:
    - from: "Master Orchestrator"
      to: "Strategic Insight sub-workflow"
      via: "Execute Sub-workflow node passing PipelineState"
      pattern: "pipelineState.strategicInsight"
    - from: "Strategic Insight sub-workflow"
      to: "Quality Gate Code node"
      via: "Return value with strategicInsight populated"
      pattern: "awarenessLevel.*lf8Desires.*copywritingFramework"
    - from: "Quality Gate"
      to: "Creative Director sub-workflow"
      via: "Validated PipelineState passes forward"
      pattern: "pipelineState.creativeDirector"
---

<objective>
Create the Strategic Insight and Creative Director agent sub-workflows in n8n, plus the quality gate that validates Strategic Insight output before the pipeline continues.

Purpose: These are the first two agents in the pipeline. Strategic Insight classifies the brief into awareness level, LF8 desires, and copywriting framework. Creative Director translates that strategy into visual and creative direction. Both are critical-stop agents -- if they fail, the pipeline halts.

Output: 2 n8n sub-workflows (Strategic Insight, Creative Director), quality gate validation Code node integrated into master orchestrator, master orchestrator updated with real sub-workflow IDs.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-CONTEXT.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-RESEARCH.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md
@src/types/pipeline.ts
@src/lib/ai/prompts/copy-generation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Strategic Insight agent sub-workflow in n8n</name>
  <files>
    (n8n workflow via MCP tools)
  </files>
  <action>
Create the Strategic Insight agent sub-workflow using `mcp__n8n-mcp__n8n_create_workflow`.

**Sub-workflow structure:**

1. **Execute Workflow Trigger** (entry point for sub-workflows):
   - Receives: `{ pipelineState, brief, brandProfile, agentConfig, callbackUrl, webhookSecret }`

2. **Build System Prompt (Code node):**
   - System prompt instructs Claude to act as a strategic marketing analyst specializing in the Japanese market
   - Includes Schwartz awareness level scale (Unaware, Problem Aware, Solution Aware, Product Aware, Most Aware) with descriptions
   - Includes LF8 Life Force 8 desires list:
     1. Survival, enjoyment of life, life extension
     2. Enjoyment of food and beverages
     3. Freedom from fear, pain, and danger
     4. Sexual companionship
     5. Comfortable living conditions
     6. To be superior, winning, keeping up with the Joneses
     7. Care and protection of loved ones
     8. Social approval
   - Includes copywriting framework options: PAS (Problem-Agitate-Solve), AIDA (Attention-Interest-Desire-Action), BAB (Before-After-Bridge), SB7 (StoryBrand 7)
   - Instructs: "Analyze the campaign brief and brand profile. Classify the target audience's awareness level, identify the most relevant LF8 desires, and select the optimal copywriting framework. Provide substantive insights, not surface-level categorization."
   - **Critical instruction:** "あなたの判断を日本語で約10語にまとめてください（summaryJaフィールド）。例：「感情訴求×安心感で家族層にアプローチ」"
   - Language: Prompt is in English (for Claude reasoning), but summaryJa output must be Japanese
   - Temperature: 0.3 (strategic analysis should be deterministic)
   - Model: read from `agentConfig.strategicInsight.model` (defaults to "claude-opus-4-6")

3. **Call Anthropic API (HTTP Request node):**
   - Method: POST
   - URL: `https://api.anthropic.com/v1/messages`
   - Headers:
     - `x-api-key`: from n8n credential or environment variable `ANTHROPIC_API_KEY`
     - `anthropic-version`: `2023-06-01`
     - `content-type`: `application/json`
   - Body:
     ```json
     {
       "model": "{{ agentConfig.strategicInsight.model }}",
       "max_tokens": 4096,
       "temperature": 0.3,
       "system": "{{ systemPrompt }}",
       "messages": [
         {
           "role": "user",
           "content": "Campaign Brief:\n{{ JSON.stringify(brief) }}\n\nBrand Profile:\n{{ JSON.stringify(brandProfile) }}"
         }
       ],
       "tools": [
         {
           "name": "deliver_strategic_insight",
           "description": "Deliver the strategic analysis results",
           "input_schema": {
             "type": "object",
             "properties": {
               "awarenessLevel": { "type": "string", "description": "Schwartz awareness level classification" },
               "lf8Desires": { "type": "array", "items": { "type": "string" }, "minItems": 1, "description": "LF8 desires identified" },
               "copywritingFramework": { "type": "string", "enum": ["PAS", "AIDA", "BAB", "SB7"], "description": "Selected framework" },
               "targetInsight": { "type": "string", "minLength": 10, "description": "Core audience insight" },
               "creativeDirection": { "type": "string", "minLength": 10, "description": "Creative direction for next agent" },
               "keyMessages": { "type": "array", "items": { "type": "string" }, "description": "Key messages to convey" },
               "tonalGuidance": { "type": "string", "description": "Tone and register recommendation" },
               "summaryJa": { "type": "string", "description": "10-word Japanese summary of the strategic decision" }
             },
             "required": ["awarenessLevel", "lf8Desires", "copywritingFramework", "targetInsight", "creativeDirection", "keyMessages", "tonalGuidance", "summaryJa"]
           }
         }
       ],
       "tool_choice": { "type": "tool", "name": "deliver_strategic_insight" }
     }
     ```
   - Timeout: 120000ms (2 minutes)
   - On error: retry 1 time (this is the silent auto-retry per ORCH-10)

4. **Parse Response (Code node):**
   - Extract tool_use content block from Claude response
   - Parse the `input` field of the tool_use block as StrategicInsightOutput
   - Write to `pipelineState.strategicInsight`
   - Extract `usage.input_tokens` and `usage.output_tokens` for cost tracking
   - Build cost entry: `{ entryType: "agent", agentName: "strategic_insight", modelUsed: model, inputTokens, outputTokens, costYen: <calculate from token counts>, success: true }`

5. **Progress Callback: Strategic Insight Complete (HTTP Request node):**
   - POST to callbackUrl with HMAC signature
   - Body: `{ campaignId, status: "progress", agentStep: { agentName: "strategic_insight", labelJa: "戦略分析中", status: "complete", summaryJa: <from output>, completedAt }, costEntries: [costEntry] }`

6. **Return updated PipelineState** (output of sub-workflow)

**Error handling:**
- If HTTP Request fails after retry: return pipelineState with `agentErrors` array containing the error, `status: "failed"`, and `isCriticalStop: true`
- The master orchestrator's quality gate (next step) will catch this

Record the created sub-workflow ID for the master orchestrator update.

  </action>
  <verify>
Sub-workflow exists in n8n via `mcp__n8n-mcp__n8n_get_workflow`. Has Execute Workflow Trigger, prompt builder Code node, HTTP Request to Anthropic API with tool-use, response parser, and progress callback. Validate with `mcp__n8n-mcp__n8n_validate_workflow`.
  </verify>
  <done>
Strategic Insight sub-workflow created in n8n. Receives brief+brandProfile, calls Anthropic API with deliver_strategic_insight tool-use, parses structured output into StrategicInsightOutput, sends progress callback with Japanese summary and cost entry, returns updated PipelineState with strategicInsight populated. 1 auto-retry on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Creative Director sub-workflow and wire quality gate into master orchestrator</name>
  <files>
    (n8n workflows via MCP tools)
  </files>
  <action>
**Part A: Create the Creative Director agent sub-workflow using `mcp__n8n-mcp__n8n_create_workflow`.**

Same pattern as Strategic Insight with these differences:

1. **System prompt:** Instructs Claude to act as a senior creative director for Japanese advertising campaigns. Receives the strategic insight (awareness level, LF8 desires, framework, creative direction, tonal guidance) and generates visual and creative direction.

2. **Tool definition:**
   ```json
   {
     "name": "deliver_creative_direction",
     "description": "Deliver the creative direction and visual concept",
     "input_schema": {
       "type": "object",
       "properties": {
         "visualConcept": { "type": "string", "description": "Overall visual direction and concept" },
         "colorGuidance": { "type": "string", "description": "Color palette and usage recommendations" },
         "compositionNotes": { "type": "string", "description": "Layout, framing, and composition direction" },
         "moodKeywords": { "type": "array", "items": { "type": "string" }, "description": "Visual mood keywords" },
         "platformAdaptations": { "type": "object", "description": "Per-platform visual adaptation notes (keys are platform IDs)" },
         "summaryJa": { "type": "string", "description": "10-word Japanese summary" }
       },
       "required": ["visualConcept", "colorGuidance", "compositionNotes", "moodKeywords", "platformAdaptations", "summaryJa"]
     }
   }
   ```

3. **User message:** Include the strategicInsight section from pipelineState alongside the brief and brandProfile.

4. **Temperature:** 0.5 (more creative latitude than Strategic Insight)

5. **Model:** `agentConfig.creativeDirector.model`

6. **Progress callback:** `{ agentName: "creative_director", labelJa: "クリエイティブ設計中", status: "complete", summaryJa }`

7. **Error handling:** Same as Strategic Insight -- critical-stop agent, 1 auto-retry, halts pipeline on failure with "クリエイティブの方向性を生成できませんでした。お手数ですが、もう一度お試しください。"

**Part B: Update the master orchestrator workflow.**

Use `mcp__n8n-mcp__n8n_update_partial_workflow` (or full update) to:

1. Replace the placeholder Execute Sub-workflow nodes for Strategic Insight and Creative Director with the actual sub-workflow IDs created above

2. Ensure the quality gate Code node (ORCH-09) exists between Strategic Insight return and Creative Director dispatch. The quality gate validates:
   - `strategicInsight.awarenessLevel` is non-empty string
   - `strategicInsight.lf8Desires` is array with >= 1 entry
   - `strategicInsight.copywritingFramework` is one of: "PAS", "AIDA", "BAB", "SB7"
   - `strategicInsight.targetInsight` length >= 10 characters
   - `strategicInsight.creativeDirection` length >= 10 characters
   - On validation failure: send failure callback with critical-stop error message in Japanese, stop workflow

3. Add progress callback nodes:
   - Before Strategic Insight: `{ agentName: "strategic_insight", status: "active", startedAt }`
   - After Strategic Insight (before quality gate): `{ agentName: "strategic_insight", status: "complete", summaryJa, completedAt }`
   - Before Creative Director: `{ agentName: "creative_director", status: "active", startedAt }`
   - After Creative Director: `{ agentName: "creative_director", status: "complete", summaryJa, completedAt }`

Record both sub-workflow IDs in the SUMMARY.

  </action>
  <verify>
Both sub-workflows exist in n8n. Master orchestrator references correct sub-workflow IDs. Quality gate Code node validates StrategicInsightOutput with the 5 validation checks. Progress callback nodes exist before/after each agent. Run `mcp__n8n-mcp__n8n_validate_workflow` on master orchestrator.
  </verify>
  <done>
Strategic Insight and Creative Director sub-workflows created and wired into the master orchestrator. Quality gate validates Strategic Insight output completeness (5 checks) and halts pipeline with Japanese error on failure. Progress callbacks fire with Japanese labels and summaries for both agents. Both are critical-stop agents with 1 silent auto-retry.
  </done>
</task>

</tasks>

<verification>
1. Strategic Insight sub-workflow: receives brief, calls Anthropic API with tool-use, returns StrategicInsightOutput
2. Quality gate: validates awarenessLevel, lf8Desires, copywritingFramework, targetInsight, creativeDirection
3. Creative Director sub-workflow: receives strategicInsight, generates visual concept and creative direction
4. Both agents produce summaryJa in ~10 words of Japanese
5. Both agents send progress callbacks (active + complete) to Next.js
6. Both agents send cost entries after API calls
7. Master orchestrator correctly dispatches to both sub-workflows in sequence
8. Pipeline halts with Japanese error message if either critical-stop agent fails after retry
</verification>

<success_criteria>
- Strategic Insight classifies brief into Schwartz awareness level, LF8 desires, and copywriting framework
- Creative Director generates visual concept, color guidance, composition notes, mood keywords, and per-platform adaptations
- Quality gate prevents malformed strategic output from reaching downstream agents
- Both agents are critical-stop with 1 silent auto-retry
- All progress callbacks include Japanese labels and summaries
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-02-SUMMARY.md`
</output>
