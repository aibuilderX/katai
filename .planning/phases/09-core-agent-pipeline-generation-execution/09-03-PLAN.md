---
phase: 09-core-agent-pipeline-generation-execution
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - (n8n workflows via MCP)
autonomous: true
requirements: [ORCH-06, ORCH-07, ORCH-08, GENX-09]

must_haves:
  truths:
    - "Copywriter n8n sub-workflow generates 4 copy variants (A-D) per platform with correct register and framework"
    - "Art Director n8n sub-workflow generates Flux-compatible image prompts with productCategory, cameraLens, lightingSetup, compositionGuidance (no negativePrompt)"
    - "Copywriter and Art Director run in parallel after Creative Director completes"
    - "JP Localization sub-workflow reviews copy, can reject with critique, and Copywriter revises (max 2 total attempts; auto-approves on attempt 2)"
    - "Art Director infers visual defaults from brief content when brand profile is minimal (GENX-09)"
  artifacts:
    - path: "(n8n) Copywriter Agent sub-workflow"
      provides: "Platform-specific copy generation with 4 variants"
      contains: "deliver_platform_copy tool call"
    - path: "(n8n) Art Director Agent sub-workflow"
      provides: "Flux image prompt generation with photorealism metadata"
      contains: "deliver_art_direction tool call"
    - path: "(n8n) JP Localization Agent sub-workflow"
      provides: "Quality review with critique loop"
      contains: "deliver_localization_review tool call"
  key_links:
    - from: "Creative Director output"
      to: "Copywriter + Art Director (parallel)"
      via: "Parallel branch in Master Orchestrator"
      pattern: "pipelineState.creativeDirector"
    - from: "Copywriter output"
      to: "JP Localization"
      via: "Sequential after parallel merge"
      pattern: "pipelineState.copywriter"
    - from: "JP Localization critique"
      to: "Copywriter revision"
      via: "Loop inside JP Localization sub-workflow"
      pattern: "approved.*false.*issues"
---

<objective>
Build the Copywriter, Art Director, and JP Localization n8n sub-workflows. Copywriter and Art Director run in parallel after Creative Director. JP Localization reviews Copywriter output with a critique loop (max 2 total attempts).

Purpose: These three agents produce the creative output: copy variants for each platform, image prompts for Flux generation, and Japanese quality assurance. The JP Localization critique loop is the most complex n8n workflow pattern in the entire pipeline.

Output: 3 n8n sub-workflows wired into the Master Orchestrator with parallel branching for Copywriter/Art Director and sequential JP Localization after.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai/prompts/agents/copywriter.ts
@src/lib/ai/prompts/agents/art-director.ts
@src/lib/ai/prompts/agents/jp-localization.ts
@src/lib/ai/prompts/shared/register-map.ts
@src/lib/ai/prompts/shared/platform-norms.ts
@src/lib/ai/prompts/shared/flux-techniques.ts
@src/lib/ai/prompts/shared/quality-checklist.ts
@src/types/pipeline.ts
@.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-02-SUMMARY.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-03-SUMMARY.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Copywriter and Art Director n8n sub-workflows (parallel agents)</name>
  <files>
    (n8n workflows via MCP)
  </files>
  <action>
**A. Copywriter Agent sub-workflow:**

Create via `n8n_create_workflow`:

1. **Execute Workflow Trigger** — receives PipelineState with strategicInsight + creativeDirector

2. **Send Progress: Active** — agentStep: { agentName: "copywriter", labelJa: "コピーライティング中", status: "active" }

3. **Build Prompt** (Code node):
   - System prompt: Role as Japanese advertising copywriter (not translator), register-by-category mapping for 8 product categories, platform norms for LINE/Instagram/X, all 5 copywriting frameworks (PAS/AIDA/BAB/AIDMA/AISAS) with detailed structure definitions, character limit guidance per platform
   - User message: strategicInsight (framework, tonalGuidance, keyMessages), creativeDirector (copyDirection, concept), brief (objective, targetAudience, platforms, campaignProductInfo), brandProfile (defaultRegister, toneTags, toneDescription)
   - Tool schema: `deliver_platform_copy` with variants array — each variant has: platform, variantLabel (A案/B案/C案/D案), headline, body, cta, hashtags, register, rationaleNotes (English)
   - Generate 4 variants per platform per Phase 9.1 decision
   - tool_choice: { type: "tool", name: "deliver_platform_copy" }
   - Model from agentConfig.copywriter.model
   - Temperature: 0.7 (creative agent per Phase 9.1 decision)
   - Max tokens: 8192 (multiple platforms x 4 variants each)
   - System prompt in English, output in Japanese (per Phase 9.1 decision: Claude reasons best in English, 96.9% relative JP performance)
   - IMPORTANT: Include instruction "Summarize your decisions in ~10 words in Japanese for the summaryJa field"

4. **Call Anthropic API** — same pattern, timeout 180s (larger output)

5. **Parse Response** — extract tool_use, write to pipelineState.copywriter, calculate cost

6. **Error Handling** — 1 silent retry, then partial delivery (NOT critical-stop). Mark as failed in agentErrors but continue pipeline.

7. **Send Progress: Complete/Failed** — agentStep with summaryJa + costEntries

8. **Return Updated PipelineState**

**B. Art Director Agent sub-workflow:**

Create via `n8n_create_workflow`:

1. **Execute Workflow Trigger** — receives PipelineState with strategicInsight + creativeDirector

2. **Send Progress: Active** — agentStep: { agentName: "art_director", labelJa: "アート設計中", status: "active" }

3. **Build Prompt** (Code node):
   - System prompt: Meta-prompt teaching Claude HOW to craft Flux prompts. Embed camera/lens database (5 product categories), photorealism keywords (skin texture, subsurface scattering, micro-details), skin realism counters, 8-item quality self-critique checklist, anti-patterns to avoid, Flux-specific constraints (no text in images, no negative prompts)
   - User message: creativeDirector (visualConcept, colorGuidance, compositionNotes, moodKeywords), strategicInsight (tonalGuidance), brief (platforms, objective), brandProfile (colors, toneTags)
   - GENX-09: If brandProfile.colors is null or brandProfile.toneTags is empty, include explicit instruction: "No brand colors/tone specified. Infer an appropriate color palette and visual tone from the product type, campaign mood, and target audience."
   - Tool schema: `deliver_art_direction` — imagePrompts array with: platform, prompt, style, aspectRatio, productCategory, cameraLens, lightingSetup, compositionGuidance, textSafeZone
   - CRITICAL: No negativePrompt field anywhere (Flux 1.1 Pro Ultra does not support it per Phase 9.1)
   - For mode "pro": use variations wrapper with variationTheme labels
   - For mode "auto": flat imagePrompts array
   - tool_choice: { type: "tool", name: "deliver_art_direction" }
   - Temperature: 0.5
   - Max tokens: 8192
   - Include self-critique instruction: "Before finalizing, mentally review each prompt against the 8-item quality checklist. Note your self-critique in the selfCritiqueNotes field."

4. **Call Anthropic API** — timeout 180s

5. **Parse Response** — extract tool_use, write to pipelineState.artDirector, calculate cost

6. **Error Handling** — 1 silent retry, then partial delivery (mark failed, continue)

7. **Send Progress: Complete/Failed** — agentStep + costEntries

8. **Return Updated PipelineState**

**C. Wire both into Master Orchestrator:**

Use `n8n_update_partial_workflow` to update the Master Orchestrator:
- After Creative Director, add a branch (parallel execution):
  - Branch 1: Execute Sub-workflow → Copywriter Agent
  - Branch 2: Execute Sub-workflow → Art Director Agent
- After both branches: Merge node that combines the two PipelineState outputs (take copywriter from Branch 1 and artDirector from Branch 2, merge into single PipelineState)
- After merge: proceed to JP Localization
  </action>
  <verify>
    - Both sub-workflows created with valid structure
    - Copywriter generates 4 variants per platform with rationaleNotes
    - Art Director uses productCategory/cameraLens/lightingSetup/compositionGuidance — NO negativePrompt
    - GENX-09: Art Director prompt includes inference instruction for missing brand profile
    - Master Orchestrator has parallel branch for Copywriter/Art Director
    - Only PAS/AIDA/BAB/AIDMA/AISAS frameworks referenced (no SB7)
  </verify>
  <done>
    - Copywriter sub-workflow generates 4 copy variants per platform with Japanese output
    - Art Director sub-workflow generates Flux image prompts with photorealism metadata
    - Both run in parallel after Creative Director in the Master Orchestrator
    - Both are partial-delivery agents (pipeline continues on failure)
    - GENX-09: Art Director infers defaults when brand profile is minimal
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JP Localization sub-workflow with critique loop</name>
  <files>
    (n8n workflows via MCP)
  </files>
  <action>
Create the JP Localization Agent sub-workflow — the most complex workflow due to the critique loop. Use `n8n_create_workflow`:

**Workflow structure:**

1. **Execute Workflow Trigger** — receives PipelineState with copywriter.variants populated

2. **Send Progress: Active** — agentStep: { agentName: "jp_localization", labelJa: "JP品質確認中", status: "active" }

3. **Initialize Loop State** (Code node):
   - Set attemptCount = 1
   - Set maxAttempts = 2 (per Phase 9.1: 2 total attempts, NOT 3)
   - Store original copy variants
   - Initialize critiqueHistory = []

4. **Build Review Prompt** (Code node):
   - System prompt: Role as senior Japanese language quality reviewer, 5 weighted evaluation criteria:
     - Naturalness (30%): grammar, word choice, particle usage, natural flow
     - Register (25%): keigo consistency, appropriate formality for brand/audience
     - Persuasiveness (20%): emotional impact, CTA effectiveness
     - Cultural fit (15%): idiom appropriateness, directness level, seasonal references, JP marketing conventions
     - Platform fit (10%): character limits, hashtag conventions, LINE/Instagram/X norms
   - Review all copy variants from copywriter output
   - Max 5 issues per review (per Phase 9.1: LLMs struggle with more than ~5 in a single revision pass)
   - Tool schema: `deliver_localization_review` — fields: approved (boolean), issues array (platform, variant, field, category, issue, suggestion, severity), overallNote, qualityScore (0-100), complianceFlags (string array for obvious violations only — Phase 12 handles full compliance), summaryJa
   - Include brief critique for known LLM Japanese copy errors: unnatural katakana loan words, mixed register, overly literal translations, missing seasonal references
   - Lightweight compliance flagging only: flag obvious violations (e.g., direct medical claims for cosmetics = 薬機法), do NOT rewrite
   - tool_choice: { type: "tool", name: "deliver_localization_review" }
   - Temperature: 0.2 (analytical agent)
   - If this is a revision (attemptCount > 1): include critique history from previous review in the user message so JP Localization can evaluate whether its previous issues were addressed

5. **Call Anthropic API** — timeout 120s

6. **Parse Review Response** (Code node):
   - Extract tool_use content
   - If approved === true: write to pipelineState.jpLocalization, proceed to return
   - If approved === false AND attemptCount < maxAttempts: go to revision branch
   - If approved === false AND attemptCount >= maxAttempts: auto-approve with best available version (per Phase 9.1: auto-approve on final attempt to prevent pipeline stall)

7. **REVISION BRANCH (If node: approved === false AND attemptCount < maxAttempts):**

   a. **Build Revision Prompt for Copywriter** (Code node):
      - System prompt: Same as Copywriter agent but with added context: "You are revising your copy based on JP Localization feedback"
      - User message: Original copy variants + critique issues from JP Localization + instruction to address each issue specifically
      - Same Copywriter tool schema (deliver_platform_copy)
      - Temperature: 0.7

   b. **Call Anthropic API** — Copywriter revision call

   c. **Parse Revised Copy** — update pipelineState.copywriter with revised variants

   d. **Increment attemptCount** (Code node): attemptCount++, add critique to critiqueHistory

   e. **Loop back** to step 4 (Build Review Prompt) — JP Localization reviews the revision

8. **AUTO-APPROVE ON FINAL ATTEMPT (If node: attemptCount >= maxAttempts):**
   - Set approved = true
   - Set qualityScore from the review
   - Add overallNote explaining auto-approval: "最大リビジョン回数に達しました。最善のバージョンで承認します。"
   - Flag as "要確認" (needs review) in jpLocalization output
   - The "flagged" status will show in the dashboard progress UI

9. **Send Progress: Complete** — agentStep with summaryJa (e.g., "JP確認 → 修正1回、承認済み" or "JP確認 → 要確認フラグ付き承認")
   - Send costEntries for ALL API calls in the loop (review + revision calls)

10. **Return Updated PipelineState** with jpLocalization populated and potentially revised copywriter.variants

**n8n Loop Implementation:**
Use an n8n If node + "Loop Over Items" pattern or manual loop via "Execute Sub-workflow" calling itself. The simpler approach: use a single sub-workflow with If branching — after the review, if not approved and under max attempts, use a second HTTP Request to Claude for the Copywriter revision, then another HTTP Request for JP Localization re-review. This avoids complex loop constructs.

Since maxAttempts = 2, the worst case is: Review #1 -> Revision #1 -> Review #2 (auto-approve). This is just 3 sequential HTTP Request nodes with If branching. No actual loop node needed.

**Wire into Master Orchestrator:**
- After the Copywriter/Art Director merge node, add Execute Sub-workflow → JP Localization Agent
- JP Localization receives the merged PipelineState (with both copywriter and artDirector populated)
  </action>
  <verify>
    - JP Localization sub-workflow created with critique loop
    - Max 2 total attempts (NOT 3) — auto-approves on attempt 2
    - Max 5 issues per review
    - Weighted criteria: naturalness 30%, register 25%, persuasiveness 20%, cultural 15%, platform 10%
    - Compliance flagging is lightweight strings only (no rewrites)
    - Master Orchestrator wires JP Localization after Copywriter/Art Director merge
    - "要確認" flag set when auto-approving on final attempt
  </verify>
  <done>
    - JP Localization sub-workflow reviews copy with 5 weighted criteria
    - Critique loop: if rejected, Copywriter revises and JP Localization re-reviews (max 2 total attempts)
    - Auto-approves on final attempt with "要確認" flag to prevent pipeline stall
    - Max 5 issues per review, lightweight compliance flags only
    - Cost tracking includes all API calls in the loop
    - Master Orchestrator dispatches after parallel agents merge
  </done>
</task>

</tasks>

<verification>
- All 3 sub-workflows exist in n8n
- Copywriter generates 4 variants per platform with correct register
- Art Director generates prompts without negativePrompt, with photorealism metadata
- JP Localization critique loop works: max 2 attempts, auto-approve on final
- Parallel branching in Master Orchestrator for Copywriter/Art Director confirmed
- No SB7 references in any prompt
- GENX-09 handled in Art Director
</verification>

<success_criteria>
- Copywriter and Art Director run in parallel, each generating structured output
- JP Localization can reject and trigger one revision pass
- On max attempts, JP Localization auto-approves with "要確認" flag (never blocks delivery)
- All agents send progress callbacks and cost entries
- Pipeline continues even if Copywriter or Art Director fails (partial delivery)
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-03-SUMMARY.md`
</output>
