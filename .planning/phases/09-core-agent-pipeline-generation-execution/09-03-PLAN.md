---
phase: 09-core-agent-pipeline-generation-execution
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - (n8n workflows via MCP)
autonomous: true
requirements: [ORCH-06, ORCH-07, ORCH-08, GENX-09]

must_haves:
  truths:
    - "Copywriter n8n sub-workflow generates 4 copy variants (A-D) per platform with correct register and framework"
    - "Art Director n8n sub-workflow generates Flux-compatible image prompts with productCategory, cameraLens, lightingSetup, compositionGuidance (no negativePrompt)"
    - "Copywriter and Art Director run in parallel after Creative Director completes"
    - "JP Localization sub-workflow reviews copy, can reject with critique, and Copywriter revises (max 2 total attempts; auto-approves on attempt 2)"
    - "Art Director infers visual defaults from brief content when brand profile is minimal (GENX-09)"
  artifacts:
    - path: "(n8n) Copywriter Agent sub-workflow"
      provides: "Platform-specific copy generation with 4 variants"
      contains: "deliver_platform_copy tool call"
    - path: "(n8n) Art Director Agent sub-workflow"
      provides: "Flux image prompt generation with photorealism metadata"
      contains: "deliver_art_direction tool call"
    - path: "(n8n) JP Localization Agent sub-workflow"
      provides: "Quality review with critique loop"
      contains: "deliver_localization_review tool call"
  key_links:
    - from: "Creative Director output"
      to: "Copywriter + Art Director (parallel)"
      via: "Parallel branch in Master Orchestrator"
      pattern: "pipelineState.creativeDirector"
    - from: "Copywriter output"
      to: "JP Localization"
      via: "Sequential after parallel merge"
      pattern: "pipelineState.copywriter"
    - from: "JP Localization critique"
      to: "Copywriter revision"
      via: "Loop inside JP Localization sub-workflow"
      pattern: "approved.*false.*issues"
---

<objective>
Build the Copywriter, Art Director, and JP Localization n8n sub-workflows. Copywriter and Art Director run in parallel after Creative Director. JP Localization reviews Copywriter output with a critique loop (max 2 total attempts).

Purpose: These three agents produce the creative output: copy variants for each platform, image prompts for Flux generation, and Japanese quality assurance. The JP Localization critique loop is the most complex n8n workflow pattern in the entire pipeline.

Output: 3 n8n sub-workflows wired into the Master Orchestrator with parallel branching for Copywriter/Art Director and sequential JP Localization after.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai/prompts/agents/copywriter.ts
@src/lib/ai/prompts/agents/art-director.ts
@src/lib/ai/prompts/agents/jp-localization.ts
@src/lib/ai/prompts/shared/register-map.ts
@src/lib/ai/prompts/shared/platform-norms.ts
@src/lib/ai/prompts/shared/flux-techniques.ts
@src/lib/ai/prompts/shared/quality-checklist.ts
@src/types/pipeline.ts
@.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-02-SUMMARY.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-03-SUMMARY.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1A: Create Copywriter n8n sub-workflow</name>
  <files>
    (n8n workflow via MCP)
  </files>
  <action>
Create the Copywriter Agent sub-workflow via `n8n_create_workflow`:

1. **Execute Workflow Trigger** — receives PipelineState with strategicInsight + creativeDirector

2. **Send Progress: Active** — agentStep: { agentName: "copywriter", labelJa: "コピーライティング中", status: "active" }

3. **Fetch Prompt from Build-Prompt Endpoint** (HTTP Request node):
   - POST to `${NEXTJS_BASE_URL}/api/internal/build-prompt`
   - Include X-Signature HMAC header
   - Body: `{ agentName: "copywriter", brief, brandProfile, agentConfig, mode, upstreamOutputs: { strategicInsight: pipelineState.strategicInsight, creativeDirector: pipelineState.creativeDirector } }`
   - Returns serialized { systemPrompt, userMessage, toolSchema, toolChoice, temperature, maxTokens }
   - Do NOT inline any prompt content — the endpoint handles register maps, platform norms, copywriting frameworks, and all domain knowledge from Phase 9.1 builders
   - Timeout: 10 seconds

4. **Call Anthropic API** (HTTP Request node):
   - POST to `https://api.anthropic.com/v1/messages`
   - Headers: x-api-key, anthropic-version: 2023-06-01, content-type: application/json
   - Body: Construct from build-prompt response — { model: agentConfig.copywriter.model, max_tokens: response.maxTokens, temperature: response.temperature, system: response.systemPrompt, messages: [{ role: "user", content: response.userMessage }], tools: [response.toolSchema], tool_choice: response.toolChoice }
   - Timeout: 180s (multiple platforms x 4 variants = large output)

5. **Parse Response** (Code node) — extract tool_use, write to pipelineState.copywriter, calculate cost entry

6. **Error Handling** — 1 silent retry, then partial delivery (NOT critical-stop). Mark as failed in agentErrors but continue pipeline.

7. **Send Progress: Complete/Failed** — agentStep with summaryJa + costEntries

8. **Return Updated PipelineState**
  </action>
  <verify>
    - Sub-workflow created with valid structure
    - Build-prompt HTTP Request node calls /api/internal/build-prompt with agentName "copywriter"
    - No inline prompt content in any n8n Code node
    - Partial delivery error handling (NOT critical-stop)
  </verify>
  <done>
    - Copywriter sub-workflow fetches prompt from build-prompt endpoint and generates 4 copy variants per platform
    - Partial-delivery agent (pipeline continues on failure)
    - Progress callbacks and cost tracking active
  </done>
</task>

<task type="auto">
  <name>Task 1B: Create Art Director n8n sub-workflow and wire parallel branch in Master Orchestrator</name>
  <files>
    (n8n workflow via MCP)
  </files>
  <action>
**A. Art Director Agent sub-workflow:**

Create via `n8n_create_workflow`:

1. **Execute Workflow Trigger** — receives PipelineState with strategicInsight + creativeDirector

2. **Send Progress: Active** — agentStep: { agentName: "art_director", labelJa: "アート設計中", status: "active" }

3. **Fetch Prompt from Build-Prompt Endpoint** (HTTP Request node):
   - POST to `${NEXTJS_BASE_URL}/api/internal/build-prompt`
   - Include X-Signature HMAC header
   - Body: `{ agentName: "artDirector", brief, brandProfile, agentConfig, mode, upstreamOutputs: { strategicInsight: pipelineState.strategicInsight, creativeDirector: pipelineState.creativeDirector } }`
   - Returns serialized { systemPrompt, userMessage, toolSchema, toolChoice, temperature, maxTokens }
   - The endpoint handles GENX-09 (infers visual defaults from brief when brand profile is minimal), camera/lens database, photorealism keywords, quality self-critique checklist, and Flux constraints — all from Phase 9.1 builders
   - The endpoint handles mode-dependent tool schema selection (auto: flat imagePrompts, pro: variations wrapper)
   - Do NOT inline any prompt content
   - Timeout: 10 seconds

4. **Call Anthropic API** (HTTP Request node):
   - POST to `https://api.anthropic.com/v1/messages`
   - Headers: x-api-key, anthropic-version: 2023-06-01, content-type: application/json
   - Body: Construct from build-prompt response — { model: agentConfig.artDirector.model, max_tokens: response.maxTokens, temperature: response.temperature, system: response.systemPrompt, messages: [{ role: "user", content: response.userMessage }], tools: [response.toolSchema], tool_choice: response.toolChoice }
   - CRITICAL: No negativePrompt field anywhere (Flux 1.1 Pro Ultra does not support it — enforced by Phase 9.1 tool schema)
   - Timeout: 180s

5. **Parse Response** (Code node) — extract tool_use, write to pipelineState.artDirector, calculate cost

6. **Error Handling** — 1 silent retry, then partial delivery (mark failed, continue)

7. **Send Progress: Complete/Failed** — agentStep + costEntries

8. **Return Updated PipelineState**

**B. Wire both Copywriter and Art Director into Master Orchestrator:**

Use `n8n_update_partial_workflow` to update the Master Orchestrator:
- After Creative Director, add a branch (parallel execution):
  - Branch 1: Execute Sub-workflow → Copywriter Agent (from Task 1A)
  - Branch 2: Execute Sub-workflow → Art Director Agent
- After both branches: Merge node that combines the two PipelineState outputs (take copywriter from Branch 1 and artDirector from Branch 2, merge into single PipelineState)
- After merge: proceed to JP Localization
  </action>
  <verify>
    - Art Director sub-workflow created with valid structure
    - Build-prompt HTTP Request node calls /api/internal/build-prompt with agentName "artDirector"
    - No inline prompt content in any n8n Code node
    - No negativePrompt field in any tool schema (enforced by Phase 9.1 builders via build-prompt endpoint)
    - GENX-09 handled by build-prompt endpoint (Art Director infers defaults when brand profile is minimal)
    - Master Orchestrator has parallel branch for Copywriter/Art Director with merge node
  </verify>
  <done>
    - Art Director sub-workflow fetches prompt from build-prompt endpoint and generates Flux image prompts with photorealism metadata
    - Both Copywriter and Art Director run in parallel after Creative Director in Master Orchestrator
    - Both are partial-delivery agents (pipeline continues on failure)
    - GENX-09: Art Director infers defaults when brand profile is minimal (handled by build-prompt endpoint)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JP Localization sub-workflow with critique loop</name>
  <files>
    (n8n workflows via MCP)
  </files>
  <action>
Create the JP Localization Agent sub-workflow — the most complex workflow due to the critique loop. Use `n8n_create_workflow`:

**Workflow structure:**

1. **Execute Workflow Trigger** — receives PipelineState with copywriter.variants populated

2. **Send Progress: Active** — agentStep: { agentName: "jp_localization", labelJa: "JP品質確認中", status: "active" }

3. **Initialize Loop State** (Code node):
   - Set attemptCount = 1
   - Set maxAttempts = 2 (per Phase 9.1: 2 total attempts, NOT 3)
   - Store original copy variants
   - Initialize critiqueHistory = []

4. **Fetch Review Prompt from Build-Prompt Endpoint** (HTTP Request node):
   - POST to `${NEXTJS_BASE_URL}/api/internal/build-prompt`
   - Include X-Signature HMAC header
   - Body: `{ agentName: "jpLocalization", brief, brandProfile, agentConfig, mode, upstreamOutputs: { copywriter: pipelineState.copywriter } }`
   - Returns serialized { systemPrompt, userMessage, toolSchema, toolChoice, temperature, maxTokens }
   - The endpoint handles all 5 weighted evaluation criteria (naturalness 30%, register 25%, persuasiveness 20%, cultural 15%, platform 10%), max 5 issues per review, compliance flagging, etc. from Phase 9.1 builders
   - Do NOT inline any prompt content
   - Timeout: 10 seconds

5. **Call Anthropic API** — timeout 120s, using prompt data from build-prompt response

6. **Parse Review Response** (Code node):
   - Extract tool_use content
   - If approved === true: write to pipelineState.jpLocalization, proceed to return
   - If approved === false AND attemptCount < maxAttempts: go to revision branch
   - If approved === false AND attemptCount >= maxAttempts: auto-approve with best available version (per Phase 9.1: auto-approve on final attempt to prevent pipeline stall)

7. **REVISION BRANCH (If node: approved === false AND attemptCount < maxAttempts):**

   a. **Fetch Revision Prompt from Build-Prompt Endpoint** (HTTP Request node):
      - POST to `${NEXTJS_BASE_URL}/api/internal/build-prompt`
      - Body: `{ agentName: "copywriter", brief, brandProfile, agentConfig, mode, upstreamOutputs: { strategicInsight, creativeDirector }, revisionContext: { attemptNumber: attemptCount, previousCritique: jpLocalizationReview, originalVariants: copywriterOutput } }`
      - The endpoint detects revisionContext and returns the Copywriter revision prompt variant
      - Do NOT inline Copywriter prompt content
      - Timeout: 10 seconds

   b. **Call Anthropic API** — Copywriter revision call using prompt from build-prompt response, temperature from response

   c. **Parse Revised Copy** — update pipelineState.copywriter with revised variants

   d. **Increment attemptCount** (Code node): attemptCount++, add critique to critiqueHistory

   e. **Fetch Re-review Prompt from Build-Prompt Endpoint** — same as step 4 but with revisionContext to include critique history

   f. **Call Anthropic API** — JP Localization re-review (auto-approves on this attempt since it is attempt 2)

8. **AUTO-APPROVE ON FINAL ATTEMPT (If node: attemptCount >= maxAttempts):**
   - Set approved = true
   - Set qualityScore from the review
   - Add overallNote explaining auto-approval: "最大リビジョン回数に達しました。最善のバージョンで承認します。"
   - Flag as "要確認" (needs review) in jpLocalization output
   - The "flagged" status will show in the dashboard progress UI

9. **Send Progress: Complete** — agentStep with summaryJa (e.g., "JP確認 → 修正1回、承認済み" or "JP確認 → 要確認フラグ付き承認")
   - Send costEntries for ALL API calls in the loop (review + revision calls)

10. **Return Updated PipelineState** with jpLocalization populated and potentially revised copywriter.variants

**n8n Loop Implementation:**
Since maxAttempts = 2, the worst case is: Review #1 -> Revision #1 -> Review #2 (auto-approve). This is just 3 sequential HTTP Request nodes (to build-prompt + to Anthropic) with If branching. No actual loop node needed.

**Wire into Master Orchestrator:**
- After the Copywriter/Art Director merge node, add Execute Sub-workflow → JP Localization Agent
- JP Localization receives the merged PipelineState (with both copywriter and artDirector populated)
  </action>
  <verify>
    - JP Localization sub-workflow created with critique loop
    - All prompt construction uses /api/internal/build-prompt (NO inline prompt content)
    - Revision branch also uses build-prompt endpoint for both Copywriter revision and JP re-review prompts
    - Max 2 total attempts (NOT 3) — auto-approves on attempt 2
    - "要確認" flag set when auto-approving on final attempt
    - Master Orchestrator wires JP Localization after Copywriter/Art Director merge
  </verify>
  <done>
    - JP Localization sub-workflow reviews copy using prompts from build-prompt endpoint
    - Critique loop: if rejected, Copywriter revision prompt fetched from build-prompt endpoint, then JP re-reviews
    - Auto-approves on final attempt with "要確認" flag to prevent pipeline stall
    - Cost tracking includes all API calls in the loop
    - Master Orchestrator dispatches after parallel agents merge
  </done>
</task>

</tasks>

<verification>
- All 3 sub-workflows exist in n8n
- All prompt construction uses /api/internal/build-prompt endpoint (NO inline prompt content in n8n)
- Copywriter generates 4 variants per platform with correct register (via build-prompt)
- Art Director generates prompts without negativePrompt (enforced by Phase 9.1 tool schema via build-prompt)
- JP Localization critique loop works: max 2 attempts, auto-approve on final
- Parallel branching in Master Orchestrator for Copywriter/Art Director confirmed
- GENX-09 handled via build-prompt endpoint (Art Director builder infers defaults)
</verification>

<success_criteria>
- Copywriter and Art Director run in parallel, each generating structured output
- JP Localization can reject and trigger one revision pass
- On max attempts, JP Localization auto-approves with "要確認" flag (never blocks delivery)
- All agents send progress callbacks and cost entries
- Pipeline continues even if Copywriter or Art Director fails (partial delivery)
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-03-SUMMARY.md`
</output>
