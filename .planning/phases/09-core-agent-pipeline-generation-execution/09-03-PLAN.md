---
phase: 09-core-agent-pipeline-generation-execution
plan: 03
type: execute
wave: 3
depends_on: [09-02]
files_modified: []
autonomous: true
requirements: [ORCH-06, ORCH-07, ORCH-08, GENX-09]

must_haves:
  truths:
    - "Copywriter agent generates per-platform copy variants (headline/body/cta/hashtags) using the selected framework (PAS/AIDA/BAB/SB7) and register from brand profile"
    - "Art Director agent generates Flux-compatible image prompts per platform with style, aspect ratio, and negative prompts"
    - "Art Director infers color palette and visual tone from brief content when brand profile has no colors or tone tags (GENX-09)"
    - "JP Localization agent reviews all copy variants for natural Japanese, correct keigo, and cultural fit -- with veto power"
    - "JP Localization critique loop runs max 2 retries (3 total attempts) -- if all rejected, delivers best of 3 with 要確認 flag"
    - "Copywriter and Art Director run in parallel after Creative Director completes"
  artifacts:
    - path: "n8n sub-workflow: Copywriter Agent"
      provides: "Per-platform copy variants via Claude tool-use"
      contains: "deliver_platform_copy tool"
    - path: "n8n sub-workflow: Art Director Agent"
      provides: "Flux image prompts per platform"
      contains: "deliver_image_prompts tool"
    - path: "n8n sub-workflow: JP Localization Agent"
      provides: "Copy review with critique loop and veto power"
      contains: "deliver_localization_review tool"
  key_links:
    - from: "Master Orchestrator parallel fork"
      to: "Copywriter + Art Director sub-workflows"
      via: "Two Execute Sub-workflow nodes running in parallel"
      pattern: "pipelineState.copywriter.*pipelineState.artDirector"
    - from: "Copywriter sub-workflow"
      to: "JP Localization sub-workflow"
      via: "Sequential in master orchestrator after Copywriter completes"
      pattern: "pipelineState.jpLocalization"
    - from: "JP Localization critique loop"
      to: "Copywriter revision call (within JP Localization sub-workflow)"
      via: "HTTP Request to Anthropic API with critique context"
      pattern: "revisionsApplied.*approved"
---

<objective>
Create the Copywriter, Art Director, and JP Localization agent sub-workflows in n8n, including the JP Localization critique loop with max 2 retries, and wire them into the master orchestrator with parallel execution for Copywriter/Art Director.

Purpose: These three agents produce the core creative output -- platform-specific copy, image prompts, and quality-assured Japanese copy. The critique loop is the most complex part of the pipeline, ensuring all copy meets Japanese quality standards.

Output: 3 n8n sub-workflows (Copywriter, Art Director, JP Localization with critique loop), master orchestrator updated with parallel fork and real sub-workflow IDs.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-CONTEXT.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-RESEARCH.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-02-SUMMARY.md
@src/types/pipeline.ts
@src/lib/platforms/copy-constraints.ts
@src/lib/ai/prompts/copy-generation.ts
@src/lib/ai/prompts/image-generation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Copywriter and Art Director sub-workflows in n8n</name>
  <files>
    (n8n workflows via MCP tools)
  </files>
  <action>
**Part A: Copywriter Agent Sub-Workflow**

Create via `mcp__n8n-mcp__n8n_create_workflow`.

1. **Execute Workflow Trigger** -- receives full pipeline data

2. **Build Copywriter Prompt (Code node):**
   - System prompt: Senior Japanese copywriter specializing in digital advertising
   - Includes the selected copywriting framework from `pipelineState.strategicInsight.copywritingFramework` with detailed instructions:
     - PAS: Identify the pain point, agitate it, then present the solution
     - AIDA: Hook attention, build interest, create desire, prompt action
     - BAB: Paint the before picture, show the after, bridge with the product
     - SB7: Position the customer as hero, brand as guide, through the StoryBrand framework
   - Includes tonal guidance from strategicInsight and register from brandProfile
   - Includes platform-specific constraints: read character limits from the existing `copy-constraints.ts` patterns (LINE rich message: headline 20 chars, body 50 chars; Instagram: 2200 char caption; X/Twitter: 140 chars; etc.)
   - For each platform in `brief.platforms`, generate 4 variants (A案, B案, C案, D案)
   - Each variant has: headline, body, cta, hashtags
   - Register must match `brief.registerOverride || brandProfile.defaultRegister`
   - **Critical instruction:** "あなたの判断を日本語で約10語にまとめてください（summaryJaフィールド）。"
   - Temperature: 0.7 (creative writing benefits from variety)
   - Model: `agentConfig.copywriter.model`

3. **Tool definition:**
   ```json
   {
     "name": "deliver_platform_copy",
     "input_schema": {
       "type": "object",
       "properties": {
         "variants": {
           "type": "array",
           "items": {
             "type": "object",
             "properties": {
               "platform": { "type": "string" },
               "variantLabel": { "type": "string" },
               "headline": { "type": "string" },
               "body": { "type": "string" },
               "cta": { "type": "string" },
               "hashtags": { "type": "array", "items": { "type": "string" } },
               "register": { "type": "string" }
             },
             "required": ["platform", "variantLabel", "headline", "body", "cta", "hashtags", "register"]
           }
         },
         "summaryJa": { "type": "string" }
       },
       "required": ["variants", "summaryJa"]
     }
   }
   ```

4. **HTTP Request to Anthropic API** -- same pattern as Strategic Insight
5. **Parse response, update pipelineState.copywriter, send progress callback + cost entry**
6. **Error handling:** partial-delivery agent. On failure after retry: set `pipelineState.copywriter` to null, add to agentErrors, pipeline continues

**Part B: Art Director Agent Sub-Workflow**

Create via `mcp__n8n-mcp__n8n_create_workflow`.

1. **Execute Workflow Trigger**

2. **Build Art Director Prompt (Code node):**
   - System prompt: Senior art director and visual designer specializing in Japanese advertising
   - Receives visual concept, color guidance, composition notes, mood keywords from `pipelineState.creativeDirector`
   - Generates Flux-compatible image prompts (English prompts only -- no Japanese text in image prompts, as Flux renders text poorly)
   - Each prompt includes: style description, aspect ratio (based on platform), negative prompt
   - **GENX-09 brand profile inference:** The prompt MUST include this instruction:
     "If the brand profile has no colors specified (colors is null), infer an appropriate color palette from the product type, campaign mood tags, and target audience. If toneTags is empty or null, infer the visual tone from the brief's objective and creative direction. Always include explicit color and style directions in the image prompt, never leave them unspecified."
   - Per-platform aspect ratios: Instagram (1:1, 4:5, 9:16), LINE (1:1), X (16:9), TikTok (9:16), Yahoo JAPAN (16:9), Rakuten (1:1), Email (16:9 header)
   - Temperature: 0.6
   - Model: `agentConfig.artDirector.model`

3. **Tool definition:**
   ```json
   {
     "name": "deliver_image_prompts",
     "input_schema": {
       "type": "object",
       "properties": {
         "imagePrompts": {
           "type": "array",
           "items": {
             "type": "object",
             "properties": {
               "platform": { "type": "string" },
               "prompt": { "type": "string" },
               "negativePrompt": { "type": "string" },
               "style": { "type": "string" },
               "aspectRatio": { "type": "string" }
             },
             "required": ["platform", "prompt", "style", "aspectRatio"]
           }
         },
         "summaryJa": { "type": "string" }
       },
       "required": ["imagePrompts", "summaryJa"]
     }
   }
   ```

4. **HTTP Request, parse, update pipelineState.artDirector, progress callback + cost entry**
5. **Error handling:** partial-delivery agent. Same as Copywriter.

Record both sub-workflow IDs for the master orchestrator update.

  </action>
  <verify>
Both sub-workflows exist in n8n. Copywriter generates per-platform copy with 4 variants per platform using the selected framework. Art Director generates Flux image prompts with platform-specific aspect ratios. Both include GENX-09 inference fallback for minimal brand profiles. Both send progress callbacks with Japanese summaries and cost entries. Validate with `mcp__n8n-mcp__n8n_validate_workflow`.
  </verify>
  <done>
Copywriter sub-workflow creates 4 copy variants per platform using the selected copywriting framework with correct register. Art Director sub-workflow creates Flux-compatible image prompts with platform-specific aspect ratios, including brand profile inference fallback for missing colors/tone. Both are partial-delivery agents with 1 auto-retry. Both produce Japanese summaries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JP Localization sub-workflow with critique loop and wire all into master orchestrator</name>
  <files>
    (n8n workflows via MCP tools)
  </files>
  <action>
**Part A: JP Localization Agent Sub-Workflow with Critique Loop**

This is the most complex sub-workflow due to the internal revision loop. Create via `mcp__n8n-mcp__n8n_create_workflow`.

**Sub-workflow structure:**

1. **Execute Workflow Trigger** -- receives pipeline data including `pipelineState.copywriter.variants`

2. **Initialize Loop State (Code node):**
   ```javascript
   const pipelineState = $input.first().json.pipelineState;
   const currentVariants = pipelineState.copywriter.variants;
   return {
     json: {
       ...($input.first().json),
       attemptNumber: 1,
       maxAttempts: 3,
       currentVariants: currentVariants,
       allAttempts: [currentVariants],  // Track all versions for best-of-3 selection
       allScores: []
     }
   };
   ```

3. **Build JP Review Prompt (Code node):**
   - System prompt: Expert Japanese language and cultural consultant for advertising
   - Review criteria (from Context decisions):
     - Unnatural Japanese (grammar, word choice, particle usage, sentence flow)
     - Wrong register/keigo level (mismatched to brand's default register)
     - Cultural fit issues (inappropriate idioms, wrong directness level, missing seasonal references, JP marketing conventions)
     - JP marketing convention violations (overly direct CTAs, missing honorifics where expected)
   - Input: all copy variants from current attempt + brand profile (register, tone, target market)
   - Output via tool-use: approval decision, issues list (if rejecting), quality score 0-100, overall note
   - **Critical instruction:** "あなたの判断を日本語で約10語にまとめてください（summaryJaフィールド）。"
   - Temperature: 0.2 (quality evaluation should be consistent)
   - Model: `agentConfig.jpLocalization.model`

4. **Tool definitions (two tools in one call):**
   ```json
   {
     "name": "deliver_localization_review",
     "input_schema": {
       "type": "object",
       "properties": {
         "approved": { "type": "boolean" },
         "qualityScore": { "type": "number", "minimum": 0, "maximum": 100 },
         "issues": {
           "type": "array",
           "items": {
             "type": "object",
             "properties": {
               "platform": { "type": "string" },
               "variant": { "type": "string" },
               "field": { "type": "string" },
               "issue": { "type": "string" },
               "suggestion": { "type": "string" }
             }
           }
         },
         "overallNote": { "type": "string" },
         "summaryJa": { "type": "string" }
       },
       "required": ["approved", "qualityScore", "issues", "overallNote", "summaryJa"]
     }
   }
   ```

5. **HTTP Request to Anthropic API** (JP review)

6. **Parse Review Response (Code node):**
   - Extract approval decision and quality score
   - Store score in `allScores` array

7. **If Node: Check Approved**
   - **True branch (approved):** Go to step 10 (Return Approved)
   - **False branch (rejected):** Go to step 8 (Check Retry Budget)

8. **Check Retry Budget (If node):**
   - Condition: `attemptNumber < maxAttempts` (i.e., attempts 1 and 2 can retry)
   - **True:** Go to step 9 (Copywriter Revision)
   - **False (attempt 3, max reached):** Go to step 11 (Select Best of 3)

9. **Copywriter Revision (Code node + HTTP Request):**
   - Build revision prompt for Copywriter agent: includes original copy variants, critique from JP Localization (issues list + overallNote), and instruction to fix specific issues
   - Call Anthropic API with `deliver_platform_copy` tool (same as Copywriter agent)
   - Parse revised variants
   - Update `currentVariants` with revised copy
   - Push revised variants to `allAttempts` array
   - Increment `attemptNumber`
   - **Loop back** to step 3 (Build JP Review Prompt) -- use n8n's loop/goto pattern (connect the output of step 9 back to step 3's input)

10. **Return Approved (Code node):**
    - Set `pipelineState.jpLocalization = { approved: true, revisionsApplied: attemptNumber - 1, localizationNotes: overallNote, qualityScore }`
    - Update `pipelineState.copywriter.variants` with the approved variants (may be revised)
    - Send progress callback: `{ agentName: "jp_localization", status: "complete", summaryJa: "JP確認 → 修正{N}回、全文承認" }`

11. **Select Best of 3 (Code node):**
    - Compare `allScores` array -- select the attempt with highest qualityScore
    - Set `pipelineState.jpLocalization = { approved: false, revisionsApplied: 2, localizationNotes: "最大リトライ回数に達しました。最高スコアの試行を採用。", qualityScore: bestScore }`
    - Update `pipelineState.copywriter.variants` with best attempt's variants
    - Mark campaign as "要確認" (needs review) -- set a flag in pipelineState: `pipelineState.jpLocalization.needsReview = true`
    - Send progress callback: `{ agentName: "jp_localization", status: "flagged", summaryJa: "JP確認 → 要確認（3回目でも基準未達）" }`
    - **Never block delivery** -- pipeline continues

12. **Return updated PipelineState** (sub-workflow output)

**Cost tracking:** Each Anthropic API call (JP review + each Copywriter revision) sends a cost entry in the progress callback.

**Part B: Wire Copywriter, Art Director, JP Localization into Master Orchestrator**

Use `mcp__n8n-mcp__n8n_update_partial_workflow` to update the master orchestrator:

1. After Creative Director completes, create a **parallel fork** (two branches):
   - **Branch A:**
     - Progress callback: Copywriter active
     - Execute Sub-workflow: Copywriter (wait for completion)
     - Progress callback: Copywriter complete
     - Progress callback: JP Localization active
     - Execute Sub-workflow: JP Localization (wait for completion)
     - Progress callback: JP Localization complete
   - **Branch B:**
     - Progress callback: Art Director active
     - Execute Sub-workflow: Art Director (wait for completion)
     - Progress callback: Art Director complete

2. After both branches complete, **merge** and continue to generation sub-workflows

3. Error handling on Copywriter/Art Director/JP Localization Execute Sub-workflow nodes: `onError: "continue"` (partial-delivery agents)

4. After merge: Code node checks which agents succeeded and which failed, builds appropriate progress update

  </action>
  <verify>
JP Localization sub-workflow has the critique loop: review -> if rejected -> copywriter revision -> review again (up to 3 total attempts). On max retries, selects best of 3 and flags as 要確認. Master orchestrator has parallel Copywriter/Art Director fork after Creative Director, with JP Localization following Copywriter. All progress callbacks fire with Japanese labels. Validate all workflows with `mcp__n8n-mcp__n8n_validate_workflow`.
  </verify>
  <done>
JP Localization sub-workflow with full critique loop: review, reject with structured critique, Copywriter revision, re-review, max 3 attempts, best-of-3 selection on exhaustion, 要確認 flag on failure. Master orchestrator has parallel fork for Copywriter/Art Director, JP Localization follows Copywriter, merge before generation. All 3 agents are partial-delivery with progress callbacks and cost tracking.
  </done>
</task>

</tasks>

<verification>
1. Copywriter generates copy variants per platform using selected framework with correct register
2. Art Director generates Flux image prompts with platform-specific aspect ratios
3. Art Director handles missing brand profile colors/tone by inferring from brief content (GENX-09)
4. JP Localization reviews copy for natural Japanese, keigo, and cultural fit
5. Critique loop: rejected copy -> Copywriter revision -> re-review (max 3 attempts)
6. Max retries exhausted: best-of-3 selection with 要確認 flag, never blocks delivery
7. Copywriter and Art Director run in parallel in the master orchestrator
8. All agents send progress callbacks with Japanese labels and summaries
9. All agents send cost entries for each API call
</verification>

<success_criteria>
- Copywriter produces per-platform copy variants using the framework selected by Strategic Insight
- Art Director produces Flux-compatible image prompts with correct aspect ratios and brand inference
- JP Localization critique loop runs correctly with max 2 retries
- Pipeline never blocks on quality gate exhaustion (delivers best attempt with flag)
- Parallel execution of Copywriter and Art Director saves pipeline time
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-03-SUMMARY.md`
</output>
