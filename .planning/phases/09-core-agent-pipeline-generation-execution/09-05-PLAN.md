---
phase: 09-core-agent-pipeline-generation-execution
plan: 05
type: execute
wave: 5
depends_on: ["09-04"]
files_modified:
  - src/app/api/internal/video-pipeline/route.ts
  - src/app/api/campaigns/[id]/download/route.ts
  - src/lib/platforms/zip-packager.ts
  - src/components/campaign/strategy-accordion.tsx
  - src/app/campaigns/[id]/page.tsx
  - (n8n workflows via MCP)
autonomous: false
requirements: [GENX-03, GENX-04, GENX-05, GENX-07, GENX-08]

must_haves:
  truths:
    - "Video/audio/avatar pipeline runs asynchronously after campaign marks complete with copy+images"
    - "Strategy accordion shows plain-language Japanese conclusions between campaign header and tab bar (collapsed by default, steel-blue accent)"
    - "Campaign ZIP download includes all generated assets organized by platform"
    - "Provider failure results in partial delivery (video failure does not block copy/image delivery)"
    - "Circuit breaker tracks provider failures and routes around them"
  artifacts:
    - path: "src/app/api/internal/video-pipeline/route.ts"
      provides: "Video pipeline endpoint callable from n8n"
      exports: ["POST"]
    - path: "src/components/campaign/strategy-accordion.tsx"
      provides: "Collapsible strategy summary with steel-blue accent"
      contains: "StrategyAccordion"
    - path: "(n8n) Video Pipeline sub-workflow"
      provides: "Async video/audio/avatar generation"
      contains: "video_pipeline"
    - path: "src/app/api/campaigns/[id]/download/route.ts"
      provides: "ZIP download endpoint with all campaign assets"
      exports: ["GET"]
  key_links:
    - from: "Master Orchestrator"
      to: "Video Pipeline sub-workflow"
      via: "Execute Sub-workflow with waitForSubWorkflow: false (async)"
      pattern: "video_pipeline"
    - from: "pipelineState.strategicInsight"
      to: "src/components/campaign/strategy-accordion.tsx"
      via: "Campaign progress.pipelineState stored in DB"
      pattern: "strategicInsight.*awarenessLevel"

user_setup: []
---

<objective>
Build the async video/audio/avatar pipeline, the strategy accordion UI component, and complete the end-to-end pipeline with ZIP download verification.

Purpose: Complete the remaining generation sub-workflows (video, audio, avatar) as an async fork that runs after the main campaign is marked complete. Add the strategy accordion that surfaces AI reasoning as plain-language Japanese conclusions. Verify the ZIP download includes all assets.

Output: Internal video pipeline endpoint, n8n async video sub-workflow, strategy accordion component, end-to-end pipeline checkpoint.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai/video-pipeline.ts
@src/lib/ai/provider-health.ts
@src/lib/platforms/zip-packager.ts
@src/types/pipeline.ts
@.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video pipeline internal endpoint and n8n async sub-workflow</name>
  <files>
    src/app/api/internal/video-pipeline/route.ts
    (n8n workflow via MCP)
  </files>
  <action>
**A. Video Pipeline Internal Endpoint** (`src/app/api/internal/video-pipeline/route.ts`):

```typescript
export const maxDuration = 300

export async function POST(request: Request) {
  // 1. Verify HMAC signature (same pattern as other internal endpoints)
  // 2. Parse body: { campaignId, brief, copyText, compositedImageUrls, platforms }
  // 3. Call runVideoPipeline() from src/lib/ai/video-pipeline.ts
  //    - Pass updateProgress callback that sends progress callbacks to the campaign
  // 4. For each video result: download to Supabase Storage, insert asset record
  // 5. For voiceover: upload buffer to storage, insert audio asset
  // 6. For avatar video: download and insert
  // 7. Send completion callback to campaign (video assets available)
  // 8. Return { videos, voiceover, avatarVideo } summary
}
```

The existing `runVideoPipeline()` handles:
- ElevenLabs Japanese voiceover (GENX-04)
- Kling video generation (GENX-03 — fal.ai)
- Runway cinematic video (GENX-03 — Gen-4 API)
- HeyGen avatar video (GENX-05 — from voiceover + visual direction)
- Automatic fallback routing via `ProviderHealthTracker` circuit breaker (GENX-08)

The circuit breaker is in-memory in the Next.js server. Since n8n calls the internal endpoint, the circuit breaker works automatically.

**B. Video Pipeline n8n Sub-workflow:**

1. **Execute Workflow Trigger** — receives PipelineState + image generation results

2. **Send Progress: Active** — agentStep: { agentName: "video_pipeline", labelJa: "動画生成中", status: "active" }

3. **Build Request** (Code node):
   - Extract campaignId, brief, platforms from PipelineState
   - Extract compositedImageUrls from image generation results
   - Extract first copy variant text for voiceover script
   - Sign with HMAC

4. **Call Internal API** (HTTP Request node):
   - POST to `${NEXTJS_BASE_URL}/api/internal/video-pipeline`
   - Timeout: 300 seconds (video generation is slow)

5. **Parse Response** — extract video/audio/avatar results

6. **Send Progress: Complete/Failed** — agentStep with summaryJa

7. **Return** — does not need to return to orchestrator (async fork)

**Wire into Master Orchestrator:**
After the resize sub-workflow completes:
1. Send "complete" callback to Next.js (campaign delivers copy + images immediately)
2. Fork: Execute Sub-workflow → Video Pipeline with `waitForSubWorkflow: false` (ASYNC — orchestrator does not wait)
3. Video pipeline sends its own callbacks as assets complete
4. Dashboard receives video assets via Supabase Realtime

This implements the context decision: "campaign delivers copy+images immediately, video arrives later via Realtime."

**GENX-08 (Circuit breaker):**
Already implemented in `src/lib/ai/provider-health.ts` — 3 consecutive failures open the circuit, 5-minute cooldown. Used automatically by `runVideoPipeline()` which checks provider health before each call.
  </action>
  <verify>
    - Internal video-pipeline endpoint exists and is HMAC-protected
    - `npx tsc --noEmit` passes
    - n8n sub-workflow created and calls the endpoint
    - Master Orchestrator forks video pipeline asynchronously after sending "complete" callback
    - GENX-08: `grep -r "providerHealth\|ProviderHealth" src/lib/ai/video-pipeline.ts` returns matches (circuit breaker active)
  </verify>
  <done>
    - Video pipeline runs asynchronously after campaign is marked complete
    - Copy + images deliver immediately; video arrives later via Realtime
    - ElevenLabs, Kling, Runway, HeyGen all routed through existing providers with circuit breaker
  </done>
</task>

<task type="auto">
  <name>Task 1B: Verify and conditionally create ZIP download endpoint (GENX-07)</name>
  <files>
    src/app/api/campaigns/[id]/download/route.ts
    src/lib/platforms/zip-packager.ts
  </files>
  <action>
GENX-07 requires campaign ZIP download containing all generated assets organized by platform.

**Step 1: Verify existing endpoint**
Run `grep -r "buildCampaignZip" src/app/api/` to confirm a download endpoint already exists.

**Step 2: If endpoint exists** (expected — found at `src/app/api/campaigns/[id]/download/route.ts`):
- Read the existing endpoint and verify it:
  a. Calls `buildCampaignZip()` from `src/lib/platforms/zip-packager.ts`
  b. Includes all asset types: base images, composited images, platform-resized images
  c. Organizes assets by platform folder (LINE/, Instagram/, X/)
  d. Includes copy variants as a text/JSON file in the ZIP
  e. Returns Content-Type: application/zip with Content-Disposition: attachment
- If any of the above are missing, add them to the existing endpoint/packager

**Step 3: If endpoint does NOT exist:**
Create `src/app/api/campaigns/[id]/download/route.ts`:
```typescript
export async function GET(request: Request, { params }: { params: { id: string } }) {
  // 1. Authenticate user (verify session)
  // 2. Load campaign with all assets from DB
  // 3. Call buildCampaignZip(campaignId, assets) from zip-packager.ts
  // 4. Return ZIP as streaming response with Content-Type: application/zip
}
```

**Step 4: Verify ZIP includes v1.1 pipeline assets**
The v1.1 pipeline generates additional asset types (per-platform resized images, composited images). Verify `buildCampaignZip()` includes these by checking it queries all asset types from the assets table, not just base images.

If the ZIP packager only handles base images, update `src/lib/platforms/zip-packager.ts` to also include:
- Composited images (images with Japanese text overlay)
- Platform-resized images (organized by platform subfolder)
- Copy variants export (JSON or TXT with all 4 variants per platform)
  </action>
  <verify>
    - `grep -r "buildCampaignZip" src/app/api/` returns at least 1 match (download endpoint exists)
    - `npx tsc --noEmit` passes
    - Download endpoint returns Content-Type application/zip
    - ZIP packager includes composited and resized images (not just base images)
  </verify>
  <done>
    - GENX-07: ZIP download endpoint exists and includes all v1.1 pipeline assets
    - Assets organized by platform folder
    - Copy variants included in the ZIP
  </done>
</task>

<task type="auto">
  <name>Task 2: Create strategy accordion component and wire into campaign detail page</name>
  <files>
    src/components/campaign/strategy-accordion.tsx
    src/app/campaigns/[id]/page.tsx
  </files>
  <action>
**A. Strategy Accordion Component** (`src/components/campaign/strategy-accordion.tsx`):

Create a new React component that displays strategic reasoning as plain-language Japanese conclusions.

```typescript
"use client"

interface StrategyAccordionProps {
  strategicInsight: {
    awarenessLevel: string
    lf8Desires: string[]
    copywritingFramework: string
    targetInsight: string
    creativeDirection: string
    keyMessages: string[]
    tonalGuidance: string
    summaryJa?: string
  }
}
```

**Rendering logic:**
- Collapsed by default (local state toggle)
- Header: Steel-blue background (#6B8FA3), white text, "戦略サマリー" label with chevron icon
- Expand/collapse via smooth CSS `max-height` transition (transition-all duration-300)
- Expanded content: 2-3 lines of plain-language Japanese conclusions
- Transform internal classification into user-friendly text:
  - Map awarenessLevel to Japanese description (e.g., "problem_aware" -> "お客様の課題認識に焦点を当てたアプローチ")
  - Map LF8 desires to Japanese plain-language (e.g., "freedom_from_fear" -> "安心感への欲求")
  - Do NOT display: "Schwartz Level 2", "LF8-3", "PAS Framework", framework names, codes, or classification labels
  - Do NOT display any English text
- Show summaryJa if available as the first line
- Show 2-3 additional lines combining targetInsight and creativeDirection in natural Japanese
- Styling: rounded-lg border, steel-blue accent color, consistent with project design system
- SuperDesign reference: draft `fec4e0bf-302f-4b8e-ac60-bfd1caff9bb9`

**B. Wire into Campaign Detail Page:**

Read `src/app/campaigns/[id]/page.tsx` and add the StrategyAccordion between the campaign header and the tab bar (asset tabs).

- Only render when `progress.pipelineState?.strategicInsight` exists (v1.1 pipeline only)
- Pass strategicInsight data from the stored pipelineState
- For v1.0 campaigns (no pipelineState), do not render the accordion

**User decision compliance:**
- "Show strategic reasoning as plain-language Japanese conclusions — never expose framework names, codes, or classification labels"
- "Protects proprietary methodology while building user trust"
- "Collapsed by default, steel-blue accent, expands to show 2-3 lines of strategy summary"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - StrategyAccordion component exists and renders with test data
    - No English text visible in the accordion
    - No framework names (PAS, AIDA, Schwartz, LF8) visible in the rendered output
    - Component is placed between campaign header and tab bar
    - Collapsed by default, expands on click
  </verify>
  <done>
    - Strategy accordion shows plain-language Japanese conclusions
    - Collapsed by default with steel-blue (#6B8FA3) accent
    - Smooth expand/collapse transition
    - Never exposes framework names, codes, or classification labels
    - Placed between campaign header and tab bar in campaign detail page
    - Only renders for v1.1 pipeline campaigns
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end pipeline verification checkpoint</name>
  <files>
    (no files — human verification)
  </files>
  <action>
    Human verifies the complete n8n 7-agent pipeline from webhook to campaign delivery:
    1. Master Orchestrator receives campaign brief via webhook
    2. Strategic Insight classifies brief (Schwartz/LF8/framework)
    3. Creative Director generates visual and copy direction
    4. Copywriter (4 variants per platform) and Art Director (Flux prompts) run in parallel
    5. JP Localization reviews copy with critique loop (max 2 attempts)
    6. Image generation, compositing, and resize produce platform-ready assets
    7. Video/audio/avatar pipeline runs asynchronously
    8. Dashboard shows per-agent progress timeline with Japanese labels
    9. Strategy accordion shows plain-language conclusions
    10. Campaign ZIP includes all assets organized by platform

    Steps:
    1. Set N8N_WEBHOOK_URL in .env.local to the Master Orchestrator webhook URL
    2. Set N8N_WEBHOOK_SECRET in both Next.js and n8n
    3. Create a test campaign via the dashboard with a Japanese cosmetics brief
    4. Verify:
       a. Per-agent progress timeline appears with Japanese labels
       b. Each agent completes and shows a summaryJa line
       c. Images are generated and composited with Japanese text
       d. Platform-resized images appear
       e. Campaign completes with copy + images
       f. Strategy accordion is visible (collapsed) on the campaign detail page
       g. Expanding the accordion shows plain-language Japanese conclusions (no framework names)
       h. Video generation starts asynchronously (check n8n execution log)
       i. Download ZIP contains all assets organized by platform folders
    5. Test edge case: Submit a brief with minimal brand profile — verify Art Director infers defaults
    6. Test JP Localization: If copy gets rejected on first review, verify revision loop and auto-approve on attempt 2
  </action>
  <verify>Type "approved" to confirm the pipeline works end-to-end, or describe any issues found</verify>
  <done>
    - Complete n8n pipeline executes end-to-end from webhook to campaign delivery
    - Per-agent progress, strategy accordion, and ZIP download all work correctly
    - JP Localization critique loop and partial delivery on failure both function
  </done>
</task>

</tasks>

<verification>
- Video pipeline runs async after main campaign completes
- Strategy accordion shows Japanese conclusions without exposing framework names
- GENX-07: ZIP download endpoint exists and includes all v1.1 pipeline assets (composited, resized, copy variants)
- GENX-08: Circuit breaker protects video pipeline via providerHealth in video-pipeline.ts
- All text visible to users is in Japanese
</verification>

<success_criteria>
- Complete end-to-end pipeline: webhook -> 5 agents -> generation -> delivery
- Campaign delivers copy+images immediately, video arrives later
- Strategy accordion visible on campaign detail page with plain-language Japanese
- ZIP packaging works with all generated assets
- Provider failures result in partial delivery, not pipeline crash
- Human verifies the complete pipeline works via test campaign
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-05-SUMMARY.md`
</output>
