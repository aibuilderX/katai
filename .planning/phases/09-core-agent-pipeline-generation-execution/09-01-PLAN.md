---
phase: 09-core-agent-pipeline-generation-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/pipeline.ts
  - src/lib/db/schema.ts
  - src/app/api/webhooks/n8n/route.ts
  - src/components/campaign/generation-progress.tsx
  - src/hooks/use-campaign-progress.ts
autonomous: true
requirements: [ORCH-02]

must_haves:
  truths:
    - "Master orchestrator n8n workflow receives a webhook POST and initializes PipelineState"
    - "Per-agent progress steps with Japanese labels and summaries appear in the dashboard during generation"
    - "Callback handler accepts agentStep updates and merges them into campaign progress"
    - "Campaign record stores the full pipelineState JSONB on pipeline completion"
  artifacts:
    - path: "src/types/pipeline.ts"
      provides: "AgentStep interface and agentSteps array in CampaignProgress"
      contains: "AgentStep"
    - path: "src/app/api/webhooks/n8n/route.ts"
      provides: "agentStep callback handling and pipelineState persistence"
      contains: "agentStep"
    - path: "src/components/campaign/generation-progress.tsx"
      provides: "Per-agent vertical timeline with Japanese labels and summaries"
      contains: "agentSteps"
  key_links:
    - from: "n8n master orchestrator (webhook)"
      to: "src/app/api/webhooks/n8n/route.ts"
      via: "HMAC-signed POST with agentStep payload"
      pattern: "agentStep.*status"
    - from: "src/app/api/webhooks/n8n/route.ts"
      to: "src/components/campaign/generation-progress.tsx"
      via: "Supabase Realtime on campaigns.progress column"
      pattern: "agentSteps"
---

<objective>
Build the n8n Master Orchestrator workflow foundation and the Next.js infrastructure for per-agent progress reporting. This is the backbone that all subsequent agent sub-workflows plug into.

Purpose: Establish the webhook-to-dashboard pipeline that receives campaign briefs, initializes PipelineState, dispatches to agent sub-workflows sequentially, and reports per-agent progress to the dashboard in real time with Japanese labels and summaries.

Output: n8n master orchestrator workflow (with placeholder Execute Sub-workflow nodes for agents built in later plans), expanded pipeline types, callback handler with agentStep support, and redesigned progress UI component.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/pipeline.ts
@src/app/api/webhooks/n8n/route.ts
@src/components/campaign/generation-progress.tsx
@src/hooks/use-campaign-progress.ts
@src/lib/db/schema.ts
@src/app/api/campaigns/route.ts
@.planning/phases/08-infrastructure-schema-foundation/08-02-SUMMARY.md
@.planning/phases/09.1-agent-prompt-engineering-photorealistic-output/09.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AgentStep types, pipelineState column, and extend callback handler</name>
  <files>
    src/types/pipeline.ts
    src/lib/db/schema.ts
    src/app/api/webhooks/n8n/route.ts
  </files>
  <action>
1. In `src/types/pipeline.ts`, add an `AgentStep` interface after `PipelineMilestone`:
```typescript
export interface AgentStep {
  agentName: "strategic_insight" | "creative_director" | "copywriter" | "art_director" | "jp_localization" | "image_generation" | "compositing" | "platform_resize" | "video_pipeline"
  labelJa: string
  status: "pending" | "active" | "complete" | "failed" | "flagged"
  summaryJa?: string
  startedAt?: string
  completedAt?: string
}
```

Add an `AGENT_STEP_DEFINITIONS` constant with all agent step definitions and their Japanese labels:
- strategic_insight: "戦略分析中"
- creative_director: "クリエイティブ設計中"
- copywriter: "コピーライティング中"
- art_director: "アート設計中"
- jp_localization: "JP品質確認中"
- image_generation: "画像生成中"
- compositing: "テキスト合成中"
- platform_resize: "リサイズ中"
- video_pipeline: "動画生成中"

Add `agentStep?: AgentStep` to `N8nCallbackPayload`.

2. In `src/lib/db/schema.ts`, add `agentSteps` to `CampaignProgress` interface:
```typescript
agentSteps?: import("@/types/pipeline").AgentStep[]
```

3. In `src/app/api/webhooks/n8n/route.ts`:
- Add `agentStep` to the local `N8nWebhookPayload` type
- Add a handler block after the milestone handler that processes `agentStep` updates:
  - Read current progress from DB
  - If `agentSteps` array does not exist yet, initialize it from `AGENT_STEP_DEFINITIONS` (all pending)
  - Find the agent step by `agentName` and merge the update (status, summaryJa, startedAt, completedAt)
  - Write merged progress back to DB
- Add handling for `pipelineState` on `status === "success"` callbacks: store in a `pipelineState` JSONB field on the campaign. Since adding a column requires a Supabase migration, instead store pipelineState inside the existing `progress` JSONB as `progress.pipelineState`. This avoids a schema migration while keeping the data accessible.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - AgentStep interface exists in pipeline.ts
    - agentSteps field exists in CampaignProgress
    - Callback handler has agentStep processing block
  </verify>
  <done>
    - AgentStep type is defined with all 9 agent names and Japanese labels
    - CampaignProgress includes optional agentSteps array
    - Callback handler merges agentStep updates into campaign progress
    - PipelineState is stored in progress.pipelineState on completion
  </done>
</task>

<task type="auto">
  <name>Task 2: Redesign generation-progress.tsx for per-agent timeline</name>
  <files>
    src/components/campaign/generation-progress.tsx
  </files>
  <action>
Rewrite the generation progress component to display per-agent vertical timeline when v1.1 pipeline is detected (agentSteps present in progress), while preserving the v1.0 flat step display as fallback.

**v1.1 Progress Display (when `progress.agentSteps` exists):**
- Replace the flat copy/image/voiceover/video/avatar steps with a vertical timeline of agent steps
- Each step shows:
  - Left: Status icon (pending = gray circle, active = spinning Loader2 in vermillion, complete = green CheckCircle2, failed = red AlertCircle, flagged = amber AlertTriangle)
  - Center: Japanese label (`labelJa`) in medium weight when active, muted when pending
  - Right: When complete, show `summaryJa` text in text-muted, truncated to 1 line
  - For active steps with `startedAt`: show an elapsed timer in monospace font that counts up from startedAt using a 1-second setInterval
- Draw a connecting vertical line between steps (border-left on a wrapper div)
- Group steps into sections with subtle dividers:
  - Section 1 "戦略・コンテンツ": strategic_insight through jp_localization
  - Section 2 "アセット生成": image_generation through video_pipeline
- Keep the overall progress bar at the top (calculate percentage from completed/total steps)
- Keep the Realtime indicator dot at the bottom
- All text in Japanese, zero English visible

**v1.0 Fallback (when `progress.agentSteps` is undefined):**
- Preserve current flat step rendering for backward compatibility

**Styling notes:**
- Steel-blue accent (#6B8FA3) for section headers to match the strategy accordion design language
- Use existing Tailwind classes from the project's design system
- Smooth transitions when steps change status (use CSS transition on background/opacity)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Component renders without errors when agentSteps is provided
    - Component falls back to v1.0 display when agentSteps is undefined
    - All visible text is in Japanese
  </verify>
  <done>
    - v1.1 pipeline shows per-agent vertical timeline with Japanese labels, status icons, and completion summaries
    - Active steps show elapsed time counter
    - v1.0 pipeline still shows flat step indicators
    - Progress bar calculates from agent step completion count
  </done>
</task>

<task type="auto">
  <name>Task 3: Create n8n Master Orchestrator workflow via MCP</name>
  <files>
    (n8n workflow -- created via n8n MCP tools)
  </files>
  <action>
Create the Master Orchestrator workflow in n8n using the n8n MCP `n8n_create_workflow` tool. This is the central pipeline workflow that receives the campaign brief webhook and dispatches to agent sub-workflows.

**Workflow structure:**

1. **Webhook node** (trigger):
   - Method: POST
   - Path: `/campaign-pipeline`
   - Response mode: "Using 'Respond to Webhook' Node" (so the pipeline runs asynchronously)
   - This webhook URL must match what Next.js sends to via N8N_WEBHOOK_URL

2. **Respond to Webhook node** (immediately after webhook):
   - Status: 200
   - Body: `{ "received": true, "campaignId": "{{ $json.body.campaignId }}" }`
   - This unblocks the Next.js POST immediately

3. **HMAC Verification** (Code node):
   - Verify X-Signature header against body using N8N_WEBHOOK_SECRET env var
   - If invalid: stop execution (throw error)

4. **Initialize PipelineState** (Code node):
   - Extract campaignId, brief, brandProfile, agentConfig, mode from webhook body
   - Build initial PipelineState object: version "v1.1", status "running", empty agentErrors, startedAt
   - Return as JSON for downstream nodes

5. **Progress Callback Helper** (Code node — reusable via set node pattern):
   - Build callback payload with HMAC signature
   - POST to the Next.js callback URL (use environment variable `NEXTJS_CALLBACK_URL`)
   - This pattern: set variables for milestoneUpdate/agentStepUpdate/costEntries, then call this helper

6. **Sequential Execute Sub-workflow placeholder nodes** (one per agent):
   - "Strategic Insight Agent" — waitForSubWorkflow: true
   - "Quality Gate" (Code node) — validates strategicInsight output
   - "Creative Director Agent" — waitForSubWorkflow: true
   - "Copywriter Agent" and "Art Director Agent" — PARALLEL BRANCH (n8n branch then merge)
   - "JP Localization Agent" — waitForSubWorkflow: true (after Copywriter output available)
   - Between each: a progress callback HTTP Request node

7. **Error handling:** Each Execute Sub-workflow node should have "Continue On Fail" set appropriately:
   - Strategic Insight, Creative Director: continue on fail = false (critical-stop)
   - Copywriter, Art Director, JP Localization: continue on fail = true (partial delivery)

8. **Final callback node:** HTTP Request POST to NEXTJS_CALLBACK_URL with status "success" and full pipelineState

NOTE: The Execute Sub-workflow nodes will reference placeholder workflow IDs initially. Plans 09-02 through 09-05 create the actual sub-workflows and update these references. For now, use Code nodes as stubs that pass through the PipelineState unchanged.

Record the created workflow ID in the plan summary for downstream plans to reference.
  </action>
  <verify>
    - Workflow created successfully via n8n MCP (returns workflow ID)
    - Workflow has webhook trigger node
    - Workflow has HMAC verification code node
    - Workflow has PipelineState initialization code node
    - Workflow validates with n8n_validate_workflow
  </verify>
  <done>
    - Master Orchestrator workflow exists in n8n with webhook trigger at /campaign-pipeline
    - PipelineState initialization, HMAC verification, and progress callback pattern are in place
    - Placeholder nodes exist for all 5 agent sub-workflows + generation sub-workflows
    - Workflow ID is recorded for downstream plans
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- AgentStep interface is exported from pipeline.ts
- CampaignProgress includes agentSteps
- Callback handler merges agentStep updates correctly
- Progress UI renders per-agent timeline for v1.1, falls back for v1.0
- n8n Master Orchestrator workflow exists and responds to webhook
</verification>

<success_criteria>
- The n8n master orchestrator workflow exists with webhook trigger, HMAC verification, PipelineState initialization, and placeholder dispatch nodes
- Next.js callback handler processes agentStep updates and stores them in campaign progress
- Dashboard progress UI shows per-agent vertical timeline with Japanese labels and completion summaries
- All pipeline types are updated with AgentStep and extended callback payload
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md`
</output>
