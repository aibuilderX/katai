---
phase: 09-core-agent-pipeline-generation-execution
plan: 04
type: execute
wave: 4
depends_on: ["09-03"]
files_modified:
  - src/app/api/internal/composite/route.ts
  - src/app/api/internal/resize/route.ts
  - src/app/api/internal/generate-images/route.ts
  - (n8n workflows via MCP)
autonomous: true
requirements: [GENX-01, GENX-02, GENX-06]

must_haves:
  truths:
    - "Flux image generation n8n sub-workflow calls fal.ai to generate images from Art Director prompts"
    - "Internal API endpoints for compositing and resize are secured with HMAC or internal API key"
    - "JP text compositing runs on generated images via internal API endpoint"
    - "Platform resize produces dimension-specific images for all selected platforms"
  artifacts:
    - path: "src/app/api/internal/generate-images/route.ts"
      provides: "Flux image generation endpoint callable from n8n"
      exports: ["POST"]
    - path: "src/app/api/internal/composite/route.ts"
      provides: "JP text compositing endpoint callable from n8n"
      exports: ["POST"]
    - path: "src/app/api/internal/resize/route.ts"
      provides: "Platform resize endpoint callable from n8n"
      exports: ["POST"]
  key_links:
    - from: "(n8n) Image Generation sub-workflow"
      to: "src/app/api/internal/generate-images/route.ts"
      via: "HTTP Request with HMAC"
      pattern: "generateCampaignImages"
    - from: "(n8n) Compositing sub-workflow"
      to: "src/app/api/internal/composite/route.ts"
      via: "HTTP Request with HMAC"
      pattern: "compositeCampaignImages"
    - from: "(n8n) Resize sub-workflow"
      to: "src/app/api/internal/resize/route.ts"
      via: "HTTP Request with HMAC"
      pattern: "resizeForPlatforms"
---

<objective>
Build internal Next.js API endpoints for image generation, compositing, and resize, plus the n8n sub-workflows that call them. This uses the existing battle-tested TypeScript modules rather than reimplementing in n8n.

Purpose: The generation pipeline transforms Art Director prompts into platform-ready composited images. By exposing the existing Flux, compositing, and resize modules as internal API endpoints, n8n sub-workflows can call them with full circuit breaker protection and tested code paths.

Output: 3 internal API endpoints + 3 n8n generation sub-workflows, all wired into the Master Orchestrator after the agent phase.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai/flux.ts
@src/lib/compositing/index.ts
@src/lib/platforms/image-resizer.ts
@src/lib/ai/provider-health.ts
@src/types/pipeline.ts
@.planning/phases/09-core-agent-pipeline-generation-execution/09-01-SUMMARY.md
@.planning/phases/09-core-agent-pipeline-generation-execution/09-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create internal API endpoints for image generation, compositing, and resize</name>
  <files>
    src/app/api/internal/generate-images/route.ts
    src/app/api/internal/composite/route.ts
    src/app/api/internal/resize/route.ts
  </files>
  <action>
Create 3 internal API endpoints that wrap existing TypeScript modules. These endpoints are called by n8n sub-workflows, NOT by the dashboard directly.

**Security:** All internal endpoints verify HMAC signature using the same N8N_WEBHOOK_SECRET as the callback handler. Reuse the `verifySignature` function pattern from `src/app/api/webhooks/n8n/route.ts`.

**A. Image Generation Endpoint** (`src/app/api/internal/generate-images/route.ts`):

```typescript
export const maxDuration = 300  // Flux can take a while

export async function POST(request: Request) {
  // 1. Verify HMAC signature
  // 2. Parse body: { campaignId, imagePrompts: ArtDirectorOutput["imagePrompts"], brandProfile }
  // 3. For each imagePrompt:
  //    - Call generateCampaignImages() from src/lib/ai/flux.ts
  //    - Pass the Art Director's prompt string and aspect ratio
  //    - The existing function handles fal.ai queue pattern (submit -> poll -> retrieve)
  // 4. Insert image assets into DB (assets table, type: "image")
  // 5. Return { imageUrls: string[], assetIds: string[] }
}
```

Use the existing `generateCampaignImages()` function. The Art Director prompts are already Flux-compatible (English, no text, no negative prompts). Pass them through to fal.ai.

The existing circuit breaker (`providerHealth` from provider-health.ts) is used automatically by `generateCampaignImages()`.

**B. Compositing Endpoint** (`src/app/api/internal/composite/route.ts`):

```typescript
export const maxDuration = 120

export async function POST(request: Request) {
  // 1. Verify HMAC signature
  // 2. Parse body: { campaignId, imageAssets: { assetId, url, width, height }[], copyVariant: { headline, bodyText, ctaText }, brandProfile: { fontPreference, colors, logoUrl } }
  // 3. Call compositeCampaignImages() from src/lib/compositing/index.ts
  // 4. Return { compositedAssetIds: string[] }
}
```

Use the existing `compositeCampaignImages()` function which handles Sharp + node-canvas + BudouX text overlay.

**C. Resize Endpoint** (`src/app/api/internal/resize/route.ts`):

```typescript
export const maxDuration = 120

export async function POST(request: Request) {
  // 1. Verify HMAC signature
  // 2. Parse body: { campaignId, platforms: string[], sourceAssets: { id, storageKey, width, height }[] }
  // 3. Call resizeForPlatforms() from src/lib/platforms/image-resizer.ts
  // 4. Upload resized images to Supabase Storage
  // 5. Insert platform_image assets into DB
  // 6. Return { platformAssetIds: string[] }
}
```

Use the existing `resizeForPlatforms()` and `getResizeTargetsForPlatforms()` functions.

**All endpoints:**
- Return 401 for missing/invalid signature
- Return 200 with JSON result on success
- Return 500 with error message on failure
- Log errors to console for debugging
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 3 endpoint files exist and export POST handlers
    - Each endpoint verifies HMAC signature
    - Each endpoint calls the correct existing function
  </verify>
  <done>
    - Internal generate-images endpoint wraps generateCampaignImages with HMAC security
    - Internal composite endpoint wraps compositeCampaignImages with HMAC security
    - Internal resize endpoint wraps resizeForPlatforms with HMAC security
    - All endpoints handle errors gracefully (non-fatal, return error response)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create image generation, compositing, and resize n8n sub-workflows</name>
  <files>
    (n8n workflows via MCP)
  </files>
  <action>
Create 3 n8n sub-workflows for the generation pipeline. Each calls the internal Next.js API endpoints created in Task 1.

**A. Image Generation Sub-workflow:**

1. **Execute Workflow Trigger** — receives PipelineState with artDirector.imagePrompts

2. **Send Progress: Active** — agentStep: { agentName: "image_generation", labelJa: "画像生成中", status: "active" }

3. **Build Request** (Code node):
   - Extract imagePrompts from pipelineState.artDirector
   - Extract campaignId, brandProfile from pipelineState
   - Build request body for the internal generate-images endpoint
   - Sign with HMAC

4. **Call Internal API** (HTTP Request node):
   - POST to `${NEXTJS_BASE_URL}/api/internal/generate-images`
   - Include X-Signature header
   - Timeout: 300 seconds (image generation takes time)

5. **Parse Response** — extract imageUrls and assetIds

6. **Send Progress Callback** — include imageUrls in callback to Next.js so the existing callback handler processes them

7. **Send Cost Entry** — log Flux generation cost (from fal.ai pricing: ~$0.06/image = ~9 yen/image)

8. **Send Progress: Complete** — agentStep with summaryJa (e.g., "画像4枚生成完了")

9. **Return Updated PipelineState** with image generation results

**B. Compositing Sub-workflow:**

1. **Execute Workflow Trigger** — receives PipelineState + imageAssets from previous step

2. **Send Progress: Active** — agentStep: { agentName: "compositing", labelJa: "テキスト合成中", status: "active" }

3. **Build Request** — extract imageAssets, first copy variant (A案), brandProfile

4. **Call Internal API** — POST to `${NEXTJS_BASE_URL}/api/internal/composite`, timeout 120s

5. **Parse Response** — extract compositedAssetIds

6. **Send Progress: Complete** — agentStep

7. **Return** with composited asset info

**C. Resize Sub-workflow:**

1. **Execute Workflow Trigger** — receives PipelineState + composited assets

2. **Send Progress: Active** — agentStep: { agentName: "platform_resize", labelJa: "リサイズ中", status: "active" }

3. **Build Request** — extract platforms from brief, source assets from compositing output

4. **Call Internal API** — POST to `${NEXTJS_BASE_URL}/api/internal/resize`, timeout 120s

5. **Parse Response** — extract platformAssetIds

6. **Send Progress: Complete** — agentStep

7. **Return** with resized asset info

**Wire into Master Orchestrator:**
- After JP Localization: progress callback (content milestone complete, assets milestone active)
- Execute Sub-workflow: Image Generation (wait for completion)
- Execute Sub-workflow: Compositing (wait for completion)
- Execute Sub-workflow: Resize (wait for completion)
- All three have Continue On Fail = true (non-fatal — composited images still available without resize, base images still available without compositing)
  </action>
  <verify>
    - All 3 sub-workflows created in n8n
    - Each calls the correct internal API endpoint
    - Each sends progress callbacks (active/complete)
    - Master Orchestrator chains: Image Gen -> Compositing -> Resize after agents
    - All have Continue On Fail = true
  </verify>
  <done>
    - Image generation sub-workflow calls fal.ai via internal endpoint
    - Compositing sub-workflow overlays Japanese text via internal endpoint
    - Resize sub-workflow produces platform-specific images via internal endpoint
    - All wired into Master Orchestrator after JP Localization
    - Non-fatal failures: pipeline delivers whatever assets succeeded
  </done>
</task>

</tasks>

<verification>
- All 3 internal API endpoints exist and are HMAC-protected
- `npx tsc --noEmit` passes
- All 3 n8n sub-workflows exist and validate
- Master Orchestrator chains agents -> image gen -> compositing -> resize
- Circuit breaker is active for Flux generation (used automatically via existing code)
</verification>

<success_criteria>
- Art Director prompts are sent to Flux via fal.ai and images are generated
- Generated images have Japanese text composited onto them
- Composited images are resized to all selected platform dimensions
- All generation steps are non-fatal (partial delivery on failure)
- Progress callbacks report each generation step
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-agent-pipeline-generation-execution/09-04-SUMMARY.md`
</output>
