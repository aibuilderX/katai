---
phase: 05-workflow-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/workflows/approval.ts
  - src/app/api/campaigns/[id]/approve/route.ts
  - src/components/campaign/approval-panel.tsx
  - src/components/campaign/approval-status-badge.tsx
  - src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
  - src/app/(dashboard)/campaigns/[id]/page.tsx
  - src/app/(dashboard)/campaigns/page.tsx
autonomous: true

must_haves:
  truths:
    - "Editor (creator) can submit a completed campaign for review"
    - "Admin (reviewer/approver) can approve, reject, or request revision on a submitted campaign"
    - "Approval status transitions follow valid paths only (draft->pending_review->pending_approval->approved)"
    - "Approval history records all actions with actor, timestamp, and comment"
    - "Campaign list shows approval status badges"
  artifacts:
    - path: "src/lib/workflows/approval.ts"
      provides: "Approval state machine with valid transitions, role-based action validation"
      exports: ["canTransition", "validateApprovalAction", "VALID_TRANSITIONS", "ApprovalStatus"]
    - path: "src/app/api/campaigns/[id]/approve/route.ts"
      provides: "POST endpoint for approval workflow actions with optimistic locking"
      exports: ["POST"]
    - path: "src/components/campaign/approval-panel.tsx"
      provides: "Approval workflow UI with status display, action buttons, comment input, history timeline"
    - path: "src/components/campaign/approval-status-badge.tsx"
      provides: "Colored badge component showing approval status"
  key_links:
    - from: "src/app/api/campaigns/[id]/approve/route.ts"
      to: "src/lib/workflows/approval.ts"
      via: "import validateApprovalAction for transition validation"
      pattern: "import.*validateApprovalAction.*from.*approval"
    - from: "src/app/api/campaigns/[id]/approve/route.ts"
      to: "src/lib/db/schema.ts"
      via: "approvalWorkflows and approvalHistory table operations"
      pattern: "approvalWorkflows|approvalHistory"
    - from: "src/components/campaign/approval-panel.tsx"
      to: "/api/campaigns/[id]/approve"
      via: "fetch POST for approval actions"
      pattern: "fetch.*approve"
    - from: "src/app/(dashboard)/campaigns/page.tsx"
      to: "src/components/campaign/approval-status-badge.tsx"
      via: "render badge in campaign list"
      pattern: "ApprovalStatusBadge"
---

<objective>
Implement ringi-style approval workflow (WORK-06) with database-driven state machine, role-based actions, and full UI integration.

Purpose: Japanese agencies use formal ringi approval chains (creator -> reviewer -> approver). This plan adds that workflow to campaigns so teams can route generated content through structured review before client delivery. The approval state machine uses simple DB status + transition validation (no XState -- research confirmed a linear 3-step flow does not warrant a state machine library).

Output: Approval state machine logic, approval API with optimistic locking, approval panel UI with action buttons and history timeline, approval status badges on campaign list.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-workflow-intelligence/05-RESEARCH.md
@.planning/phases/05-workflow-intelligence/05-01-SUMMARY.md
@src/lib/db/schema.ts
@src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
@src/app/(dashboard)/campaigns/[id]/page.tsx
@src/app/(dashboard)/campaigns/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create approval state machine and API endpoint</name>
  <files>
    src/lib/workflows/approval.ts
    src/app/api/campaigns/[id]/approve/route.ts
  </files>
  <action>
1. **Create `src/lib/workflows/approval.ts`** -- Approval state machine (NO XState, simple DB-driven):

   a. Export `ApprovalStatus` type: `"draft" | "pending_review" | "pending_approval" | "approved" | "rejected" | "revision_requested"`

   b. Export `ApprovalAction` type: `"submit" | "approve" | "reject" | "request_revision"`

   c. Export `VALID_TRANSITIONS` map:
   ```
   draft -> [pending_review]
   pending_review -> [pending_approval, revision_requested, rejected]
   pending_approval -> [approved, revision_requested, rejected]
   approved -> []  (terminal)
   rejected -> [draft]  (can restart)
   revision_requested -> [draft]  (creator revises, resubmits)
   ```

   d. Export `canTransition(from, to): boolean` -- checks VALID_TRANSITIONS

   e. Export `validateApprovalAction(currentStatus, action, userRole)`:
   - Returns `{ allowed: boolean, nextStatus: ApprovalStatus, error?: string }`
   - Role mapping (from existing teamMembers.role):
     - `editor` = creator (tantousha): can "submit" (draft -> pending_review), can "submit" (revision_requested -> draft, then draft -> pending_review as two-step)
     - `admin` = reviewer + approver (kakarichou/buchou): can "approve" (pending_review -> pending_approval OR pending_approval -> approved), can "reject", can "request_revision"
     - `viewer` = observer: cannot take any action
   - Action-to-status mapping:
     - submit: draft -> pending_review
     - approve: pending_review -> pending_approval (reviewer approves), pending_approval -> approved (final approver)
     - reject: pending_review -> rejected, pending_approval -> rejected
     - request_revision: pending_review -> revision_requested, pending_approval -> revision_requested

   f. Export `APPROVAL_STATUS_LABELS: Record<ApprovalStatus, { labelJa: string, color: string }>`:
   - draft: "下書き", gray
   - pending_review: "レビュー待ち", yellow
   - pending_approval: "承認待ち", orange
   - approved: "承認済み", green
   - rejected: "却下", red
   - revision_requested: "修正依頼", purple

2. **Create `src/app/api/campaigns/[id]/approve/route.ts`** -- POST endpoint with optimistic locking:
   - Auth check (createClient, getUser)
   - Parse body: `{ action: ApprovalAction, comment?: string }`
   - Fetch user's team membership to get role
   - Fetch or create approval workflow for this campaign:
     - If no workflow exists: create one with status "draft", return it
     - If workflow exists: proceed with action
   - Call `validateApprovalAction(workflow.status, action, userRole)`
   - If not allowed: return 403 with error message
   - **Optimistic locking**: UPDATE approval_workflows SET status = nextStatus, version = version + 1, [actor fields based on action] WHERE id = workflowId AND version = currentVersion
     - If UPDATE affects 0 rows: return 409 Conflict ("承認状態が変更されています。ページを更新してください。")
   - Insert into `approvalHistory`: workflowId, action, fromStatus, toStatus, actorId (user.id), comment
   - Also UPDATE campaigns SET approvalStatus = nextStatus (denormalized field for quick list queries)
   - Return 200 with updated workflow and history
  </action>
  <verify>
  Run `pnpm build` -- must compile with no TypeScript errors. Verify:
  - approval.ts exports ApprovalStatus, ApprovalAction, VALID_TRANSITIONS, canTransition, validateApprovalAction, APPROVAL_STATUS_LABELS
  - approve/route.ts exports POST handler
  - Optimistic locking WHERE clause includes version check
  </verify>
  <done>
  Approval state machine validates transitions between 6 states based on user role. API endpoint creates/updates approval workflows with optimistic locking to prevent race conditions. All approval actions are recorded in approval_history with actor, comment, and timestamps. Campaign's denormalized approvalStatus is updated for efficient list queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create approval UI components and integrate into campaign pages</name>
  <files>
    src/components/campaign/approval-status-badge.tsx
    src/components/campaign/approval-panel.tsx
    src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
    src/app/(dashboard)/campaigns/[id]/page.tsx
    src/app/(dashboard)/campaigns/page.tsx
  </files>
  <action>
1. **Create `src/components/campaign/approval-status-badge.tsx`** -- Small colored badge:
   - Props: `status: string` (approval status or "none")
   - Import `APPROVAL_STATUS_LABELS` from `@/lib/workflows/approval`
   - If status is "none" or undefined: render nothing (return null)
   - Otherwise: render a small pill badge with the Japanese label and appropriate background color
   - Colors: use Tailwind classes mapped from the label colors (gray -> bg-bg-hover, yellow -> bg-[#FBBF241A] text-warning, green -> bg-[#4ADE801A] text-success, red -> bg-[#EF44441A] text-error, orange -> bg-vermillion-subtle text-vermillion, purple -> bg-[#A855F71A] text-[#A855F7])

2. **Create `src/components/campaign/approval-panel.tsx`** -- Full approval workflow UI:
   - Props: `campaignId: string, currentStatus: string, userRole: string` (role fetched from page server component)
   - State: `workflow` (fetched on mount), `history` (array), `isLoading`, `comment` (text input)
   - On mount: GET workflow status (add a GET handler to approve/route.ts, or fetch inline from campaign data passed as props). For simplicity, pass the approval data as props from the server component.
   - Actually, simpler approach: Props include `approvalStatus: string`. The panel shows current status and available actions.
   - Use `validateApprovalAction` logic client-side to determine which buttons to show (import the function -- it's pure logic, no DB):
     - Editor sees "提出" (submit) button when status is draft
     - Admin sees "承認" (approve), "却下" (reject), "修正依頼" (request revision) buttons when status is pending_review or pending_approval
     - Viewer sees no action buttons
   - Comment textarea (optional, placeholder "コメントを追加...")
   - Action buttons styled appropriately: approve = green, reject = red, request_revision = orange, submit = vermillion
   - On action: POST to `/api/campaigns/${campaignId}/approve` with `{ action, comment }`
   - On success: update local state, show toast
   - On 409 (conflict): show toast warning and refresh page
   - History timeline: display approval history entries chronologically with actor name, action label, comment, timestamp
   - For history: add a GET handler to the approve route that returns the workflow + history, or pass from server component

3. **Modify `src/app/(dashboard)/campaigns/[id]/page.tsx`** -- Pass approval data to client component:
   - Fetch the approval workflow for this campaign (if exists) from DB
   - Fetch the user's team role
   - Pass `approvalStatus`, `userRole`, and `approvalHistory` to CampaignDetailContent as new props

4. **Modify `src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx`** -- Add approval panel:
   - Add new props: `approvalStatus?: string`, `userRole?: string`, `approvalHistory?: Array<{action: string, actorName: string, comment: string | null, createdAt: string}>`
   - Render `<ApprovalPanel>` in the sidebar area, below the download button and above the QA panel (from Plan 02)
   - Show only when campaign status is "complete" or "partial"
   - Also add `<ApprovalStatusBadge status={approvalStatus} />` next to the campaign status badge in the header

5. **Modify `src/app/(dashboard)/campaigns/page.tsx`** -- Show approval badges in campaign list:
   - Extend the campaign list query to include `approvalStatus` from the campaigns table
   - Render `<ApprovalStatusBadge>` next to each campaign's existing status badge in the list
  </action>
  <verify>
  Run `pnpm build` -- must compile with no TypeScript errors. Verify:
  - approval-status-badge.tsx renders colored pill for each status
  - approval-panel.tsx renders action buttons based on role and status
  - campaign-detail-content.tsx has ApprovalPanel and ApprovalStatusBadge
  - campaigns/page.tsx shows approval badges in list
  - page.tsx passes approval data to client component
  </verify>
  <done>
  Approval panel shows in campaign sidebar with role-appropriate action buttons. Editors can submit campaigns for review. Admins can approve, reject, or request revision with optional comments. Approval status badges appear on campaign list page. History timeline shows all approval actions. Optimistic locking prevents concurrent approval conflicts.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. Approval state machine validates all 6 states and their valid transitions
3. Role-based action buttons appear correctly (editor vs admin vs viewer)
4. Optimistic locking returns 409 on version conflict
5. Approval history timeline displays chronologically
6. Campaign list shows approval status badges
</verification>

<success_criteria>
- Editor can submit a completed campaign for review (draft -> pending_review)
- Admin can approve through two stages (pending_review -> pending_approval -> approved)
- Admin can reject or request revision at any review stage
- Rejected campaigns can be restarted by editor
- All actions recorded in approval_history with actor, timestamp, and comment
- Campaign list page shows approval status alongside generation status
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-workflow-intelligence/05-03-SUMMARY.md`
</output>
