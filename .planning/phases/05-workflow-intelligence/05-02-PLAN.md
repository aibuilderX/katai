---
phase: 05-workflow-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/templates/jp-campaign-templates.ts
  - src/components/brief/template-picker.tsx
  - src/app/(dashboard)/campaigns/new/page.tsx
  - src/app/api/campaigns/[id]/clone/route.ts
  - src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
  - src/lib/ai/qa-agent.ts
  - src/lib/ai/trend-agent.ts
  - src/lib/ai/prompts/qa-validation.ts
  - src/lib/ai/prompts/trend-analysis.ts
  - src/app/api/campaigns/[id]/qa/route.ts
  - src/components/campaign/qa-report-panel.tsx
  - src/components/campaign/trend-insights-card.tsx
autonomous: true

must_haves:
  truths:
    - "User can select a pre-built template (seasonal, flash sale, new product, brand awareness) that pre-fills the brief form"
    - "User can clone a completed campaign and modify the brief before re-running"
    - "QA agent validates generated copy for keigo consistency and brand compliance, producing a structured report"
    - "Trend agent provides Japanese market trend insights for creative direction"
  artifacts:
    - path: "src/lib/templates/jp-campaign-templates.ts"
      provides: "4 typed campaign templates with pre-filled brief defaults"
      exports: ["JP_CAMPAIGN_TEMPLATES", "CampaignTemplate"]
    - path: "src/components/brief/template-picker.tsx"
      provides: "Template selection cards shown before brief form"
    - path: "src/app/api/campaigns/[id]/clone/route.ts"
      provides: "POST endpoint to clone campaign brief for re-run"
      exports: ["POST"]
    - path: "src/lib/ai/qa-agent.ts"
      provides: "QA validation via Claude with structured tool output"
      exports: ["runQAValidation"]
    - path: "src/lib/ai/trend-agent.ts"
      provides: "Trend analysis via Claude synthesis"
      exports: ["analyzeTrends"]
    - path: "src/app/api/campaigns/[id]/qa/route.ts"
      provides: "POST endpoint to trigger QA validation"
      exports: ["POST"]
    - path: "src/components/campaign/qa-report-panel.tsx"
      provides: "QA report display with score, keigo issues, brand compliance"
    - path: "src/components/campaign/trend-insights-card.tsx"
      provides: "Trend insights sidebar card"
  key_links:
    - from: "src/components/brief/template-picker.tsx"
      to: "src/lib/templates/jp-campaign-templates.ts"
      via: "import JP_CAMPAIGN_TEMPLATES"
      pattern: "import.*JP_CAMPAIGN_TEMPLATES"
    - from: "src/app/api/campaigns/[id]/clone/route.ts"
      to: "src/lib/db/schema.ts"
      via: "campaigns table query with parentCampaignId"
      pattern: "parentCampaignId"
    - from: "src/lib/ai/qa-agent.ts"
      to: "@anthropic-ai/sdk"
      via: "Claude API with tool_choice forced"
      pattern: "tool_choice.*tool.*deliver_qa_report"
    - from: "src/components/campaign/qa-report-panel.tsx"
      to: "/api/campaigns/[id]/qa"
      via: "fetch POST to trigger QA validation"
      pattern: "fetch.*qa"
---

<objective>
Implement brief templates (WORK-09), campaign history/re-run (FOUND-05), QA agent (INTEL-03), and Trend agent (INTEL-04).

Purpose: Templates accelerate brief creation for common JP campaign types. Campaign cloning enables iterative improvement. QA agent catches keigo and brand compliance issues before delivery. Trend agent provides market-aware creative direction.

Output: 4 pre-built templates with picker UI, campaign clone API, QA validation agent with report UI, trend analysis agent with insights card.
</objective>

<execution_context>
@/Users/hani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-workflow-intelligence/05-RESEARCH.md
@.planning/phases/05-workflow-intelligence/05-01-SUMMARY.md
@src/lib/db/schema.ts
@src/app/(dashboard)/campaigns/new/page.tsx
@src/components/brief/brief-form.tsx
@src/lib/ai/claude.ts
@src/lib/ai/prompts/copy-generation.ts
@src/lib/constants/keigo.ts
@src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create brief templates and campaign clone/history</name>
  <files>
    src/lib/templates/jp-campaign-templates.ts
    src/components/brief/template-picker.tsx
    src/app/(dashboard)/campaigns/new/page.tsx
    src/app/api/campaigns/[id]/clone/route.ts
    src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
  </files>
  <action>
1. **Create `src/lib/templates/jp-campaign-templates.ts`** -- Typed template constants (NOT database):

   Export `CampaignTemplate` interface:
   ```
   id: string
   nameJa: string
   descriptionJa: string
   category: "seasonal" | "promotion" | "product_launch" | "brand_awareness"
   icon: string  // lucide icon name
   defaults: {
     objective: string
     targetAudience: string
     platforms: string[]
     creativeMoodTags: string[]
     creativeDirection: string
     registerOverride?: string
   }
   ```

   Export `JP_CAMPAIGN_TEMPLATES: CampaignTemplate[]` with 4 templates:
   - **seasonal_launch** ("季節キャンペーン"): awareness, 20-40 general consumers, instagram/x/line, seasonal/trend/limited mood, bright seasonal visuals
   - **flash_sale** ("タイムセール"): conversion, price-sensitive buyers, line/x/yahoo/rakuten, urgent/deal/limited mood, red/orange urgency visuals, registerOverride "casual"
   - **new_product** ("新商品発売"): awareness+conversion, 25-45 early adopters, instagram/x/tiktok/line, new/innovative/premium mood, clean product-focused visuals
   - **brand_awareness** ("ブランド認知"): awareness, broad 20-50 demographic, instagram/x/youtube, sophisticated/trust/quality mood, brand-story cinematic visuals, registerOverride "formal"

2. **Create `src/components/brief/template-picker.tsx`** -- Template selection UI:
   - Import `JP_CAMPAIGN_TEMPLATES` from templates file
   - Render 4 template cards in a 2x2 grid (lg:grid-cols-4 for wide screens)
   - Each card: icon (from lucide-react, map string name to component), nameJa (bold), descriptionJa (muted), category badge
   - Plus a 5th "blank" card option ("白紙から作成" / "Start from scratch") with a Plus icon
   - Props: `onSelect: (template: CampaignTemplate | null) => void` -- null means blank
   - Use hover:border-vermillion and ring-vermillion-subtle for selected state

3. **Modify `src/app/(dashboard)/campaigns/new/page.tsx`** -- Add template selection step before brief form:
   - Add state: `selectedTemplate: CampaignTemplate | null`
   - Add state: `showForm: boolean` (initially false)
   - When `!showForm`: render `<TemplatePicker onSelect={...} />`
   - When template selected (or blank chosen): set `showForm = true`, pass template defaults to BriefForm as `initialValues` prop
   - The BriefForm already accepts field values -- check if it needs an `initialValues` prop added. If the form uses `useState` with initial values, pass template defaults as initial state.
   - Add a "テンプレートを変更" (Change template) link above the form to go back to template picker

4. **Create `src/app/api/campaigns/[id]/clone/route.ts`** -- POST endpoint for campaign re-run:
   - Auth check (same pattern as other campaign routes)
   - Fetch parent campaign by ID from DB
   - Verify user belongs to the same team
   - Return 200 with `{ brief: parentCampaign.brief, parentCampaignId: parentCampaign.id, name: parentCampaign.name }` -- the client will use this to pre-fill the brief form
   - The actual new campaign creation happens through the existing POST /api/campaigns when user submits the modified brief (adding `parentCampaignId` to the submission body)

5. **Modify `src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx`** -- Add "Clone & Re-run" button:
   - Add a button next to the existing "再生成" link in the campaign header actions area
   - Label: "複製して再実行" with a Copy icon (lucide-react)
   - On click: `router.push(\`/campaigns/new?clone=${campaign.id}\`)` -- the new page will detect the clone query param and fetch the brief via the clone API
  </action>
  <verify>
  Run `pnpm build` -- must compile with no TypeScript errors. Verify:
  - jp-campaign-templates.ts exports JP_CAMPAIGN_TEMPLATES with exactly 4 templates
  - template-picker.tsx renders without errors
  - campaigns/new/page.tsx shows template picker before form
  - clone/route.ts exports POST handler
  - campaign-detail-content.tsx has the clone button
  </verify>
  <done>
  User can select from 4 pre-built templates (seasonal, flash sale, new product, brand awareness) or start blank when creating a new campaign. Template defaults pre-fill the brief form. User can click "Clone & Re-run" on a completed campaign to copy its brief into a new campaign form. Clone API returns the parent brief data with parentCampaignId for linking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create QA validation agent and Trend analysis agent</name>
  <files>
    src/lib/ai/qa-agent.ts
    src/lib/ai/trend-agent.ts
    src/lib/ai/prompts/qa-validation.ts
    src/lib/ai/prompts/trend-analysis.ts
    src/app/api/campaigns/[id]/qa/route.ts
    src/components/campaign/qa-report-panel.tsx
    src/components/campaign/trend-insights-card.tsx
    src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx
  </files>
  <action>
1. **Create `src/lib/ai/prompts/qa-validation.ts`** -- QA agent prompt templates:
   - Export `QA_SYSTEM_PROMPT`: Japanese system prompt telling Claude it is a QA validation agent for Japanese advertising copy. Must check: keigo consistency (register matches brand setting), brand voice compliance (tone matches brand tags), copy quality (no truncation artifacts, proper character usage)
   - Include keigo register definitions from `@/lib/constants/keigo.ts`: casual = plain form (da/desu), standard = teineigo (desu/masu), formal = sonkeigo+kenjougo
   - Export `buildQAUserPrompt(brandProfile, copyVariants)`: returns user message with brand settings and all copy variants formatted for analysis
   - Temperature: 0 for deterministic validation (set in agent, not prompt)

2. **Create `src/lib/ai/qa-agent.ts`** -- QA validation agent:
   - Import Anthropic SDK (same pattern as claude.ts)
   - Define `QA_VALIDATION_TOOL: Anthropic.Tool` with `strict: true`:
     - name: "deliver_qa_report"
     - input_schema with: overallScore (integer 0-100), keigoConsistency (object with passed boolean and issues array), brandCompliance (object with passed boolean and issues array)
     - Each issue: { field: string, issue: string, severity: "error" | "warning", suggestion: string }
   - Export `runQAValidation(campaignId: string)`:
     - Fetch campaign, brand profile, and all copy variants from DB
     - Call Claude with system prompt, user prompt, forced tool_choice `{ type: "tool", name: "deliver_qa_report" }`, temperature 0, model "claude-sonnet-4-5-20250514"
     - Extract tool use result from response
     - Insert result into `qaReports` table (campaignId, overallScore, keigoResult, brandResult)
     - Return the QA report
   - Note: Visual coherence (Claude Vision on images) is deferred per research recommendation. Text-based QA only for MVP.

3. **Create `src/lib/ai/prompts/trend-analysis.ts`** -- Trend agent prompt:
   - Export `TREND_SYSTEM_PROMPT`: Japanese system prompt telling Claude it is a Japanese market trend analyst. Synthesize relevant trends based on campaign objective, target audience, and current season.
   - Export `buildTrendUserPrompt(brief, brandProfile)`: includes campaign objective, audience, platforms, current date/season
   - No external API (SerpApi deferred per research). Claude synthesizes from training data.

4. **Create `src/lib/ai/trend-agent.ts`** -- Trend analysis agent:
   - Import Anthropic SDK
   - Define `TREND_INSIGHTS_TOOL: Anthropic.Tool` with `strict: true`:
     - name: "deliver_trend_insights"
     - input_schema: { trends: Array<{ title: string, relevance: string, suggestion: string }>, seasonalTags: string[], recommendedHashtags: string[] }
   - Export `analyzeTrends(brief, brandProfile)`:
     - Call Claude with system/user prompts, forced tool_choice, temperature 0.3 (slightly creative), model "claude-sonnet-4-5-20250514"
     - Return the structured trend insights (no DB persistence -- displayed on-demand)

5. **Create `src/app/api/campaigns/[id]/qa/route.ts`** -- POST endpoint:
   - Auth check
   - Call `runQAValidation(campaignId)`
   - Return 200 with the QA report
   - On error: return 500

6. **Create `src/components/campaign/qa-report-panel.tsx`** -- QA results display:
   - Props: `campaignId: string`
   - State: `qaReport` (null initially), `isLoading`, `hasRun`
   - "QA検証を実行" button triggers POST to `/api/campaigns/${campaignId}/qa`
   - On success: display overallScore as a circular score badge (green >=80, yellow 60-79, red <60)
   - List keigo issues with severity badges (error = red, warning = yellow)
   - List brand compliance issues similarly
   - If no issues: show green checkmark with "問題なし"

7. **Create `src/components/campaign/trend-insights-card.tsx`** -- Trend sidebar card:
   - Props: `campaignId: string, brief: CampaignBrief, brandName: string`
   - State: `insights` (null initially), `isLoading`
   - "トレンド分析" button triggers analysis (calls trend-agent directly via an API route, or inline fetch -- create a simple `/api/campaigns/[id]/trends/route.ts` if needed, or bundle into the qa route as a separate action)
   - For simplicity: create the trend endpoint inline as a GET handler in `/api/campaigns/[id]/qa/route.ts` that calls `analyzeTrends`
   - Display: trend titles as bold items, relevance as muted text, suggested hashtags as tags

8. **Modify `src/app/(dashboard)/campaigns/[id]/campaign-detail-content.tsx`** -- Integrate QA panel and trend card into the sidebar:
   - Add `<QAReportPanel campaignId={campaign.id} />` in the sidebar area (below CampaignSidebar), visible only when status is "complete" or "partial"
   - Add `<TrendInsightsCard campaignId={campaign.id} brief={campaign.brief} brandName={brand?.name || ""} />` in the sidebar, visible only when status is "complete" or "partial"
  </action>
  <verify>
  Run `pnpm build` -- must compile with no TypeScript errors. Verify:
  - qa-agent.ts exports runQAValidation
  - trend-agent.ts exports analyzeTrends
  - qa/route.ts exports POST (and optionally GET for trends)
  - qa-report-panel.tsx and trend-insights-card.tsx render without errors
  - campaign-detail-content.tsx imports and renders both new components
  </verify>
  <done>
  QA agent validates copy variants for keigo consistency and brand compliance via Claude with structured tool output, storing results in qaReports table. Trend agent synthesizes JP market trends via Claude (no external API). QA report panel shows score with issue breakdown. Trend card shows trend insights with recommended hashtags. Both components are accessible from the campaign detail sidebar.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. Template picker displays 4 templates + blank option on campaigns/new page
3. Clone API returns parent campaign brief data
4. QA validation tool schema matches expected structure
5. Trend agent returns structured insights
6. Sidebar shows QA panel and trend card for completed campaigns
</verification>

<success_criteria>
- User sees template picker when creating a new campaign, with 4 JP campaign type templates
- Selecting a template pre-fills the brief form with appropriate defaults
- User can clone a completed campaign to create a new one with modifications
- QA report shows keigo and brand compliance validation results with scores
- Trend card displays synthesized JP market trend insights
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-workflow-intelligence/05-02-SUMMARY.md`
</output>
